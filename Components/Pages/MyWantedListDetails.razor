@page "/mywantedlistdetails/{wantedListId:int}"
@using Data.Entities
@using Data.Services
@using Helpers

@inject WantedListService WantedListService
@inject Services.InventoryService InventoryService
@inject NavigationManager Nav
@inject Data.Services.ImageService ImageService
@inject Services.NotificationService NotificationService

  <MudButton Size="Size.Small" StartIcon="@Icons.Material.Filled.ArrowBack" Class="my-4" Variant="Variant.Outlined" OnClick="GoBack">
        Back
    </MudButton>

<PageTitle>Wanted List Details</PageTitle>

@if (_loading)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (_wantedList == null)
{
    <MudAlert Severity="Severity.Error">Wanted List not found.</MudAlert>
    <MudButton StartIcon="@Icons.Material.Filled.ArrowBack" OnClick="GoBack">Back</MudButton>
}
else
{
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Spacing="2" Style="margin-bottom: 16px;">
        <MudText Typo="Typo.h4" GutterBottom="true">My wanted list: @_wantedList.Name</MudText>

        <MudButton Variant="Variant.Outlined"
                   Color="Color.Error"
                   StartIcon="@Icons.Material.Filled.Delete"
                   OnClick="DeleteList"
                   Disabled="@_deletingList">
                    Delete this wanted list
        </MudButton>
    </MudStack>

   
    <OwnershipProgress OwnedCount="@TotalOwned" TotalCount="@TotalNeeded" />

    <MudText Typo="Typo.h6" GutterBottom="true">Items in this list</MudText>

    <style>
        .brick {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 56px;
            min-width: 56px;
            min-height: 56px;
            box-sizing: border-box;
        }

        .brick-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
            border: 2px solid #ccc;
            background: #fff;
            display: block;
        }

        .brick::after {
            content: "";
            position: absolute;
            right: .5px;
            bottom: 0px;
            width: 0;
            height: 0;
            border-bottom: 28px solid var(--brick-color, transparent);
            border-left: 28px solid transparent;
            border-radius: 0 0 4px 0;
            z-index: 2;
            pointer-events: none;
        }
    </style>

    <MudTable Items="(_wantedList.Items ?? Enumerable.Empty<WantedListItem>()).OrderBy(b => b.BrickColor?.Name)">
        <HeaderContent>
            <MudTh>Image</MudTh>
            <MudTh>Standard Name</MudTh>
            <MudTh>Color</MudTh>
            <MudTh>Lego</MudTh>
            <MudTh>BlueBrixx</MudTh>
            <MudTh>Cada</MudTh>
            <MudTh>Pantasy</MudTh>
            <MudTh>Mould King</MudTh>
            <MudTh>Unknown</MudTh>
            <MudTh>Quantity</MudTh>
            <MudTh>Do you have this in your inventory?</MudTh>
            <MudTh>Action</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd DataLabel="Image">
                @{
                    var imgUrl = context.MappedBrick != null
                        ? ImageService.GetMappedBrickImagePath(context.MappedBrick)
                        : null;
                    var overlay = BrickColorHelper.GetHexForColor(context.BrickColor?.Name);
                }
                @if (!string.IsNullOrWhiteSpace(imgUrl) && imgUrl != "/placeholder-image.png" && overlay != null)
                {
                    <div class="brick" style="--brick-color:@overlay">
                        <img src="@imgUrl" alt="" class="brick-img"
                             onerror="if(this.src!== '/placeholder-image.png'){this.src='/placeholder-image.png';this.style.opacity='0.5';}" />
                    </div>
                }
                else if (!string.IsNullOrWhiteSpace(imgUrl) && imgUrl != "/placeholder-image.png")
                {
                    <img src="@imgUrl" alt="" class="brick-img"
                         onerror="if(this.src!== '/placeholder-image.png'){this.src='/placeholder-image.png';this.style.opacity='0.5';}" />
                }
                else
                {
                    <span style="display:inline-block;width:48px;height:48px;line-height:48px;text-align:center;color:#bbb;font-size:0.8em;">No image</span>
                }
            </MudTd>

            <MudTd DataLabel="Standard Name">@context.MappedBrick?.Name</MudTd>
            <MudTd DataLabel="Color">@context.BrickColor?.Name</MudTd>

            <MudTd DataLabel="Lego">
                @context.MappedBrick?.LegoName
                @if (!string.IsNullOrEmpty(context.MappedBrick?.LegoPartNum))
                {
                    <span style="font-size: 0.9em; color: #999;"> (@context.MappedBrick.LegoPartNum)</span>
                }
            </MudTd>

            <MudTd DataLabel="BlueBrixx">
                @context.MappedBrick?.BluebrixxName
                @if (!string.IsNullOrEmpty(context.MappedBrick?.BluebrixxPartNum))
                {
                    <span style="font-size: 0.9em; color: #999;"> (@context.MappedBrick.BluebrixxPartNum)</span>
                }
            </MudTd>

            <MudTd DataLabel="Cada">
                @context.MappedBrick?.CadaName
                @if (!string.IsNullOrEmpty(context.MappedBrick?.CadaPartNum))
                {
                    <span style="font-size: 0.9em; color: #999;"> (@context.MappedBrick.CadaPartNum)</span>
                }
            </MudTd>

            <MudTd DataLabel="Pantasy">
                @context.MappedBrick?.PantasyName
                @if (!string.IsNullOrEmpty(context.MappedBrick?.PantasyPartNum))
                {
                    <span style="font-size: 0.9em; color: #999;"> (@context.MappedBrick.PantasyPartNum)</span>
                }
            </MudTd>

            <MudTd DataLabel="Mould King">
                @context.MappedBrick?.MouldKingName
                @if (!string.IsNullOrEmpty(context.MappedBrick?.MouldKingPartNum))
                {
                    <span style="font-size: 0.9em; color: #999;"> (@context.MappedBrick.MouldKingPartNum)</span>
                }
            </MudTd>

            <MudTd DataLabel="Unknown">
                @context.MappedBrick?.UnknownName
                @if (!string.IsNullOrEmpty(context.MappedBrick?.UnknownPartNum))
                {
                    <span style="font-size: 0.9em; color: #999;"> (@context.MappedBrick.UnknownPartNum)</span>
                }
            </MudTd>

            <MudTd DataLabel="Quantity">@context.Quantity</MudTd>

            <MudTd DataLabel="Do you own?">
                @{
                    var key = (context.MappedBrickId, context.BrickColorId);
                    if (_ownedByBrand.TryGetValue(key, out var brands) && brands.Count > 0)
                    {
                        foreach (var brand in brands)
                        {
                            <MudChip T="string" Color="Color.Primary" Class="mr-1 mb-1">@brand.Key: @brand.Value</MudChip>
                        }
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Default">None</MudChip>
                    }
                }
            </MudTd>

            <MudTd>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Error"
                           Size="Size.Small"
                           OnClick="@(() => DeleteItem(context.Id))">
                    Delete
                </MudButton>
            </MudTd>
        </RowTemplate>
    </MudTable>

    <MudButton StartIcon="@Icons.Material.Filled.ArrowBack" Class="mt-4" Variant="Variant.Outlined" OnClick="GoBack">
        Back
    </MudButton>
}

@code {
    [Parameter] public int wantedListId { get; set; }

    private WantedList? _wantedList;
    private bool _loading = true;
    private bool _deletingList = false;

    private Dictionary<(int, int), Dictionary<string, int>> _ownedByBrand = new();

    private async Task DeleteList()
    {
        if (_deletingList) return;

        _deletingList = true;
        try
        {
            var success = await WantedListService.DeleteWantedListAsync(wantedListId);
            if (success)
            {
                NotificationService.Success("Liste erfolgreich gelÃ¶scht");
                Nav.NavigateTo("/mywantedlists");
            }
            else
            {
                NotificationService.Error("Failed to delete wanted list.");
            }
        }
        finally
        {
            _deletingList = false;
            await InvokeAsync(StateHasChanged);
        }
    }

   private async Task DeleteItem(int wantedListItemId)
{
    try
    {
        var success = await WantedListService.DeleteWantedListItemAsync(wantedListItemId);
        if (success)
        {
            _wantedList = await WantedListService.GetWantedListByIdAsync(wantedListId);
            NotificationService.Success("Item deleted from wanted list.");
            StateHasChanged();
        }
        else
        {
            NotificationService.Error("Failed to delete item.");
        }
    }
    catch (Exception ex)
    {
        NotificationService.Error($"Delete failed: {ex.Message}");
    }
}

    protected override async Task OnInitializedAsync()
    {
        _loading = true;

        _wantedList = await WantedListService.GetWantedListByIdAsync(wantedListId);

        var inventory = await InventoryService.GetCurrentUserInventoryAsync();
        _ownedByBrand = inventory
            .GroupBy(i => (i.MappedBrickId, i.BrickColorId))
            .ToDictionary(
                g => g.Key,
                g => g.GroupBy(i => i.Brand)
                      .ToDictionary(bg => bg.Key, bg => bg.Sum(i => i.Quantity))
            );

        _loading = false;
    }

    protected int TotalNeeded => _wantedList?.Items?.Sum(b => b.Quantity) ?? 0;
    protected int TotalOwned => _wantedList?.Items?.Sum(b => Math.Min(GetOwnedQuantity(b), b.Quantity)) ?? 0;

    protected int Percent => (TotalNeeded > 0 && TotalOwned == TotalNeeded)
        ? 100
        : (TotalNeeded > 0 ? (int)Math.Floor(100.0 * (double)TotalOwned / TotalNeeded) : 0);

    protected bool HasAll => TotalNeeded > 0 && TotalOwned == TotalNeeded;

    private int GetOwnedQuantity(WantedListItem item)
    {
        return _ownedByBrand.TryGetValue((item.MappedBrickId, item.BrickColorId), out var brandDict)
            ? brandDict.Values.Sum()
            : 0;
    }

    private void GoBack()
    {
        Nav.NavigateTo("/mywantedlists");
    }
}
