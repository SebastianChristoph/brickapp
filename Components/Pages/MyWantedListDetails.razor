@page "/mywantedlistdetails/{wantedListId:int}"
@using Data.Entities
@using Data.Services
@using Helpers
@using MudBlazor

@inject WantedListService WantedListService
@inject Services.InventoryService InventoryService
@inject NavigationManager Nav
@inject Data.Services.ImageService ImageService
@inject Services.NotificationService NotificationService

<PageTitle>Wanted List Details</PageTitle>

@if (_loading)
{
    <MudStack Justify="Justify.Center" Spacing="2" Style="margin-bottom: 16px; margin-top:16px;">
        <MudText>Loading wanted list...</MudText>
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    </MudStack>
}
else if (_wantedList == null)
{
    <MudAlert Severity="Severity.Error">Wanted List not found.</MudAlert>
    <MudButton Variant="Variant.Outlined" OnClick="@GoBack">Back</MudButton>
}
else
{
    @* --- HEADER --- *@
    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Spacing="1">
                <MudText Typo="Typo.h4">@_wantedList.Name</MudText>
                <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Wanted List</MudText>
            </MudStack>

            <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.Delete"
                OnClick="DeleteList" Disabled="@_deletingList">
                Delete this wanted list
            </MudButton>
        </MudStack>
    </MudPaper>

    @* --- PROGRESS --- *@
    <MudStack Row="true" Spacing="2" StretchItems="StretchItems.Start" Class="mb-4">
        <OwnershipProgress OwnedCount="@TotalOwned" TotalCount="@TotalNeeded" />
    </MudStack>

    <br />

    <br />

    <MudText Typo="Typo.h6" GutterBottom="true">Items in this list</MudText>

    <style>
        .brick {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 56px;
            min-width: 56px;
            min-height: 56px;
            box-sizing: border-box;
        }

        .brick-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
            border: 2px solid #ccc;
            background: #fff;
            display: block;
        }

        .brick::after {
            content: "";
            position: absolute;
            right: .5px;
            bottom: 0px;
            width: 0;
            height: 0;
            border-bottom: 28px solid var(--brick-color, transparent);
            border-left: 28px solid transparent;
            border-radius: 0 0 4px 0;
            z-index: 2;
            pointer-events: none;
        }

        .brick-sm {
            width: 42px;
            height: 42px;
            min-width: 42px;
            min-height: 42px;
        }

        .brick-sm::after {
            border-bottom-width: 21px;
            border-left-width: 21px;
        }
    </style>

    <MudTable Items="(_wantedList.Items ?? Enumerable.Empty<WantedListItem>()).OrderBy(b => b.BrickColor?.Name)"
        Hover="true" Dense="true">
        <HeaderContent>
            <MudTh>Image</MudTh>
            <MudTh>Standard Name</MudTh>
            <MudTh>Color</MudTh>
            <MudTh>Lego</MudTh>
            <MudTh>BlueBrixx</MudTh>
            <MudTh>Quantity</MudTh>
            <MudTh>In Inventory?</MudTh>
            <MudTh>Action</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Image">
                @{
                    var overlay = BrickColorHelper.GetHexForColor(context.BrickColor?.Name) ?? "transparent";
                    var imgUrl = context.MappedBrick != null ? ImageService.GetMappedBrickImagePath(context.MappedBrick) :
                    ImageService.GetPlaceHolder();
                }
                <div class="brick" style="--brick-color:@overlay">
                    <img src="@imgUrl" alt="" class="brick-img"
                        onerror="if(this.src!== '/placeholder-image.png'){this.src='/placeholder-image.png';this.style.opacity='0.5';}" />
                </div>
            </MudTd>
            <MudTd DataLabel="Standard Name">@context.MappedBrick?.Name</MudTd>
            <MudTd DataLabel="Color">@context.BrickColor?.Name</MudTd>
            <MudTd DataLabel="Lego">@context.MappedBrick?.LegoName @(string.IsNullOrEmpty(context.MappedBrick?.LegoPartNum)
                            ? "" : $"({context.MappedBrick.LegoPartNum})")</MudTd>
            <MudTd DataLabel="BlueBrixx">@context.MappedBrick?.BluebrixxName
                @(string.IsNullOrEmpty(context.MappedBrick?.BluebrixxPartNum) ? "" :
                            $"({context.MappedBrick.BluebrixxPartNum})")</MudTd>
            <MudTd DataLabel="Quantity">@context.Quantity</MudTd>
            <MudTd DataLabel="In Inventory?">
                @{
                    var key = (context.MappedBrickId, context.BrickColorId);
                    if (_ownedByBrand.TryGetValue(key, out var brands) && brands.Count > 0)
                    {
                        foreach (var brand in brands)
                        {
                            <MudChip T="string" Color="Color.Primary" Class="mr-1 mb-1" Size="Size.Small">@brand.Key: @brand.Value
                            </MudChip>
                        }
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Default" Size="Size.Small">None</MudChip>
                    }
                }
            </MudTd>
            <MudTd>
                <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small"
                    OnClick="@(() => DeleteItem(context.Id))">Delete</MudButton>
            </MudTd>
        </RowTemplate>
    </MudTable>



    @if (MissingItems.Any())
    {
        <MudAlert Severity="Severity.Warning" Class="mt-8 mb-2" Variant="Variant.Filled">
            <b>@MissingItems.Count Teil(e)</b> konnten beim Import nicht automatisch zugeordnet werden.
        </MudAlert>
        <MudExpansionPanels>
            <MudExpansionPanel Text="Nicht zugeordnete Teile (Details)" Expanded="true">
                <MudTable Items="MissingItems" Dense="true" Hover="true" Elevation="0">
                    <HeaderContent>
                        <MudTh>Bild</MudTh>
                        <MudTh>Teilenummer</MudTh>
                        <MudTh>Farbe (Ext.)</MudTh>
                        <MudTh>Menge</MudTh>
                    </HeaderContent>
                  <RowTemplate>
    <MudTd DataLabel="Bild">
        @* Hier rufen wir deine neue Helper-Funktion auf *@
        @{
            var missingOverlay = GetMissingColorHex(context.ExternalColorId);
        }
        <div class="brick brick-sm" style="--brick-color: @missingOverlay">
            <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#f5f5f5; border: 1px solid #ccc; border-radius:4px;">
                <MudIcon Icon="@Icons.Material.Filled.QuestionMark" Size="Size.Small" Color="Color.Default" />
            </div>
        </div>
    </MudTd>
    <MudTd DataLabel="Teilenummer">
        <MudText Typo="Typo.body2" Style="font-family:monospace; font-weight:bold;">@context.ExternalPartNum</MudText>
    </MudTd>
    <MudTd DataLabel="Farbe (Ext. ID)">
        @{
            var colorId = context.ExternalColorId ?? 0;
            var colorName = Helpers.BricklinkColorMap.GetBrickColorName(colorId);
        }
        <MudStack Spacing="0">
            <MudText Typo="Typo.body2">@(colorName ?? "Unbekannt")</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @colorId</MudText>
        </MudStack>
    </MudTd>
    <MudTd DataLabel="Menge">
        <MudBadge Content="@context.Quantity" Color="Color.Warning" Overlap="false">
            <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Small" />
        </MudBadge>
    </MudTd>
</RowTemplate>
                </MudTable>
            </MudExpansionPanel>
        </MudExpansionPanels>
    }
    else
    {
        <MudAlert Severity="Severity.Success" Class="mt-6" Variant="Variant.Outlined">
            Alle Teile aus dem Upload wurden erfolgreich zugeordnet.
        </MudAlert>
    }

    <MudButton StartIcon="@Icons.Material.Filled.ArrowBack" Class="mt-8" Variant="Variant.Outlined" OnClick="GoBack">Back
    </MudButton>
}

@code {
    [Parameter] public int wantedListId { get; set; }
    private WantedList? _wantedList;
    private bool _loading = true;
    private bool _deletingList = false;
    private Dictionary<(int, int), Dictionary<string, int>> _ownedByBrand = new();

    // Diese Property gibt die MissingItems zurück oder eine leere Liste, falls keine da sind
    private List<WantedListMissingItem> MissingItems =>
    _wantedList?.MissingItems?.ToList() ?? new List<WantedListMissingItem>();

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        _wantedList = await WantedListService.GetWantedListByIdAsync(wantedListId);

        var inventory = await InventoryService.GetCurrentUserInventoryAsync();
        _ownedByBrand = inventory
        .GroupBy(i => (i.MappedBrickId, i.BrickColorId))
        .ToDictionary(
        g => g.Key,
        g => g.GroupBy(i => i.Brand).ToDictionary(bg => bg.Key, bg => bg.Sum(i => i.Quantity))
        );
        _loading = false;
    }

    private async Task DeleteList() { /* ... wie zuvor ... */ }
    private async Task DeleteItem(int id) { /* ... wie zuvor ... */ }
    protected int TotalNeeded => _wantedList?.Items?.Sum(b => b.Quantity) ?? 0;
    protected int TotalOwned => _wantedList?.Items?.Sum(b => Math.Min(GetOwnedQuantity(b), b.Quantity)) ?? 0;
    private int GetOwnedQuantity(WantedListItem item) => _ownedByBrand.TryGetValue((item.MappedBrickId, item.BrickColorId),
    out var brandDict) ? brandDict.Values.Sum() : 0;
    private void GoBack() => Nav.NavigateTo("/mywantedlists");

    private string GetMissingColorHex(int? externalId)
    {
        // 1. Prüfen, ob die ID vorhanden ist
        if (!externalId.HasValue) return "#eeeeee";

        // 2. Den Namen aus deiner BricklinkColorMap holen
        var colorName = Helpers.BricklinkColorMap.GetBrickColorName(externalId.Value);

        if (!string.IsNullOrEmpty(colorName))
        {
            // 3. Den Hex-Wert aus dem BrickColorHelper holen
            var hex = Helpers.BrickColorHelper.GetHexForColor(colorName);
            if (!string.IsNullOrEmpty(hex))
            {
                return hex;
            }
        }

        return "#eeeeee"; // Fallback
    }
}