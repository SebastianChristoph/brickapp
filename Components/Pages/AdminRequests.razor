@page "/admin-requests"
@using Microsoft.AspNetCore.Components
@using brickapp.Data.Services
@using brickapp.Components.Dialogs

<PageTitle>Admin Requests</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Admin Requests</MudText>


<MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2" Style="margin-bottom: 16px;">

    <MudButton StartIcon="Icons.Material.Filled.Refresh" Variant="Variant.Outlined" Color="Color.Primary"
        OnClick="ReloadData" Class="mb-3">Reload Data</MudButton>

</MudStack>

<MudTabs>
    <MudTabPanel
        Text="@(openMappingRequests == null ? "Mapping Requests" : $"Mapping Requests ({openMappingRequests.Count})")">
        @if (openMappingRequests == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (!openMappingRequests.Any())
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">No open mapping requests found.</MudAlert>
        }
        else
        {
         <MudTable Items="openMappingRequests" Hover="true">
    <HeaderContent>
        <MudTh>Image</MudTh> <MudTh>Brick</MudTh>
        <MudTh>Brand</MudTh>
        <MudTh>Mapping Name</MudTh>
        <MudTh>Mapping ItemId</MudTh>
        <MudTh>Requested By</MudTh>
        <MudTh>Created At</MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Image">
            @if (context.Brick != null)
            {
                <img src="@ImageService.GetMappedBrickImagePath(context.Brick)" 
                     alt="Brick Image" 
                     style="max-width:64px; max-height:64px; border:1px solid #ccc; padding:2px;" />
            }
            else
            {
                <img src="@ImageService.GetPlaceHolder()" 
                     alt="Placeholder" 
                     style="max-width:64px; max-height:64px; border:1px solid #ccc; padding:2px;" />
            }
        </MudTd>
        <MudTd DataLabel="Brick">@context.Brick?.Name</MudTd>
        <MudTd DataLabel="Brand">@context.Brand</MudTd>
        <MudTd DataLabel="Mapping Name">@context.MappingName</MudTd>
        <MudTd DataLabel="Mapping ItemId">@context.MappingItemId</MudTd>
        <MudTd DataLabel="Requested By">@context.RequestedByUser?.Name</MudTd>
        <MudTd DataLabel="Created At">@context.CreatedAt.ToLocalTime().ToString("g")</MudTd>
        <MudTd DataLabel="Actions">
            <MudButton Variant="Variant.Filled" Color="Color.Success"
                       OnClick="() => ApproveMappingRequest(context.Id)">Approve</MudButton>
           <MudButton Variant="Variant.Filled" Color="Color.Error"
           OnClick="() => RejectMappingRequestWithDialog(context.Id)">
    Reject
</MudButton>
        </MudTd>
    </RowTemplate>
</MudTable>
        }
    </MudTabPanel>
    <MudTabPanel Text="@(openItemRequests == null ? "Item Requests" : $"Item Requests ({openItemRequests.Count})")">
        @if (openItemRequests != null && openItemRequests.Any())
    {
        <MudStack Row="true" Justify="Justify.FlexEnd" Class="mb-3">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Error"
                       StartIcon="Icons.Material.Filled.DeleteForever"
                       OnClick="RejectAllItemRequests">
                Reject all item requests
            </MudButton>
        </MudStack>
    }
        @if (openItemRequests == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (!openItemRequests.Any())
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">No open item requests found.</MudAlert>
        }
        else
        {
            <MudTable Items="openItemRequests" Hover="true">
                <HeaderContent>
                    
                    <MudTh>Brand</MudTh>
                    <MudTh>PartNum</MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Image</MudTh>
                    <MudTh>Requested By</MudTh>
                    <MudTh>Created At</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Brand">@context.Brand</MudTd>
                    <MudTd DataLabel="PartNum">
                        @context.PartNum 
                        @if (context.Brand?.ToLower() == "lego")
                        {
                            <MudText Typo="Typo.caption"> 
                            <MudLink Href="@($"https://www.bricklink.com/v2/catalog/catalogitem.page?P={context.PartNum}")" Target="_blank">
                                Check auf Bricklink
                            </MudLink>
                            </MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Name">@context.Name</MudTd>
                    <MudTd DataLabel="Image">
                        @{
                            var imageUrl = ImageService.GetItemRequestImagePath(context);
                        }
                        <img src="@imageUrl" alt="Item Image"
                            style="max-width:64px;max-height:64px;border:1px solid #ccc;padding:2px;" />
                    </MudTd>
                    <MudTd DataLabel="Requested By">@context.RequestedByUser?.Name ?? @context.RequestedByUserId</MudTd>
                    <MudTd DataLabel="Created At">@context.CreatedAt.ToLocalTime().ToString("g")</MudTd>
                    <MudTd DataLabel="Status">@context.Status.ToString()</MudTd>
                    <MudTd DataLabel="Actions">
                        
                        <MudButton Variant="Variant.Filled" Color="Color.Success"
    OnClick="() => ApproveNewItemRequestWithDialog(context)">
    Approve
</MudButton>

                      <MudButton Variant="Variant.Filled" Color="Color.Error"
           OnClick="() => RejectNewItemRequestWithDialog(context.Id)">
    Reject
</MudButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudTabPanel>
    <MudTabPanel Text="@(openSetRequests == null ? "Set Requests" : $"Set Requests ({openSetRequests.Count})")">
        @if (openSetRequests == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (!openSetRequests.Any())
        {

            <MudAlert Severity="Severity.Info" Class="mt-4">No open set requests found.</MudAlert>
        }
        else
        {
            <MudTable Items="openSetRequests" Hover="true">
                <HeaderContent>
                    <MudTh>Image</MudTh>
                    <MudTh>Brand</MudTh>
                    <MudTh>Set No</MudTh>
                    <MudTh>Set Name</MudTh>

                    <MudTh>Requested By</MudTh>
                    <MudTh>Created At</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Image">
                        <img src="@ImageService.GetNewSetRequestImagePath(context)" alt="Set Image"
                            style="max-width:64px;max-height:64px;border:1px solid #ccc;padding:2px;" />
                    </MudTd>
                    <MudTd DataLabel="Brand">@context.Brand</MudTd>
                    <MudTd DataLabel="Set No">@context.SetNo</MudTd>
                    <MudTd DataLabel="Set Name">
                        <MudLink Href="@($"/preview-set-request/{context.Id}")" Color="Color.Primary">
                            @context.SetName
                        </MudLink>
                    </MudTd>

                    <MudTd DataLabel="Requested By">@context.UserId</MudTd>
                    <MudTd DataLabel="Created At">@context.CreatedAt.ToLocalTime().ToString("g")</MudTd>
                    <MudTd DataLabel="Status">@context.Status.ToString()</MudTd>
                    <MudTd DataLabel="Actions">
                        <MudButton Variant="Variant.Filled" Color="Color.Success"
                            OnClick="() => ApproveNewSetRequest(context.Id)">Approve</MudButton>
                       <MudButton Variant="Variant.Filled" Color="Color.Error"
           OnClick="() => RejectNewSetRequestWithDialog(context.Id)">
    Reject
</MudButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudTabPanel>

    <MudTabPanel Text="@(openImageRequests == null ? "Image Requests" : $"Image Requests ({openImageRequests.Count})")">
        @if (openImageRequests == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (!openImageRequests.Any())
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">No open image upload requests found.</MudAlert>
        }
        else
        {
            <MudTable Items="openImageRequests" Hover="true">
                <HeaderContent>
                    <MudTh>Current Image</MudTh>
                    <MudTh>Uploaded Image</MudTh>
                    <MudTh>Item Name</MudTh>
                    <MudTh>Lego Part#</MudTh>
                    <MudTh>Requested By</MudTh>
                    <MudTh>Created At</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Current Image">
                        @if (context.MappedBrick != null)
                        {
                            <img src="@ImageService.GetMappedBrickImagePath(context.MappedBrick)" 
                                 alt="Current" 
                                 style="max-width:64px;max-height:64px;border:1px solid #ccc;padding:2px;opacity:0.5;" />
                        }
                    </MudTd>
                    <MudTd DataLabel="Uploaded Image">
                        @if (!string.IsNullOrWhiteSpace(context.TempImagePath))
                        {
                            <img src="@context.TempImagePath" 
                                 alt="Uploaded" 
                                 style="max-width:80px;max-height:80px;border:2px solid #4CAF50;padding:2px;cursor:pointer;"
                                 @onclick="() => ShowImagePreview(context.TempImagePath)" />
                        }
                    </MudTd>
                    <MudTd DataLabel="Item Name">
                        <strong>@context.MappedBrick?.Name</strong>
                    </MudTd>
                    <MudTd DataLabel="Lego Part#">
                        @(context.MappedBrick?.LegoPartNum ?? "-")
                    </MudTd>
                    <MudTd DataLabel="Requested By">
                        @context.RequestedByUser?.Name
                    </MudTd>
                    <MudTd DataLabel="Created At">
                        @context.CreatedAt.ToLocalTime().ToString("g")
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Success"
                                   Size="Size.Small"
                                   OnClick="() => ApproveImageRequest(context.Id)">
                            Approve
                        </MudButton>
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Error"
                                   Size="Size.Small"
                                   OnClick="() => RejectImageRequestWithDialog(context.Id)">
                            Reject
                        </MudButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudTabPanel>
</MudTabs>

@code {
    [Inject] private Data.Services.RequestService RequestService { get; set; } = default!;
    [Inject] private brickapp.Data.Services.ImageService ImageService { get; set; } = default!;

    [Inject] private brickapp.Data.Services.NotificationService NotificationService { get; set; } = default!;
    [Inject]
    private Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthenticationStateProvider
    {
        get; set;
    } = default!;
    [Inject] private brickapp.Data.Services.UserService UserService { get; set; } = default!;
    [Inject] private IDialogService DialogService { get; set; } = default!;


    private List<Data.Entities.MappingRequest>? openMappingRequests;
    private List<Data.Entities.NewItemRequest>? openItemRequests;
    private List<Data.Entities.NewSetRequest>? openSetRequests;
    private List<Data.Entities.ItemImageRequest>? openImageRequests;

    protected override async Task OnInitializedAsync()
    {
        await ReloadData();
    }

    private async Task ReloadData()
    {
        openMappingRequests = await RequestService.GetOpenMappingRequestsAsync();
        openItemRequests = await RequestService.GetOpenNewItemRequestsAsync();
        openSetRequests = await RequestService.GetOpenNewSetRequestsAsync();
        openImageRequests = await RequestService.GetOpenItemImageRequestsAsync();
        StateHasChanged();
    }


private async Task<string?> OpenApproveNewItemDialogAsync(string currentName)
{
    var parameters = new DialogParameters
    {
        ["CurrentName"] = currentName
    };

    var options = new DialogOptions
    {
        CloseOnEscapeKey = true,
        MaxWidth = MaxWidth.Small,
        FullWidth = true
    };

    var dialogRef = await DialogService.ShowAsync<ApproveNewItemRequestDialog>(
        "Approve Item", parameters, options);

    if (dialogRef?.Result is null)
        return null;

    var result = await dialogRef.Result;
    if (result is null || result.Canceled)
        return null;

    var name = result.Data?.ToString();
    return string.IsNullOrWhiteSpace(name) ? null : name.Trim();
}

private async Task<ApproveItemDialogResult?> OpenApproveItemNameDialogAsync(string currentName)
{
    var parameters = new DialogParameters
    {
        ["CurrentName"] = currentName
    };

    var options = new DialogOptions
    {
        CloseOnEscapeKey = true,
        MaxWidth = MaxWidth.Small,
        FullWidth = true
    };

    var dialogRef = await DialogService.ShowAsync<ApproveNewItemRequestDialog>(
        "Approve Item", parameters, options);

    if (dialogRef?.Result is null)
        return null;

    var result = await dialogRef.Result;
    if (result is null || result.Canceled)
        return null;

    if (result.Data is ApproveItemDialogResult dialogResult)
        return dialogResult;

    return null;
}

private async Task ApproveNewItemRequestWithDialog(Data.Entities.NewItemRequest req)
{
    var dialogResult = await OpenApproveItemNameDialogAsync(req.Name ?? "");
    if (dialogResult is null) return; // cancel

    await ApproveNewItemRequest(req.Id, dialogResult.Name, dialogResult.NameChanged);
}


 private async Task<RejectDialogResult?> OpenRejectReasonDialogAsync(string? defaultReason = null)
{
    var parameters = new DialogParameters();

    if (!string.IsNullOrWhiteSpace(defaultReason))
        parameters.Add("DefaultReason", defaultReason);

    var options = new DialogOptions
    {
        CloseOnEscapeKey = true,
        MaxWidth = MaxWidth.Small,
        FullWidth = true
    };

    var dialogReference = await DialogService.ShowAsync<RejectRequestDialog>(
        "Reject Request", parameters, options);

    if (dialogReference is null)
        return null;

    // üëá WICHTIG: Result kann (selten/versionsabh√§ngig) null sein
    if (dialogReference.Result is null)
        return null;

    var result = await dialogReference.Result;

    if (result is null || result.Canceled)
        return null;

    if (result.Data is RejectDialogResult dialogResult)
        return dialogResult;

    return null;
}

private async Task RejectAllItemRequests()
{
    if (openItemRequests == null || !openItemRequests.Any())
        return;

    try
    {
        var token = await UserService.GetTokenAsync();
        if (token == null)
        {
            NotificationService.Error("User token not found.");
            return;
        }

        foreach (var request in openItemRequests)
        {
            await RequestService.RejectNewItemRequestAsync(
                request.Id,
                token,
                "rejected by admin"
            );
        }

        openItemRequests = await RequestService.GetOpenNewItemRequestsAsync();
        NotificationService.Success("Alle Item Requests wurden abgelehnt.");
    }
    catch (Exception ex)
    {
        NotificationService.Error($"Fehler beim Ablehnen aller Item Requests: {ex.Message}");
    }
}




private async Task RejectMappingRequestWithDialog(int requestId)
{
    var dialogResult = await OpenRejectReasonDialogAsync();
    if (dialogResult is null) return;

    if (dialogResult.Action == RejectAction.Reject)
        await RejectMappingRequest(requestId, dialogResult.Reason);
    else if (dialogResult.Action == RejectAction.RejectToPending)
        await RejectMappingRequestToPending(requestId, dialogResult.Reason);
}

private async Task RejectNewSetRequestWithDialog(int requestId)
{
    var dialogResult = await OpenRejectReasonDialogAsync();
    if (dialogResult is null) return;

    if (dialogResult.Action == RejectAction.Reject)
        await RejectNewSetRequest(requestId, dialogResult.Reason);
    else if (dialogResult.Action == RejectAction.RejectToPending)
        await RejectNewSetRequestToPending(requestId, dialogResult.Reason);
}

private async Task RejectNewSetRequest(int requestId, string reason)
{
    try
    {
        await RequestService.RejectNewSetRequestAsync(requestId, reason);
        openSetRequests = await RequestService.GetOpenNewSetRequestsAsync();
        NotificationService.Success("New set request erfolgreich abgelehnt.");
    }
    catch (Exception ex)
    {
        NotificationService.Error($"Fehler beim Ablehnen: {ex.Message}");
    }
}

private async Task RejectNewSetRequestToPending(int requestId, string reason)
{
    try
    {
        await RequestService.RejectNewSetRequestToPendingAsync(requestId, reason);
        openSetRequests = await RequestService.GetOpenNewSetRequestsAsync();
        NotificationService.Success("New set request zur√ºck auf Pending gesetzt.");
    }
    catch (Exception ex)
    {
        NotificationService.Error($"Fehler: {ex.Message}");
    }
}


private async Task RejectMappingRequest(int requestId, string reason)
{
    try
    {
        var token = await UserService.GetTokenAsync();
        if (token == null)
        {
            NotificationService.Error("User token not found.");
            return;
        }

        await RequestService.RejectMappingRequestAsync(requestId, token, reason);
        openMappingRequests = await RequestService.GetOpenMappingRequestsAsync();
        NotificationService.Success("Mapping-Request erfolgreich abgelehnt.");
    }
    catch (Exception ex)
    {
        NotificationService.Error($"Fehler beim Ablehnen: {ex.Message}");
    }
}

private async Task RejectMappingRequestToPending(int requestId, string reason)
{
    try
    {
        var token = await UserService.GetTokenAsync();
        if (token == null)
        {
            NotificationService.Error("User token not found.");
            return;
        }

        await RequestService.RejectMappingRequestToPendingAsync(requestId, token, reason);
        openMappingRequests = await RequestService.GetOpenMappingRequestsAsync();
        NotificationService.Success("Mapping-Request zur√ºck auf Pending gesetzt.");
    }
    catch (Exception ex)
    {
        NotificationService.Error($"Fehler: {ex.Message}");
    }
}


    private async Task ApproveMappingRequest(int requestId)
    {
        try
        {
            var token = await UserService.GetTokenAsync();
            if (token == null)
            {
                NotificationService.Error("User token not found.");
                return;
            }
            await RequestService.ApproveMappingRequestAsync(requestId, token);
            NotificationService.Success("Mapping request approved successfully.");
            openMappingRequests = await RequestService.GetOpenMappingRequestsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Error($"Error approving request: {ex.Message}");
        }
    }

    private async Task RejectMappingRequest(int requestId)
    {
        try
        {
            var token = await UserService.GetTokenAsync();
            if (token == null)
            {
                NotificationService.Error("User token not found.");
                return;
            }
            string reason = "abgelehnt durch Admin"; // Optional: Dialog f√ºr Grund
            await RequestService.RejectMappingRequestAsync(requestId, token, reason);
            openMappingRequests = await RequestService.GetOpenMappingRequestsAsync();
            NotificationService.Success("Mapping-Request erfolgreich abgelehnt.");
        }
        catch (Exception ex)
        {
            NotificationService.Error($"Fehler beim Ablehnen: {ex.Message}");
        }
    }

   private async Task ApproveNewItemRequest(int requestId, string newName, bool nameChanged)
{
    try
    {
        var token = await UserService.GetTokenAsync();
        if (token == null)
        {
            NotificationService.Error("User token not found.");
            return;
        }

        // token ist bei dir offenbar adminUserId
        await RequestService.ApproveNewItemRequestAsync(requestId, token, newName, nameChanged);

        NotificationService.Success("New item request approved successfully.");
        openItemRequests = await RequestService.GetOpenNewItemRequestsAsync();
    }
    catch (Exception ex)
    {
        NotificationService.Error($"Error approving request: {ex.Message}");
    }
}

    private async Task RejectNewItemRequestWithDialog(int requestId)
{
    var dialogResult = await OpenRejectReasonDialogAsync();
    if (dialogResult is null) return;

    if (dialogResult.Action == RejectAction.Reject)
        await RejectNewItemRequest(requestId, dialogResult.Reason);
    else if (dialogResult.Action == RejectAction.RejectToPending)
        await RejectNewItemRequestToPending(requestId, dialogResult.Reason);
}

private async Task RejectNewItemRequest(int requestId, string reason)
{
    try
    {
        var token = await UserService.GetTokenAsync();
        if (token == null)
        {
            NotificationService.Error("User token not found.");
            return;
        }

        await RequestService.RejectNewItemRequestAsync(requestId, token, reason);
        openItemRequests = await RequestService.GetOpenNewItemRequestsAsync();
        NotificationService.Success("New item request erfolgreich abgelehnt.");
    }
    catch (Exception ex)
    {
        NotificationService.Error($"Fehler beim Ablehnen: {ex.Message}");
    }
}

private async Task RejectNewItemRequestToPending(int requestId, string reason)
{
    try
    {
        var token = await UserService.GetTokenAsync();
        if (token == null)
        {
            NotificationService.Error("User token not found.");
            return;
        }

        await RequestService.RejectNewItemRequestToPendingAsync(requestId, token, reason);
        openItemRequests = await RequestService.GetOpenNewItemRequestsAsync();
        NotificationService.Success("New item request zur√ºck auf Pending gesetzt.");
    }
    catch (Exception ex)
    {
        NotificationService.Error($"Fehler: {ex.Message}");
    }
}


    private async Task RejectNewItemRequest(int requestId)
    {
        try
        {
            var token = await UserService.GetTokenAsync();
            if (token == null)
            {
                NotificationService.Error("User token not found.");
                return;
            }
            string reason = "abgelehnt durch Admin"; // Optional: Dialog f√ºr Grund
            await RequestService.RejectNewItemRequestAsync(requestId, token, reason);
            openItemRequests = await RequestService.GetOpenNewItemRequestsAsync();
            NotificationService.Success("New item request erfolgreich abgelehnt.");
        }
        catch (Exception ex)
        {
            NotificationService.Error($"Fehler beim Ablehnen: {ex.Message}");
        }
    }

    private async Task ApproveNewSetRequest(int requestId)
    {
        try
        {
            var token = await UserService.GetTokenAsync();
            if (token == null)
            {
                NotificationService.Error("User token not found.");
                return;
            }
            await RequestService.ApproveNewSetRequestAsync(requestId);
            NotificationService.Success("New set request approved successfully.");
            openSetRequests = await RequestService.GetOpenNewSetRequestsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Error($"Error approving request: {ex.Message}");
        }
    }

    private async Task RejectNewSetRequest(int requestId)
    {
        try
        {
            string reason = "abgelehnt durch Admin"; // Optional: Dialog f√ºr Grund
            await RequestService.RejectNewSetRequestAsync(requestId, reason);
            openSetRequests = await RequestService.GetOpenNewSetRequestsAsync();
            NotificationService.Success("New set request erfolgreich abgelehnt.");
        }
        catch (Exception ex)
        {
            NotificationService.Error($"Fehler beim Ablehnen: {ex.Message}");
        }
    }

    private async Task ApproveImageRequest(int requestId)
    {
        try
        {
            var token = await UserService.GetTokenAsync();
            if (token == null)
            {
                NotificationService.Error("User token not found.");
                return;
            }
            await RequestService.ApproveItemImageRequestAsync(requestId, token);
            NotificationService.Success("Image request approved successfully!");
            openImageRequests = await RequestService.GetOpenItemImageRequestsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Error($"Error approving image request: {ex.Message}");
        }
    }

    private async Task RejectImageRequestWithDialog(int requestId)
    {
        var dialogResult = await OpenRejectReasonDialogAsync();
        if (dialogResult is null) return;

        if (dialogResult.Action == RejectAction.Reject)
            await RejectImageRequest(requestId, dialogResult.Reason);
        else if (dialogResult.Action == RejectAction.RejectToPending)
            await RejectImageRequestToPending(requestId, dialogResult.Reason);
    }

    private async Task RejectImageRequest(int requestId, string reason)
    {
        try
        {
            var token = await UserService.GetTokenAsync();
            if (token == null)
            {
                NotificationService.Error("User token not found.");
                return;
            }
            await RequestService.RejectItemImageRequestAsync(requestId, token, reason);
            NotificationService.Success("Image request rejected.");
            openImageRequests = await RequestService.GetOpenItemImageRequestsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Error($"Error rejecting image request: {ex.Message}");
        }
    }

    private async Task RejectImageRequestToPending(int requestId, string reason)
    {
        try
        {
            var token = await UserService.GetTokenAsync();
            if (token == null)
            {
                NotificationService.Error("User token not found.");
                return;
            }
            await RequestService.RejectItemImageRequestToPendingAsync(requestId, token, reason);
            NotificationService.Success("Image request set back to pending.");
            openImageRequests = await RequestService.GetOpenItemImageRequestsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Error($"Error setting request to pending: {ex.Message}");
        }
    }

    private async Task ShowImagePreview(string imageUrl)
    {
        var parameters = new DialogParameters
        {
            ["ImageUrl"] = imageUrl
        };
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            CloseButton = true,
            CloseOnEscapeKey = true
        };
        await DialogService.ShowAsync<ImagePreviewDialog>("Image Preview", parameters, options);
    }
}