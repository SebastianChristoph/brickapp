@page "/admin-requests"
<PageTitle>Admin Requests</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Admin Requests</MudText>


<MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2" Style="margin-bottom: 16px;">

    <MudButton StartIcon="Icons.Material.Filled.Refresh" Variant="Variant.Outlined" Color="Color.Primary"
               OnClick="ReloadData" Class="mb-3">Reload Data
    </MudButton>

</MudStack>

<MudTabs>
    <MudTabPanel
        Text="@(openMappingRequests == null ? "Mapping Requests" : $"Mapping Requests ({openMappingRequests.Count})")">
        @if (openMappingRequests == null)
        {
            <MudProgressCircular Indeterminate="true"/>
        }
        else if (!openMappingRequests.Any())
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">No open mapping requests found.</MudAlert>
        }
        else
        {
            <MudTable Items="openMappingRequests" Hover="true">
                <HeaderContent>
                    <MudTh>Image</MudTh>
                    <MudTh>Brick</MudTh>
                    <MudTh>Brand</MudTh>
                    <MudTh>Mapping Name</MudTh>
                    <MudTh>Mapping ItemId</MudTh>
                    <MudTh>Requested By</MudTh>
                    <MudTh>Created At</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Image">
                        @if (context.Brick != null)
                        {
                            <img src="@ImageService.GetMappedBrickImagePath(context.Brick)"
                                 alt="Brick Image"
                                 style="max-width:64px; max-height:64px; border:1px solid #ccc; padding:2px;"/>
                        }
                        else
                        {
                            <img src="@ImageService.GetPlaceHolder()"
                                 alt="Placeholder"
                                 style="max-width:64px; max-height:64px; border:1px solid #ccc; padding:2px;"/>
                        }
                    </MudTd>
                    <MudTd DataLabel="Brick">@context.Brick?.Name</MudTd>
                    <MudTd DataLabel="Brand">@context.Brand</MudTd>
                    <MudTd DataLabel="Mapping Name">@context.MappingName</MudTd>
                    <MudTd DataLabel="Mapping ItemId">@context.MappingItemId</MudTd>
                    <MudTd DataLabel="Requested By">@context.RequestedByUser?.Name</MudTd>
                    <MudTd DataLabel="Created At">@context.CreatedAt.ToLocalTime().ToString("g")</MudTd>
                    <MudTd DataLabel="Actions">
                        <MudButton Variant="Variant.Filled" Color="Color.Success"
                                   OnClick="() => ApproveMappingRequest(context.Id)">Approve
                        </MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Error"
                                   OnClick="() => RejectMappingRequestWithDialog(context.Id)">
                            Reject
                        </MudButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudTabPanel>
    <MudTabPanel Text="@(openItemRequests == null ? "Item Requests" : $"Item Requests ({openItemRequests.Count})")">
        @if (openItemRequests != null && openItemRequests.Any())
        {
            <MudStack Row="true" Justify="Justify.FlexEnd" Class="mb-3">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Error"
                           StartIcon="Icons.Material.Filled.DeleteForever"
                           OnClick="RejectAllItemRequests">
                    Reject all item requests
                </MudButton>
            </MudStack>
        }
        @if (openItemRequests == null)
        {
            <MudProgressCircular Indeterminate="true"/>
        }
        else if (!openItemRequests.Any())
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">No open item requests found.</MudAlert>
        }
        else
        {
            <MudTable Items="openItemRequests" Hover="true">
                <HeaderContent>

                    <MudTh>Brand</MudTh>
                    <MudTh>PartNum</MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Image</MudTh>
                    <MudTh>Requested By</MudTh>
                    <MudTh>Created At</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Brand">@context.Brand</MudTd>
                    <MudTd DataLabel="PartNum">
                        @context.PartNum
                        @if (context.Brand?.ToLower() == "lego")
                        {
                            <MudText Typo="Typo.caption">
                                <MudLink
                                    Href="@($"https://www.bricklink.com/v2/catalog/catalogitem.page?P={context.PartNum}")"
                                    Target="_blank">
                                    Check auf Bricklink
                                </MudLink>
                            </MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Name">@context.Name</MudTd>
                    <MudTd DataLabel="Image">
                        @{
                            var imageUrl = ImageService.GetItemRequestImagePath(context);
                        }
                        <img src="@imageUrl" alt="Item Image"
                             style="max-width:64px;max-height:64px;border:1px solid #ccc;padding:2px;"/>
                    </MudTd>
                    <MudTd DataLabel="Requested By">@context.RequestedByUser?.Name ?? @context.RequestedByUserId</MudTd>
                    <MudTd DataLabel="Created At">@context.CreatedAt.ToLocalTime().ToString("g")</MudTd>
                    <MudTd DataLabel="Status">@context.Status.ToString()</MudTd>
                    <MudTd DataLabel="Actions">

                        <MudButton Variant="Variant.Filled" Color="Color.Success"
                                   OnClick="() => ApproveNewItemRequestWithDialog(context)">
                            Approve
                        </MudButton>

                        <MudButton Variant="Variant.Filled" Color="Color.Error"
                                   OnClick="() => RejectNewItemRequestWithDialog(context.Id)">
                            Reject
                        </MudButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudTabPanel>
    <MudTabPanel Text="@(openSetRequests == null ? "Set Requests" : $"Set Requests ({openSetRequests.Count})")">
        @if (openSetRequests == null)
        {
            <MudProgressCircular Indeterminate="true"/>
        }
        else if (!openSetRequests.Any())
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">No open set requests found.</MudAlert>
        }
        else
        {
            <MudTable Items="openSetRequests" Hover="true">
                <HeaderContent>
                    <MudTh>Image</MudTh>
                    <MudTh>Brand</MudTh>
                    <MudTh>Set No</MudTh>
                    <MudTh>Set Name</MudTh>

                    <MudTh>Requested By</MudTh>
                    <MudTh>Created At</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Image">
                        <img src="@ImageService.GetNewSetRequestImagePath(context)" alt="Set Image"
                             style="max-width:64px;max-height:64px;border:1px solid #ccc;padding:2px;"/>
                    </MudTd>
                    <MudTd DataLabel="Brand">@context.Brand</MudTd>
                    <MudTd DataLabel="Set No">@context.SetNo</MudTd>
                    <MudTd DataLabel="Set Name">
                        <MudLink Href="@($"/preview-set-request/{context.Id}")" Color="Color.Primary">
                            @context.SetName
                        </MudLink>
                    </MudTd>

                    <MudTd DataLabel="Requested By">@context.UserId</MudTd>
                    <MudTd DataLabel="Created At">@context.CreatedAt.ToLocalTime().ToString("g")</MudTd>
                    <MudTd DataLabel="Status">@context.Status.ToString()</MudTd>
                    <MudTd DataLabel="Actions">
                        <MudButton Variant="Variant.Filled" Color="Color.Success"
                                   OnClick="() => ApproveNewSetRequest(context.Id)">Approve
                        </MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Error"
                                   OnClick="() => RejectNewSetRequestWithDialog(context.Id)">
                            Reject
                        </MudButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudTabPanel>

    <MudTabPanel Text="@(openImageRequests == null ? "Image Requests" : $"Image Requests ({openImageRequests.Count})")">
        @if (openImageRequests == null)
        {
            <MudProgressCircular Indeterminate="true"/>
        }
        else if (!openImageRequests.Any())
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">No open image upload requests found.</MudAlert>
        }
        else
        {
            <MudTable Items="openImageRequests" Hover="true">
                <HeaderContent>
                    <MudTh>Current Image</MudTh>
                    <MudTh>Uploaded Image</MudTh>
                    <MudTh>Item Name</MudTh>
                    <MudTh>Lego Part#</MudTh>
                    <MudTh>Requested By</MudTh>
                    <MudTh>Created At</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Current Image">
                        @if (context.MappedBrick != null)
                        {
                            <img src="@ImageService.GetMappedBrickImagePath(context.MappedBrick)"
                                 alt="Current"
                                 style="max-width:64px;max-height:64px;border:1px solid #ccc;padding:2px;opacity:0.5;"/>
                        }
                    </MudTd>
                    <MudTd DataLabel="Uploaded Image">
                        @if (!string.IsNullOrWhiteSpace(context.TempImagePath))
                        {
                            <img src="@context.TempImagePath"
                                 alt="Uploaded"
                                 style="max-width:80px;max-height:80px;border:2px solid #4CAF50;padding:2px;cursor:pointer;"
                                 @onclick="() => ShowImagePreview(context.TempImagePath)"/>
                        }
                    </MudTd>
                    <MudTd DataLabel="Item Name">
                        <strong>@context.MappedBrick?.Name</strong>
                    </MudTd>
                    <MudTd DataLabel="Lego Part#">
                        @(context.MappedBrick?.LegoPartNum ?? "-")
                    </MudTd>
                    <MudTd DataLabel="Requested By">
                        @context.RequestedByUser?.Name
                    </MudTd>
                    <MudTd DataLabel="Created At">
                        @context.CreatedAt.ToLocalTime().ToString("g")
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Success"
                                   Size="Size.Small"
                                   OnClick="() => ApproveImageRequest(context.Id)">
                            Approve
                        </MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Error"
                                   Size="Size.Small"
                                   OnClick="() => RejectImageRequestWithDialog(context.Id)">
                            Reject
                        </MudButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudTabPanel>
</MudTabs>