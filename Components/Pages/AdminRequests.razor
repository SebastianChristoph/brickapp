@page "/admin-requests"
@using Microsoft.AspNetCore.Components
@using brickapp.Data.Services
@using brickapp.Components.Dialogs

<PageTitle>Admin Requests</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Admin Requests</MudText>


<MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2" Style="margin-bottom: 16px;">

    <MudButton StartIcon="Icons.Material.Filled.Refresh" Variant="Variant.Outlined" Color="Color.Primary"
        OnClick="ReloadData" Class="mb-3">Reload Data</MudButton>

</MudStack>

<MudTabs>
    <MudTabPanel
        Text="@(openMappingRequests == null ? "Mapping Requests" : $"Mapping Requests ({openMappingRequests.Count})")">
        @if (openMappingRequests == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (!openMappingRequests.Any())
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">No open mapping requests found.</MudAlert>
        }
        else
        {
         <MudTable Items="openMappingRequests" Hover="true">
    <HeaderContent>
        <MudTh>Image</MudTh> <MudTh>Brick</MudTh>
        <MudTh>Brand</MudTh>
        <MudTh>Mapping Name</MudTh>
        <MudTh>Mapping ItemId</MudTh>
        <MudTh>Requested By</MudTh>
        <MudTh>Created At</MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Image">
            @if (context.Brick != null)
            {
                <img src="@ImageService.GetMappedBrickImagePath(context.Brick)" 
                     alt="Brick Image" 
                     style="max-width:64px; max-height:64px; border:1px solid #ccc; padding:2px;" />
            }
            else
            {
                <img src="@ImageService.GetPlaceHolder()" 
                     alt="Placeholder" 
                     style="max-width:64px; max-height:64px; border:1px solid #ccc; padding:2px;" />
            }
        </MudTd>
        <MudTd DataLabel="Brick">@context.Brick?.Name</MudTd>
        <MudTd DataLabel="Brand">@context.Brand</MudTd>
        <MudTd DataLabel="Mapping Name">@context.MappingName</MudTd>
        <MudTd DataLabel="Mapping ItemId">@context.MappingItemId</MudTd>
        <MudTd DataLabel="Requested By">@context.RequestedByUser?.Name</MudTd>
        <MudTd DataLabel="Created At">@context.CreatedAt.ToLocalTime().ToString("g")</MudTd>
        <MudTd DataLabel="Actions">
            <MudButton Variant="Variant.Filled" Color="Color.Success"
                       OnClick="() => ApproveMappingRequest(context.Id)">Approve</MudButton>
           <MudButton Variant="Variant.Filled" Color="Color.Error"
           OnClick="() => RejectMappingRequestWithDialog(context.Id)">
    Reject
</MudButton>
        </MudTd>
    </RowTemplate>
</MudTable>
        }
    </MudTabPanel>
    <MudTabPanel Text="@(openItemRequests == null ? "Item Requests" : $"Item Requests ({openItemRequests.Count})")">
        @if (openItemRequests == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (!openItemRequests.Any())
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">No open item requests found.</MudAlert>
        }
        else
        {
            <MudTable Items="openItemRequests" Hover="true">
                <HeaderContent>
                    <MudTh>Id</MudTh>
                    <MudTh>Brand</MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Image</MudTh>
                    <MudTh>Requested By</MudTh>
                    <MudTh>Created At</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Id">@context.Id</MudTd>
                    <MudTd DataLabel="Brand">@context.Brand</MudTd>
                    <MudTd DataLabel="Name">@context.Name</MudTd>
                    <MudTd DataLabel="Image">
                        @{
                            var imageUrl = ImageService.GetItemRequestImagePath(context);
                        }
                        <img src="@imageUrl" alt="Item Image"
                            style="max-width:64px;max-height:64px;border:1px solid #ccc;padding:2px;" />
                    </MudTd>
                    <MudTd DataLabel="Requested By">@context.RequestedByUser?.Name ?? @context.RequestedByUserId</MudTd>
                    <MudTd DataLabel="Created At">@context.CreatedAt.ToLocalTime().ToString("g")</MudTd>
                    <MudTd DataLabel="Status">@context.Status.ToString()</MudTd>
                    <MudTd DataLabel="Actions">
                        <MudButton Variant="Variant.Filled" Color="Color.Success"
                            OnClick="() => ApproveNewItemRequest(context.Id)">Approve</MudButton>
                      <MudButton Variant="Variant.Filled" Color="Color.Error"
           OnClick="() => RejectNewItemRequestWithDialog(context.Id)">
    Reject
</MudButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudTabPanel>
    <MudTabPanel Text="@(openSetRequests == null ? "Set Requests" : $"Set Requests ({openSetRequests.Count})")">
        @if (openSetRequests == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (!openSetRequests.Any())
        {

            <MudAlert Severity="Severity.Info" Class="mt-4">No open set requests found.</MudAlert>
        }
        else
        {
            <MudTable Items="openSetRequests" Hover="true">
                <HeaderContent>
                    <MudTh>Image</MudTh>
                    <MudTh>Brand</MudTh>
                    <MudTh>Set No</MudTh>
                    <MudTh>Set Name</MudTh>

                    <MudTh>Requested By</MudTh>
                    <MudTh>Created At</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Image">
                        <img src="@ImageService.GetNewSetRequestImagePath(context)" alt="Set Image"
                            style="max-width:64px;max-height:64px;border:1px solid #ccc;padding:2px;" />
                    </MudTd>
                    <MudTd DataLabel="Brand">@context.Brand</MudTd>
                    <MudTd DataLabel="Set No">@context.SetNo</MudTd>
                    <MudTd DataLabel="Set Name">@context.SetName</MudTd>

                    <MudTd DataLabel="Requested By">@context.UserId</MudTd>
                    <MudTd DataLabel="Created At">@context.CreatedAt.ToLocalTime().ToString("g")</MudTd>
                    <MudTd DataLabel="Status">@context.Status.ToString()</MudTd>
                    <MudTd DataLabel="Actions">
                        <MudButton Variant="Variant.Filled" Color="Color.Success"
                            OnClick="() => ApproveNewSetRequest(context.Id)">Approve</MudButton>
                       <MudButton Variant="Variant.Filled" Color="Color.Error"
           OnClick="() => RejectNewSetRequestWithDialog(context.Id)">
    Reject
</MudButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudTabPanel>
</MudTabs>

@code {
    [Inject] private Data.Services.RequestService RequestService { get; set; } = default!;
    [Inject] private brickapp.Data.Services.ImageService ImageService { get; set; } = default!;

    [Inject] private brickapp.Data.Services.NotificationService NotificationService { get; set; } = default!;
    [Inject]
    private Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthenticationStateProvider
    {
        get; set;
    } = default!;
    [Inject] private brickapp.Data.Services.UserService UserService { get; set; } = default!;
    [Inject] private IDialogService DialogService { get; set; } = default!;


    private List<Data.Entities.MappingRequest>? openMappingRequests;
    private List<Data.Entities.NewItemRequest>? openItemRequests;
    private List<Data.Entities.NewSetRequest>? openSetRequests;

    protected override async Task OnInitializedAsync()
    {
        await ReloadData();
    }

    private async Task ReloadData()
    {
        openMappingRequests = await RequestService.GetOpenMappingRequestsAsync();
        openItemRequests = await RequestService.GetOpenNewItemRequestsAsync();
        openSetRequests = await RequestService.GetOpenNewSetRequestsAsync();
        StateHasChanged();
    }

 private async Task<string?> OpenRejectReasonDialogAsync(string? defaultReason = null)
{
    var parameters = new DialogParameters();

    if (!string.IsNullOrWhiteSpace(defaultReason))
        parameters.Add("DefaultReason", defaultReason);

    var options = new DialogOptions
    {
        CloseOnEscapeKey = true,
        MaxWidth = MaxWidth.Small,
        FullWidth = true
    };

    var dialogReference = await DialogService.ShowAsync<RejectRequestDialog>(
        "Reject Request", parameters, options);

    if (dialogReference is null)
        return null;

    // üëá WICHTIG: Result kann (selten/versionsabh√§ngig) null sein
    if (dialogReference.Result is null)
        return null;

    var result = await dialogReference.Result;

    if (result is null || result.Canceled)
        return null;

    var reason = result.Data?.ToString();
    return string.IsNullOrWhiteSpace(reason) ? null : reason.Trim();
}



private async Task RejectMappingRequestWithDialog(int requestId)
{
            var reason = await OpenRejectReasonDialogAsync();
    if (reason is null) return;

    await RejectMappingRequest(requestId, reason);
}

private async Task RejectNewSetRequestWithDialog(int requestId)
{
       var reason = await OpenRejectReasonDialogAsync();
    if (reason is null) return;

    await RejectNewSetRequest(requestId, reason);
}

private async Task RejectNewSetRequest(int requestId, string reason)
{
    try
    {
        await RequestService.RejectNewSetRequestAsync(requestId, reason);
        openSetRequests = await RequestService.GetOpenNewSetRequestsAsync();
        NotificationService.Success("New set request erfolgreich abgelehnt.");
    }
    catch (Exception ex)
    {
        NotificationService.Error($"Fehler beim Ablehnen: {ex.Message}");
    }
}


private async Task RejectMappingRequest(int requestId, string reason)
{
    try
    {
        var token = await UserService.GetTokenAsync();
        if (token == null)
        {
            NotificationService.Error("User token not found.");
            return;
        }

        await RequestService.RejectMappingRequestAsync(requestId, token, reason);
        openMappingRequests = await RequestService.GetOpenMappingRequestsAsync();
        NotificationService.Success("Mapping-Request erfolgreich abgelehnt.");
    }
    catch (Exception ex)
    {
        NotificationService.Error($"Fehler beim Ablehnen: {ex.Message}");
    }
}


    private async Task ApproveMappingRequest(int requestId)
    {
        try
        {
            var token = await UserService.GetTokenAsync();
            if (token == null)
            {
                NotificationService.Error("User token not found.");
                return;
            }
            await RequestService.ApproveMappingRequestAsync(requestId, token);
            NotificationService.Success("Mapping request approved successfully.");
            openMappingRequests = await RequestService.GetOpenMappingRequestsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Error($"Error approving request: {ex.Message}");
        }
    }

    private async Task RejectMappingRequest(int requestId)
    {
        try
        {
            var token = await UserService.GetTokenAsync();
            if (token == null)
            {
                NotificationService.Error("User token not found.");
                return;
            }
            string reason = "abgelehnt durch Admin"; // Optional: Dialog f√ºr Grund
            await RequestService.RejectMappingRequestAsync(requestId, token, reason);
            openMappingRequests = await RequestService.GetOpenMappingRequestsAsync();
            NotificationService.Success("Mapping-Request erfolgreich abgelehnt.");
        }
        catch (Exception ex)
        {
            NotificationService.Error($"Fehler beim Ablehnen: {ex.Message}");
        }
    }

    private async Task ApproveNewItemRequest(int requestId)
    {
        try
        {
            var token = await UserService.GetTokenAsync();
            if (token == null)
            {
                NotificationService.Error("User token not found.");
                return;
            }
            await RequestService.ApproveNewItemRequestAsync(requestId, token);
            NotificationService.Success("new item request approved successfully.");
            openItemRequests = await RequestService.GetOpenNewItemRequestsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Error($"Error approving request: {ex.Message}");
        }
    }

    private async Task RejectNewItemRequestWithDialog(int requestId)
{
       var reason = await OpenRejectReasonDialogAsync();
    if (reason is null) return;

    await RejectNewItemRequest(requestId, reason);
}

private async Task RejectNewItemRequest(int requestId, string reason)
{
    try
    {
        var token = await UserService.GetTokenAsync();
        if (token == null)
        {
            NotificationService.Error("User token not found.");
            return;
        }

        await RequestService.RejectNewItemRequestAsync(requestId, token, reason);
        openItemRequests = await RequestService.GetOpenNewItemRequestsAsync();
        NotificationService.Success("New item request erfolgreich abgelehnt.");
    }
    catch (Exception ex)
    {
        NotificationService.Error($"Fehler beim Ablehnen: {ex.Message}");
    }
}


    private async Task RejectNewItemRequest(int requestId)
    {
        try
        {
            var token = await UserService.GetTokenAsync();
            if (token == null)
            {
                NotificationService.Error("User token not found.");
                return;
            }
            string reason = "abgelehnt durch Admin"; // Optional: Dialog f√ºr Grund
            await RequestService.RejectNewItemRequestAsync(requestId, token, reason);
            openItemRequests = await RequestService.GetOpenNewItemRequestsAsync();
            NotificationService.Success("New item request erfolgreich abgelehnt.");
        }
        catch (Exception ex)
        {
            NotificationService.Error($"Fehler beim Ablehnen: {ex.Message}");
        }
    }

    private async Task ApproveNewSetRequest(int requestId)
    {
        try
        {
            var token = await UserService.GetTokenAsync();
            if (token == null)
            {
                NotificationService.Error("User token not found.");
                return;
            }
            await RequestService.ApproveNewSetRequestAsync(requestId);
            NotificationService.Success("New set request approved successfully.");
            openSetRequests = await RequestService.GetOpenNewSetRequestsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Error($"Error approving request: {ex.Message}");
        }
    }

    private async Task RejectNewSetRequest(int requestId)
    {
        try
        {
            string reason = "abgelehnt durch Admin"; // Optional: Dialog f√ºr Grund
            await RequestService.RejectNewSetRequestAsync(requestId, reason);
            openSetRequests = await RequestService.GetOpenNewSetRequestsAsync();
            NotificationService.Success("New set request erfolgreich abgelehnt.");
        }
        catch (Exception ex)
        {
            NotificationService.Error($"Fehler beim Ablehnen: {ex.Message}");
        }
    }
}