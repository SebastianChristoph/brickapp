@page "/preview-set-request/{requestId:int}"
@using brickapp.Data.Entities
@using brickapp.Data.Services

@inject RequestService RequestService
@inject ImageService ImageService
@inject UserService UserService
@inject NotificationService NotificationService
@inject IDialogService DialogService
@inject NavigationManager Nav

<PageTitle>Preview Set Request</PageTitle>

@if (_loading)
{
    <MudStack Justify="Justify.Center" Spacing="2" Style="margin-bottom: 16px; margin-top:16px;">
        <MudText>Loading set request...</MudText>
        <MudProgressLinear Color="Color.Primary" Indeterminate="true"/>
    </MudStack>
}
else if (!_isAdmin)
{
    <MudAlert Severity="Severity.Error">Access denied. This page is only available for administrators.</MudAlert>
}
else if (_setRequest is null)
{
    <MudAlert Severity="Severity.Error">Set request was not found.</MudAlert>
    <MudButton Variant="Variant.Outlined" OnClick="@GoBack">Back</MudButton>
}
else
{
    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Start">
            @{
                var setImgUrl = ImageService.GetNewSetRequestImagePath(_setRequest);
            }
            @if (!string.IsNullOrEmpty(setImgUrl) && setImgUrl != "/placeholder-image.png")
            {
                <div style="flex-shrink:0;">
                    <img src="@setImgUrl" alt="@_setRequest.SetName"
                         style="max-width: 300px; max-height: 300px; object-fit: contain; border: 1px solid #ddd; border-radius: 4px;"/>
                </div>
            }

            <MudStack Spacing="1" Style="flex: 1;">
                <MudText Typo="Typo.h4" GutterBottom="true">@_setRequest.SetName</MudText>

                <MudText Typo="Typo.subtitle1">Brand: @_setRequest.Brand</MudText>

                <MudText Typo="Typo.subtitle2">Set Nr: @_setRequest.SetNo</MudText>

                <MudText Typo="Typo.body2" Class="mt-2">
                    Status:
                    <MudChip T="string" Size="Size.Small"
                             Color="GetStatusColor(_setRequest.Status)">@_setRequest.Status</MudChip>
                </MudText>

                <MudText Typo="Typo.body2">
                    Requested by: @_setRequest.UserId
                </MudText>

                <MudText Typo="Typo.body2">
                    Created at: @_setRequest.CreatedAt.ToLocalTime().ToString("g")
                </MudText>

                @if (!string.IsNullOrWhiteSpace(_setRequest.ReasonRejected))
                {
                    <MudAlert Severity="Severity.Warning" Class="mt-2">
                        <strong>Rejection Reason:</strong> @_setRequest.ReasonRejected
                    </MudAlert>
                }
            </MudStack>
        </MudStack>
    </MudPaper>

    <MudText Typo="Typo.h6" GutterBottom="true" Class="mb-4">Items in this set (@_setRequest.Items.Count)</MudText>

    <MudTable Items="@_setRequest.Items" Hover="true" Breakpoint="Breakpoint.Sm">
        <HeaderContent>
            <MudTh>Item ID / Name</MudTh>
            <MudTh>Color</MudTh>
            <MudTh>Quantity</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd DataLabel="Item ID / Name">
                <MudText Typo="Typo.body2">@context.ItemIdOrName</MudText>
            </MudTd>

            <MudTd DataLabel="Color">
                <MudText Typo="Typo.body2">@context.Color</MudText>
            </MudTd>

            <MudTd DataLabel="Quantity">
                <MudText Typo="Typo.body2">@context.Quantity</MudText>
            </MudTd>
        </RowTemplate>

        <PagerContent>
            <MudTablePager PageSizeOptions="new[] { 25, 50, 100, 250 }"/>
        </PagerContent>
    </MudTable>

    @if (_setRequest.Status == NewSetRequestStatus.Pending)
    {
        <MudStack Row="true" Spacing="2" Class="mt-4">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       StartIcon="@Icons.Material.Filled.Check"
                       OnClick="@(() => ApproveNewSetRequest(_setRequest.Id))">
                Approve
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Error"
                       StartIcon="@Icons.Material.Filled.Close"
                       OnClick="@(() => RejectNewSetRequestWithDialog(_setRequest.Id))">
                Reject
            </MudButton>
        </MudStack>
    }

    <MudButton Class="mt-4" Variant="Variant.Outlined" OnClick="@GoBack">
        Back to Admin Requests
    </MudButton>
}