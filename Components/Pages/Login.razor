@page "/login"

@using brickapp.Data.Services
@using brickapp.Components.Dialogs
@inject brickapp.Data.Services.UserService UserService
@inject NavigationManager Nav
@inject IDialogService DialogService

<PageTitle>Login</PageTitle>

<!-- Mobile Warnung - nur auf Small und kleiner sichtbar -->
<MudHidden Breakpoint="Breakpoint.MdAndUp">
    <MudPaper Class="pa-6 mt-4" Elevation="2">
        <MudText Typo="Typo.h5" GutterBottom="true" Align="Align.Center">
            Mobile View Not Supported
        </MudText>
        <MudText Typo="Typo.body1" Align="Align.Center" Class="mt-4">
            This site is not designed to fit on a mobile screen. 
            Please consider switching to a tablet or PC for the best experience.
        </MudText>
        <MudText Typo="Typo.body2" Align="Align.Center" Class="mt-2" Color="Color.Secondary">
            üì± ‚û°Ô∏è üíª
        </MudText>
    </MudPaper>
</MudHidden>

<!-- Eigentlicher Content - nur ab Medium (Tablet) sichtbar -->
<MudHidden Breakpoint="Breakpoint.SmAndDown">
<MudStack Spacing="6" Row="true" StretchItems="StretchItems.All">
<MudPaper Class="pa-6 mx-auto" Style="min-width: 30vw;">
    <MudText Typo="Typo.h4" GutterBottom="true">Login</MudText>
    <MudText Typo="Typo.body2" GutterBottom="true">
        Please enter your token.
    </MudText>

    <MudTextField @bind-Value="_token"
                  Label="Token"
                  Required="true"
                  For="@(() => _token)"
                  Margin="Margin.Dense"
                  FullWidth="true" />

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <MudText Color="Color.Error">@_error</MudText>
    }

    <MudButton Class="mt-4"
               Variant="Variant.Filled"
               Color="Color.Primary"
               Disabled="@string.IsNullOrWhiteSpace(_token)"
               OnClick="LoginWithToken">
        Login
    </MudButton>
</MudPaper>


<MudPaper Class="pa-6 mx-auto" >
    <MudText Typo="Typo.h4" GutterBottom="true">Sign Up</MudText>
    <MudAlert Severity="Severity.Info" Class="mb-4">
        We don't want your email address, your data, or your password. Simply sign up here and receive your personal token. This token is your access to BrickIsBrick. Don't lose it ‚Äì there's no option to reissue or change it.
    </MudAlert>

    <MudTextField @bind-Value="_newUsername"
                  Label="Username"
                  Required="true"
                  For="@(() => _newUsername)"
                  Margin="Margin.Dense"
                  FullWidth="true" />

    @if (!string.IsNullOrWhiteSpace(_signupError))
    {
        <MudText Color="Color.Error">@_signupError</MudText>
    }

    <MudButton Class="mt-4"
               Variant="Variant.Filled"
               Color="Color.Secondary"
               Disabled="@string.IsNullOrWhiteSpace(_newUsername)"
               OnClick="SignUp">
        Sign Up
    </MudButton>
</MudPaper>
</MudStack>
</MudHidden>

@code {
    private string _token = string.Empty;
    private string? _error;
    private string _newUsername = string.Empty;
    private string? _signupError;

        private readonly DialogOptions dialogOptions = new()
    {
        BackdropClick = false,
        CloseButton = true,
        CloseOnEscapeKey = true
    };

    private async Task LoginWithToken()
    {
        _error = null;

        var success = await UserService.LoginWithTokenAsync(_token);

        if (!success)
        {
            _error = "Invalid token. Please check.";
            return;
        }

        // After successful login, navigate somewhere
        Nav.NavigateTo("/", true); // forceLoad: true
    }

    private async Task SignUp()
    {
        _signupError = null;

        if (string.IsNullOrWhiteSpace(_newUsername))
        {
            _signupError = "Please enter a username.";
            return;
        }

        var user = await UserService.AddUserAsync(_newUsername);

        if (user == null)
        {
            _signupError = "Error creating user. Please try again.";
            return;
        }

        // Show dialog with token
        var parameters = new DialogParameters
        {
            { "Token", user.Uuid },
            { "Username", user.Name }
        };

       
    

        await DialogService.ShowAsync<TokenDisplayDialog>("Your Access Token", parameters, dialogOptions);

        // Clear form
        _newUsername = string.Empty;
    }
}
