@page "/"
@using brickapp.Data.Services
@using MudBlazor
@inject brickapp.Data.Services.UserService UserService
@inject brickapp.Data.Services.StatsService StatsService

<PageTitle>Home</PageTitle>

<!-- Mobile Warnung - nur auf Small und kleiner sichtbar -->
<MudHidden Breakpoint="Breakpoint.MdAndUp">
    <MudPaper Class="pa-6 mt-4" Elevation="2">
        <MudText Typo="Typo.h5" GutterBottom="true" Align="Align.Center">
            Mobile View Not Supported
        </MudText>
        <MudText Typo="Typo.body1" Align="Align.Center" Class="mt-4">
            This site is not designed to fit on a mobile screen. 
            Please consider switching to a tablet or PC for the best experience.
        </MudText>
        <MudText Typo="Typo.body2" Align="Align.Center" Class="mt-2" Color="Color.Secondary">
            📱 ➡️ 💻
        </MudText>
    </MudPaper>
</MudHidden>

<!-- Eigentlicher Content - nur ab Medium (Tablet) sichtbar -->
<MudHidden Breakpoint="Breakpoint.SmAndDown">
@if (_username is null)
{
    <MudText Typo="Typo.h4" GutterBottom="true">Welcome to BrickIsBrick!</MudText>
    <MudAlert Severity="Severity.Info" Class="mt-4">
        Please <MudLink Href="/login" Color="Color.Primary">log in</MudLink> or <MudLink Href="/login" Color="Color.Primary">sign up</MudLink> to enjoy all features and start managing your brick inventory!
    </MudAlert>
}
else
{
    <MudText Typo="Typo.h4" GutterBottom="true">Hello @_username</MudText>

  <MudPaper Class="pa-4 mt-4" Elevation="1">
    <MudText Typo="Typo.body1">
        BrickIsBrick is a community-driven project!<br /><br />
        To make this platform better for everyone, there are two main ways you can help:
        <MudList T="string">
            <MudListItem T="string" Icon="@Icons.Material.Filled.Map">
                <b>Map Bricks:</b> Help us connect and match bricks across different brands.<br />
                <MudLink Href="/allbricks" Color="Color.Primary">Go to All Mapped Bricks</MudLink>
            </MudListItem>
            <MudListItem T="string" Icon="@Icons.Material.Filled.AddBox">
                <b>Add New Sets:</b> Contribute by entering new sets into the database.<br />
                <MudLink Href="/add-new-set" Color="Color.Primary">Add a New Set</MudLink>
            </MudListItem>
        </MudList>
    </MudText>

    </MudPaper>



    @if (_stats != null)
    {
        <MudPaper Class="pa-4 mt-4" Elevation="1">
        <MudText Class="mt-4" Typo="Typo.h6" GutterBottom="true">Database Progress</MudText>

        <MudChart ChartType="ChartType.Donut" Width="250px" Height="250px" InputData="@_chartData" InputLabels="@_chartLabels"
            ChartOptions="@_options">
            <CustomGraphics>
                <text x="50%" y="40%" dominant-baseline="middle" text-anchor="middle" fill="black" font-family="Helvetica"
                    font-size="20">Total items</text>
                <text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" fill="black" font-family="Helvetica"
                    font-size="35">@_stats?.TotalBricks</text>
            </CustomGraphics>
        </MudChart>

        <MudText>We have @_stats.MappedCount Items in our database</MudText>
        </MudPaper>

    }
    else
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }

}
<RebrickableThankYou />
</MudHidden>

<style>
    .donut-inner-text {
        font-weight: bold;
    }
</style>

@code {
    private string? _username;
    private BrickMappingStats? _stats;
    private double[] _chartData = [];
    private string[] _chartLabels = ["Mapped", "Unmapped"];
    private ChartOptions _options = new ChartOptions
    {
        ChartPalette = new[] { "#4CAF50", "#E0E0E0" } // Grün für Mapped, Grau für Unmapped
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        _username = await UserService.GetUsernameAsync();
        _stats = await StatsService.GetBrickMappingStatsAsync();

        if (_stats != null)
        {
            _chartData = new double[] { _stats.MappedCount, _stats.UnmappedCount };
        }

        StateHasChanged();
    }
}