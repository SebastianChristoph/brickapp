@page "/mywantedlists"
@using brickapp.Components.Shared.PartsListUpload
@using brickapp.Data.Services
@using brickapp.Helpers
@using static Data.Services.WantedListService

@inject WantedListService WantedListService
@inject MappedBrickService MappedBrickService
@inject ImageService ImageService
@inject TrackingService TrackingService
@inject IDialogService DialogService
@inject NavigationManager Nav
@inject LoadingService LoadingService
@inject NotificationService NotificationService

<PageTitle>My Wanted Lists</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">My Wanted Lists</MudText>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4">
        @_error
        @if (!string.IsNullOrWhiteSpace(_errorDetails))
        {
            <MudDivider Class="my-2"/>
            <MudText Typo="Typo.caption" Style="white-space:pre-wrap;">@_errorDetails</MudText>
        }
    </MudAlert>
}

<style>
    .brick {
        position: relative;
        display: inline-block;
        width: 56px;
        height: 56px;
        min-width: 56px;
        min-height: 56px;
        box-sizing: border-box;
    }

    .brick-img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 4px;
        border: 2px solid #ccc;
        background: #fff;
        display: block;
    }

    .brick::after {
        content: "";
        position: absolute;
        right: .5px;
        bottom: 0;
        width: 0;
        height: 0;
        border-bottom: 28px solid var(--brick-color, transparent);
        border-left: 28px solid transparent;
        border-radius: 0 0 4px 0;
        z-index: 2;
        pointer-events: none;
    }
</style>

<MudPaper Class="pa-4 mt-6">
    <MudText Typo="Typo.h5" GutterBottom="true">Create new wanted list</MudText>

    <EditForm Model="_newListModel" OnValidSubmit="HandleCreateWantedList">
        <MudTextField @bind-Value="_newListModel.Name" Label="List name" Required="true" Class="mb-2"/>

        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" Class="my-8">
            <MudTabPanel Text="Upload a item list">
                <PartsListUploader Title="Upload wanted list file"
                                   AddButtonText="Add uploaded items to your list"
                                   ClearButtonText="Clear upload"
                                   OnParsed="OnUploadParsed"
                                   OnAdd="AddUploadItemsToNewList_FromComponent"
                                   OnCleared="OnUploadCleared"/>
            </MudTabPanel>

            <MudTabPanel Text="Add items manually">
                <MudText Typo="Typo.h6" GutterBottom="true">Add items manually</MudText>
                <BrickPicker OnBrickAdded="HandleBrickAdded"
                             Label="Search for a brick"
                             Placeholder="Enter part number or name..."
                             AddButtonText="Add item to list"
                             ShowQuickColorPicker="true"/>
            </MudTabPanel>
        </MudTabs>

        <MudButton Variant="Variant.Filled"
                   StartIcon="@Icons.Material.Filled.Save"
                   Color="Color.Success"
                   Size="Size.Large"
                   ButtonType="ButtonType.Submit"
                   Disabled="@(_saving || !_newListModel.Items.Any())">
            @(_saving ? "Saving..." : "Save this wanted list")
        </MudButton>

        <MudDivider Class="my-12"/>

        @if (_newListModel.Items.Any())
        {
            <MudTable Items="_newListModel.Items"
                      Hover="true"
                      Striped="true"
                      Page="_itemsPage"
                      RowsPerPage="_itemsRowsPerPage"
                      OnPageChanged="OnItemsPageChanged"
                      OnRowsPerPageChanged="OnItemsRowsPerPageChanged">
                <HeaderContent>
                    <MudTh>Image</MudTh>
                    <MudTh>Brick</MudTh>
                    <MudTh>Color</MudTh>
                    <MudTh>Quantity</MudTh>
                    <MudTh Style="text-align:right">Actions</MudTh>
                </HeaderContent>

                <RowTemplate Context="item">
                    <MudTd DataLabel="Image">
                        @{
                            _brickById.TryGetValue(item.MappedBrickId, out var brick);

                            var colorName = _brickColors.FirstOrDefault(c => c.Id == item.ColorId)?.Name;
                            var overlay = BrickColorHelper.GetHexForColor(colorName);
                            var overlayCss = overlay ?? "transparent";

                            var url = brick != null ? ImageService.GetMappedBrickImagePath(brick) : "/placeholder-image.png";
                            var hasImage = !string.IsNullOrWhiteSpace(url) && url != "/placeholder-image.png";
                        }

                        <div class="brick"
                             style="--brick-color:@overlayCss; width:32px; height:32px; min-width:32px; min-height:32px;">
                            <img src="@(hasImage ? url : "/placeholder-image.png")"
                                 alt=""
                                 class="brick-img"
                                 style="border-width:1px;@(hasImage ? "" : "opacity:0.5;")"/>
                        </div>
                    </MudTd>

                    <MudTd DataLabel="Brick">@item.BrickName</MudTd>
                    <MudTd DataLabel="Color">@_brickColors.FirstOrDefault(c => c.Id == item.ColorId)?.Name</MudTd>
                    <MudTd DataLabel="Quantity">@item.Quantity</MudTd>
                    <MudTd DataLabel="Actions" Style="text-align:right">
                        <MudIconButton Variant="Variant.Outlined"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       OnClick="@(() => OpenEditItemDialog(item))"
                                       Icon="@Icons.Material.Filled.Edit"
                                       Class="mr-2">
                        </MudIconButton>

                        <MudIconButton Variant="Variant.Outlined"
                                       Color="Color.Error"
                                       Size="Size.Small"
                                       OnClick="@(() => RemoveItem(item))"
                                       Icon="@Icons.Material.Filled.Delete">
                        </MudIconButton>
                    </MudTd>
                </RowTemplate>

                <PagerContent>
                    <MudTablePager PageSizeOptions="new[] { 10, 25, 50, 100 }"/>
                </PagerContent>
            </MudTable>
        }
    </EditForm>
</MudPaper>

<MudDivider Class="my-12"/>

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5">Your Wanted Lists</MudText>

    <MudList T="string">
        @if (_loading)
        {
            <MudText>Loading...</MudText>
        }
        else if (_wantedListSummaries == null || !_wantedListSummaries.Any())
        {
            <MudAlert Severity="Severity.Info">You do not have any wanted lists yet.</MudAlert>
        }
        else
        {
            <MudTable Items="_wantedListSummaries" Hover="true" Breakpoint="Breakpoint.Sm" Context="wl"
                      OnRowClick="@((TableRowClickEventArgs<WantedListSummary> args) => GoToDetails(args.Item?.Id ?? 0))"
                      T="WantedListSummary" Style="cursor:pointer">
                <HeaderContent>

                    <MudTh>Name</MudTh>
                    <MudTh>Source</MudTh>
                    <MudTh>Items</MudTh>
                    <MudTh Style="text-align:right">Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Name">
                        <MudText>@wl.Name</MudText>
                    </MudTd>
                    <MudTd DataLabel="Source">
                        <MudText>@wl.Source</MudText>
                    </MudTd>
                    <MudTd DataLabel="Items">
                        <MudText Typo="Typo.body2">@wl.ItemCount Parts</MudText>
                    </MudTd>
                    <MudTd DataLabel="Actions" Style="text-align:right" @onclick:stopPropagation="true">
                        <MudIconButton Variant="Variant.Outlined"
                                       Color="Color.Error"
                                       Icon="@Icons.Material.Filled.Delete"
                                       Size="Size.Small"
                                       OnClick="@(() => RemoveWantedList(wl.Id))">
                        </MudIconButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudList>
</MudPaper>

@code {
    // Overview ist jetzt super leicht

    // Save UX

    // Pagination (New list preview table)

    // Lazy cache â€“ wird erst geladen, wenn der User wirklich sucht

    // =========================
    // ===== Upload (zentral) ===
    // =========================

}
