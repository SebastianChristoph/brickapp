@page "/myrequests"
@using Microsoft.AspNetCore.Components
@using brickapp.Data.Entities
@using brickapp.Data.Services
@inject brickapp.Data.Services.UserService UserService
@inject brickapp.Data.Services.RequestService RequestService
@inject brickapp.Data.Services.ImageService ImageService

<PageTitle>My Requests</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">My Requests</MudText>

<MudTabs>
    <MudTabPanel Text="Mapping requests">
        @if (_mappingRequests == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (!_mappingRequests.Any())
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">No mapping requests found.</MudAlert>
            
        }
        else
        {
            <MudTable Items="_mappingRequests" Hover="true" Striped="true">
                <HeaderContent>
                    <MudTh>Brick</MudTh>
                    <MudTh>Brand</MudTh>
                    <MudTh>Mapping Name</MudTh>
                    <MudTh>Mapping Item ID</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Reason (if rejected)</MudTh>
                    <MudTh>Created</MudTh>
                    <MudTh>Approved By</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Brick?.Name</MudTd>
                    <MudTd>@context.Brand</MudTd>
                    <MudTd>@context.MappingName</MudTd>
                    <MudTd>@context.MappingItemId</MudTd>
                    <MudTd>@context.Status</MudTd>
                    <MudTd>@context.ReasonRejected</MudTd>
                    <MudTd>@context.CreatedAt.ToLocalTime().ToString("g")</MudTd>
                    <MudTd>@context.ApprovedByUser?.Name</MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudTabPanel>
    <MudTabPanel Text="New Item Requests">
      
        @if (_itemRequests == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (!_itemRequests.Any())
        {
              <MudAlert Severity="Severity.Info" Class="mt-4">No open item requests found.</MudAlert>
        }
        else
        {
            <MudTable Items="_itemRequests" Hover="true" Striped="true">
                <HeaderContent>
                      <MudTh>Image</MudTh>
                    <MudTh>Brand</MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Item Number</MudTh>
                    <MudTh>Status</MudTh>
                  
                    <MudTh>Reason (if rejected)</MudTh>
                </HeaderContent>
                <RowTemplate>
                     <MudTd DataLabel="Image">
                        @{
                            var imageUrl = ImageService.GetItemRequestImagePath(context);
                        }
                        <img src="@imageUrl" alt="Item Image" style="max-width:64px;max-height:64px;border:1px solid #ccc;padding:2px;" />
                    </MudTd>
                    <MudTd DataLabel="Brand">@context.Brand</MudTd>
                    <MudTd DataLabel="Name">@context.Name</MudTd>
                    <MudTd>to be implmenented</MudTd>
                    <MudTd DataLabel="Status">
                        @if (context.Status.ToString() == "Approved")
                        {
                           <MudIcon Icon="@Icons.Material.Filled.Favorite" Color="Color.Success" Title="Favorite" />
                        }
                        else  if (context.Status.ToString() == "Rejected")
                        {
                           <MudIcon Icon="@Icons.Material.Filled.HeartBroken" Color="Color.Error" Title="Rejected" />
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Pending" Color="Color.Warning" Title="Pending" />
                            
                        }
                        @context.Status.ToString()
                    </MudTd>
                   
                    <MudTd DataLabel="Reason">
                        @if (context.Status == NewItemRequestStatus.Rejected && !string.IsNullOrWhiteSpace(context.ReasonRejected))
                        {
                            <MudAlert Severity="Severity.Error">@context.ReasonRejected</MudAlert>
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudTabPanel>
    <MudTabPanel Text="New Set Requests">
        @if (_setRequests == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (!_setRequests.Any())
        {
              <MudAlert Severity="Severity.Info" Class="mt-4">No set requests found.</MudAlert>
        }
        else
        {
            <MudTable Items="_setRequests" Hover="true" Striped="true">
                <HeaderContent>
                    <MudTh>Image</MudTh>
                    <MudTh>Brand</MudTh>
                    <MudTh>Set Name</MudTh>
                    <MudTh>Set Number</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Reason (if rejected)</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Image">
                        <img src="@ImageService.GetNewSetRequestImagePath(context)" alt="Set Image" style="max-width:64px;max-height:64px;border:1px solid #ccc;padding:2px;" />
                    </MudTd>
                    <MudTd DataLabel="Brand">@context.Brand</MudTd>
                    <MudTd DataLabel="Set Name">@context.SetName</MudTd>
                    <MudTd DataLabel="Set Number">@context.SetNo</MudTd>
                    <MudTd DataLabel="Status">
                        @if (context.Status.ToString() == "Approved")
                        {
                           <MudIcon Icon="@Icons.Material.Filled.Favorite" Color="Color.Success" Title="Favorite" />
                        }
                        else  if (context.Status.ToString() == "Rejected")
                        {
                           <MudIcon Icon="@Icons.Material.Filled.HeartBroken" Color="Color.Error" Title="Rejected" />
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Pending" Color="Color.Warning" Title="Pending" />
                        }
                        @context.Status.ToString()
                    </MudTd>
                    <MudTd DataLabel="Reason">
                        @if (context.Status == NewSetRequestStatus.Rejected && !string.IsNullOrWhiteSpace(context.ReasonRejected))
                        {
                            <MudAlert Severity="Severity.Error">@context.ReasonRejected</MudAlert>
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudTabPanel>
</MudTabs>

@code {
    private List<MappingRequest>? _mappingRequests;
    private List<NewItemRequest>? _itemRequests;
    private List<NewSetRequest>? _setRequests;

    protected override async Task OnInitializedAsync()
    {
        var userId = await UserService.GetTokenAsync();
        if (userId != null)
        {
            _mappingRequests = await RequestService.GetMappingRequestsByUserAsync(userId);
            _itemRequests = await RequestService.GetAllNewItemRequestsByUserAsync(userId);
            _setRequests = await RequestService.GetNewSetRequestsByUserAsync(userId);
        }
    }
}
