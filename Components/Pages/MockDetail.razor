@page "/mockdetail/{mockId:int}"

@using Data.Entities
@using Helpers
@using Microsoft.EntityFrameworkCore
@using MudBlazor

@inject IServiceProvider ServiceProvider
@inject NavigationManager Nav
@inject Services.InventoryService InventoryService
@inject IDialogService DialogService
@inject Services.NotificationService NotificationService
@inject Services.LoadingService LoadingService
@inject Data.Services.ImageService ImageService

<MudText Typo="Typo.h4" GutterBottom="true">MOC Detail</MudText>

@if (_loading)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (_mock == null)
{
    <MudAlert Severity="Severity.Error">MOC not found.</MudAlert>
    <MudButton StartIcon="@Icons.Material.Filled.ArrowBack" OnClick="GoBack">Back</MudButton>
}
else
{
    <MudPaper Class="pa-2 mb-2" Style="background:#f8f8f8;">
        <MudStack Row Spacing="8">
            <img src="@_mockImageUrl"
                 style="max-width:180px;max-height:180px;border:1px solid #ccc;background:#fafafa;" />

            <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="mt-16">
                <MudProgressLinear Value="@Percent"
                                   Striped
                                   Size="Size.Large"
                                   Style="min-width:200px;max-width:300px;width:30vw;" />
                <MudText>
                    @if (HasAll)
                    {
                        <b>You own all the bricks, you can build it!</b>
                    }
                    else
                    {
                        <span>
                            @TotalOwned of @TotalNeeded bricks (@Percent%)<br />
                            Missing: @TotalMissing
                        </span>
                    }
                </MudText>
            </MudStack>
        </MudStack>
    </MudPaper>

    <MudText Typo="Typo.h5">@_mock.Name</MudText>
    <MudText Typo="Typo.subtitle2" Class="mb-2">Type: @_mock.MockType</MudText>

    <MudButton Variant="Variant.Filled"
               Color="Color.Success"
               OnClick="OpenAddMockDialog"
               Size="Size.Large"
               Class="mt-2">
        <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-2" />
        Add all MOC parts to inventory
    </MudButton>

    <!-- FILTER BUTTONS -->
    <MudStack Row Spacing="2" Class="mt-4 mb-2">
        <MudButton Variant="@(_showOnlyMissing ? Variant.Outlined : Variant.Filled)"
                   Color="Color.Primary"
                   OnClick="ShowAllItems">
            Show all items
        </MudButton>

        <MudButton Variant="@(_showOnlyMissing ? Variant.Filled : Variant.Outlined)"
                   Color="Color.Primary"
                   OnClick="ShowOnlyMissingItems">
            Show only missing items
        </MudButton>
    </MudStack>

    <style>
        .brick {
            position: relative;
            width: 56px;
            height: 56px;
        }

        .brick-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
            border: 2px solid #ccc;
            background: #fff;
        }

        .brick::after {
            content: "";
            position: absolute;
            right: .5px;
            bottom: 0;
            border-bottom: 28px solid var(--brick-color, transparent);
            border-left: 28px solid transparent;
        }
    </style>

    <MudTable @key="_tableKey" Items="@_tableItems">
        <HeaderContent>
            <MudTh>Image</MudTh>
            <MudTh>Name</MudTh>
            <MudTh>Color</MudTh>
            <MudTh>Quantity</MudTh>
            <MudTh>Do you own?</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd>
                @{
                    var overlay = BrickColorHelper.GetHexForColor(context.BrickColor?.Name) ?? "transparent";
                    var img = context.MappedBrick != null
                        ? ImageService.GetMappedBrickImagePath(context.MappedBrick)
                        : "/placeholder-image.png";
                }

                <div class="brick" style="--brick-color:@overlay">
                    <img src="@img" class="brick-img" />
                </div>
            </MudTd>

            <MudTd>@context.MappedBrick?.Name</MudTd>
            <MudTd>@context.BrickColor?.Name</MudTd>
            <MudTd>@context.Quantity</MudTd>

            <MudTd>
                @{
                    var key = (context.MappedBrickId ?? 0, context.BrickColorId ?? 0);
                    if (_ownedByBrand.TryGetValue(key, out var brands))
                    {
                        foreach (var b in brands)
                        {
                            <MudChip T="string" Color="Color.Primary" Class="mr-1">
                                @b.Key: @b.Value
                            </MudChip>
                        }
                    }
                    else
                    {
                        <MudChip T="string">None</MudChip>
                    }
                }
            </MudTd>
        </RowTemplate>
    </MudTable>

    <MudButton StartIcon="@Icons.Material.Filled.ArrowBack"
               Variant="Variant.Outlined"
               Class="mt-4"
               OnClick="GoBack">
        Back
    </MudButton>
}

@code {

    [Parameter] public int mockId { get; set; }

    private Mock? _mock;
    private string? _mockImageUrl;
    private bool _loading = true;

    private bool _showOnlyMissing = false;
    private Guid _tableKey = Guid.NewGuid();
    private List<MockItem> _tableItems = new();

    private Dictionary<(int, int), Dictionary<string, int>> _ownedByBrand = new();

    private int TotalNeeded => _mock?.Items?.Sum(i => i.Quantity) ?? 0;
    private int TotalOwned => _mock?.Items?.Sum(i => Math.Min(GetOwnedQuantity(i), i.Quantity)) ?? 0;
    private int TotalMissing => TotalNeeded - TotalOwned;
    private int Percent => TotalNeeded == 0 ? 0 : (int)(100.0 * TotalOwned / TotalNeeded);
    private bool HasAll => TotalNeeded > 0 && TotalOwned == TotalNeeded;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await LoadMockAsync();
        _loading = false;
        StateHasChanged();
    }

    private async Task LoadMockAsync()
    {
        using var scope = ServiceProvider.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<Data.AppDbContext>();

        _mock = db.Mocks
            .Include(m => m.Items)
                .ThenInclude(i => i.MappedBrick)
            .Include(m => m.Items)
                .ThenInclude(i => i.BrickColor)
            .FirstOrDefault(m => m.Id == mockId);

        _mockImageUrl = _mock != null
            ? ImageService.GetMockImagePath(_mock)
            : "/placeholder-image.png";

        var inventory = await InventoryService.GetCurrentUserInventoryAsync();

        _ownedByBrand = inventory
            .GroupBy(i => (i.MappedBrickId, i.BrickColorId))
            .ToDictionary(
                g => g.Key,
                g => g.GroupBy(i => i.Brand)
                      .ToDictionary(bg => bg.Key, bg => bg.Sum(i => i.Quantity))
            );

        UpdateTableItems();
        _tableKey = Guid.NewGuid();
    }

    private void UpdateTableItems()
    {
        if (_mock?.Items == null)
        {
            _tableItems = new();
            return;
        }

        var items = _mock.Items.AsEnumerable();

        if (_showOnlyMissing)
        {
            // ðŸ”¥ nur Items, wo du NICHT genug hast
            items = items.Where(i => GetOwnedQuantity(i) < i.Quantity);
        }

        _tableItems = items.ToList();
    }

    private int GetOwnedQuantity(MockItem item)
    {
        return _ownedByBrand.TryGetValue(
            (item.MappedBrickId ?? 0, item.BrickColorId ?? 0),
            out var brands)
            ? brands.Values.Sum()
            : 0;
    }

    private void ShowAllItems()
    {
        _showOnlyMissing = false;
        UpdateTableItems();
        _tableKey = Guid.NewGuid();
        StateHasChanged();
    }

    private void ShowOnlyMissingItems()
    {
        _showOnlyMissing = true;
        UpdateTableItems();
        _tableKey = Guid.NewGuid();
        StateHasChanged();
    }

    private async Task OpenAddMockDialog()
    {
        var parameters = new DialogParameters { ["MockId"] = mockId };
        var dialog = await DialogService.ShowAsync<Components.Dialogs.AddMockToInventoryDialog>("", parameters);
        var result = await dialog.Result;

        if (result?.Data is bool ok && ok)
        {
            NotificationService.Success("MOC items successfully added.");
            Nav.NavigateTo("/myinventory");
        }
    }

    private void GoBack() => Nav.NavigateTo("/mymocks");
}
