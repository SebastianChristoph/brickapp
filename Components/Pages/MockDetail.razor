@page "/mockdetail/{mockId:int}"
@using Data.Entities
@using Helpers
@using Microsoft.EntityFrameworkCore
@inject IServiceProvider ServiceProvider
@inject NavigationManager Nav
@inject Services.InventoryService InventoryService

@inject IDialogService DialogService
@inject Services.NotificationService NotificationService

@inject Services.LoadingService LoadingService
@inject Data.Services.ImageService ImageService

@code {
    private Data.Services.ImageService? _imageService;
    private string? _mockImageUrl;
}

<h3>Mock Details</h3>

@if (_loading)
{
    <MudProgressCircular Indeterminate="true" />
}

else if (_mock == null)
{
    <MudText>Mock nicht gefunden.</MudText>
    <MudButton OnClick="GoBack">Zurück</MudButton>
}
else
{
    <MudPaper Class="pa-2 mb-2" Style="background:#f8f8f8;">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudProgressLinear Value="@Percent" Color="@(HasAll ? Color.Success : Color.Primary)" Style="min-width:200px;max-width:300px;width:30vw;" />
            <MudText Typo="Typo.body1" Class="ml-4">
                @if (HasAll)
                {
                    <b>Du hast alle Steine, du kannst es bauen!</b>
                }
                else
                {
                    <span>@TotalOwned von @TotalNeeded Steinen im Inventar (@Percent%)<br />Fehlend: @TotalMissing</span>
                }
            </MudText>
        </MudStack>
    </MudPaper>

    <div style="margin:16px 0;">
        <img src="@_mockImageUrl" alt="Mock Bild" style="max-width:180px;max-height:180px;border:1px solid #ccc;background:#fafafa;" />
    </div>

    <MudText Typo="Typo.h5">@_mock.Name</MudText>
    <MudText Typo="Typo.subtitle2" Class="mb-2">Typ: @_mock.MockType</MudText>
    <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="OpenAddMockDialog" Size="Size.Large" Class="mt-2">
        <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-2" />
        Alle Mock-Teile ins Inventar
    </MudButton>



    @if (_mock?.Items != null && _mock.Items.Any(i => i.MappedBrickId == null))
    {
        <MudExpansionPanels>
            <MudExpansionPanel Text="Für folgende Items wurde kein MappedBrick gefunden:" Color="Color.Warning" Style="background:#fffbe6;border:1px solid #ffe082;">
                <MudList T="string">
                    @foreach (var item in _mock.Items.Where(i => i.MappedBrickId == null))
                    {
                        var bricklinkUrl = $"https://www.bricklink.com/v2/search.page?q={item.ExternalPartNum}#T=P";
                        <MudListItem T="string">
                            <MudText>
                                ITEMID:
                                @if (_mock.MockType == "bricklink" && !string.IsNullOrWhiteSpace(item.ExternalPartNum))
                                {
                    
                                        <a href="@bricklinkUrl" target="_blank" rel="noopener noreferrer">
                                            @item.ExternalPartNum
                                        </a>
                                    
                                }
                                else
                                {
                                    <b>@item.ExternalPartNum blop</b>
                                }
                                , COLOR: <b>@item.BrickColorId</b>,
                                QTY: <b>@item.Quantity</b>
                            </MudText>
                        </MudListItem>
                    }
                </MudList>
            </MudExpansionPanel>
        </MudExpansionPanels>
    }


    <style>
        .brick {
            position: relative;
            display: inline-block;
            isolation: isolate;
        }

        .brick img {
            display: block;
        }

        .brick::after {
            content: "";
            position: absolute;
            inset: 0;
            background: var(--brick-overlay, transparent);
            mix-blend-mode: multiply;
            pointer-events: none;
            border-radius: 4px;
        }
    </style>


    <MudTable Items="GetFilteredItems()">
        <HeaderContent>
            <MudTh>Bild</MudTh>
            <MudTh>Standard-Name</MudTh>
            <MudTh>Farbe</MudTh>
            <MudTh>Lego</MudTh>
            <MudTh>BlueBrixx</MudTh>
            <MudTh>Cada</MudTh>
            <MudTh>Pantasy</MudTh>
            <MudTh>Mould King</MudTh>
            <MudTh>Unknown</MudTh>
            <MudTh>Anzahl</MudTh>
            <MudTh>Hast du?</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Bild">
                @{
                    var overlay = BrickColorHelper.GetHexForColor(context.BrickColor?.Name);
                    var url = ImageService.GetMappedBrickImagePath(context.MappedBrick);
                }
                <div style="position:relative;display:inline-block;min-width:48px;min-height:48px;">
                    @if (overlay != null)
                    {
                        <div class="brick" style="--brick-overlay:@overlay">
                            <img src="@url" alt=""
                                style="max-width:48px;max-height:48px;border-radius:4px;border:1px solid #ccc;z-index:1;"
                                onerror="this.style.opacity='0.5';" />
                        </div>
                    }
                    else
                    {
                        <img src="@url" alt=""
                            style="max-width:48px;max-height:48px;border-radius:4px;border:1px solid #ccc;z-index:1;"
                            onerror="this.style.opacity='0.5';" />
                    }
                </div>
            </MudTd>
            <MudTd DataLabel="Standard Name">@context.MappedBrick?.Name</MudTd>
            <MudTd DataLabel="Color">@context.BrickColor?.Name</MudTd>
            <MudTd DataLabel="Lego">
                @context.MappedBrick?.LegoName
                @if (!string.IsNullOrEmpty(context.MappedBrick?.LegoPartNum))
                {
                    <span style="font-size: 0.9em; color: #999;"> (@context.MappedBrick.LegoPartNum)</span>
                }
            </MudTd>
            <MudTd DataLabel="BlueBrixx">
                @context.MappedBrick?.BbName
                @if (!string.IsNullOrEmpty(context.MappedBrick?.BbPartNum))
                {
                    <span style="font-size: 0.9em; color: #999;"> (@context.MappedBrick.BbPartNum)</span>
                }
            </MudTd>
            <MudTd DataLabel="Cada">
                @context.MappedBrick?.CadaName
                @if (!string.IsNullOrEmpty(context.MappedBrick?.CadaPartNum))
                {
                    <span style="font-size: 0.9em; color: #999;"> (@context.MappedBrick.CadaPartNum)</span>
                }
            </MudTd>
            <MudTd DataLabel="Pantasy">
                @context.MappedBrick?.PantasyName
                @if (!string.IsNullOrEmpty(context.MappedBrick?.PantasyPartNum))
                {
                    <span style="font-size: 0.9em; color: #999;"> (@context.MappedBrick.PantasyPartNum)</span>
                }
            </MudTd>
            <MudTd DataLabel="Mould King">
                @context.MappedBrick?.MouldKingName
                @if (!string.IsNullOrEmpty(context.MappedBrick?.MouldKingPartNum))
                {
                    <span style="font-size: 0.9em; color: #999;"> (@context.MappedBrick.MouldKingPartNum)</span>
                }
            </MudTd>
            <MudTd DataLabel="Unknown">
                @context.MappedBrick?.UnknownName
                @if (!string.IsNullOrEmpty(context.MappedBrick?.UnknownPartNum))
                {
                    <span style="font-size: 0.9em; color: #999;"> (@context.MappedBrick.UnknownPartNum)</span>
                }
            </MudTd>
            <MudTd DataLabel="Anzahl">@context.Quantity</MudTd>
            <MudTd DataLabel="Do you own?">
                @{
                    var key = (context.MappedBrickId ?? 0, context.BrickColorId ?? 0);
                    if (_ownedByBrand.TryGetValue(key, out var brands) && brands.Count > 0)
                    {
                        foreach (var brand in brands)
                        {
                            <MudChip T="string" Color="Color.Primary" Class="mr-1 mb-1">@brand.Key: @brand.Value</MudChip>
                        }
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Default">None</MudChip>
                    }
                }
            </MudTd>
        </RowTemplate>
    </MudTable>
    <MudButton Class="mt-4" Variant="Variant.Outlined" OnClick="GoBack">
        Zurück
    </MudButton>
    }
}
}

@code {
    [Parameter] public int mockId { get; set; }
    private Mock? _mock;
    private bool _loading = true;
    // _partImageUrls wird nicht mehr benötigt
    private Dictionary<(int, int), Dictionary<string, int>> _ownedByBrand = new();

    private int TotalNeeded => _mock?.Items?.Sum(i => i.Quantity) ?? 0;
    private int TotalOwned => _mock?.Items?.Sum(i => Math.Min(GetOwnedQuantity(i), i.Quantity)) ?? 0;
    private int TotalMissing => TotalNeeded - TotalOwned;
    private int Percent => (TotalNeeded > 0 && TotalOwned == TotalNeeded)
        ? 100
        : (TotalNeeded > 0 ? (int)Math.Floor(100.0 * (double)TotalOwned / TotalNeeded) : 0);
    private bool HasAll => TotalNeeded > 0 && TotalOwned == TotalNeeded;

    private int GetOwnedQuantity(MockItem item)
    {
        return _ownedByBrand.TryGetValue((item.MappedBrickId ?? 0, item.BrickColorId ?? 0), out var brandDict)
            ? brandDict.Values.Sum()
            : 0;
    }

    private async Task OpenAddMockDialog()
    {
        var parameters = new DialogParameters { ["MockId"] = mockId };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };

        var dialog = await DialogService.ShowAsync<Components.Dialogs.AddMockToInventoryDialog>("Mock-Teile ins Inventar",
        parameters, options);
        var result = await dialog.Result;

        if (result != null && result.Data is bool confirmed)
        {
            LoadingService?.Hide();
            if (confirmed)
            {
                await OnInitializedAsync();
                StateHasChanged();
                NotificationService.Success("Mock-Items erfolgreich zum Inventar hinzugefügt.");
            }
            else
            {
                NotificationService.Error("Fehler beim Hinzufügen der Mock-Items zum Inventar.");
            }
        }
    }

    private IEnumerable<MockItem> GetFilteredItems()
    {
        if (_mock == null || _mock.Items == null)
            return Enumerable.Empty<MockItem>();

        if (_mock.MockType?.ToLower() == "bricklink")
        {
            // Nur Items mit Standard-Name anzeigen
            return _mock.Items.Where(i => i.MappedBrick != null && !string.IsNullOrWhiteSpace(i.MappedBrick.Name));
        }
        // Sonst wie bisher
        return _mock.Items.Where(i => i.MappedBrick != null || !string.IsNullOrWhiteSpace(i.ExternalPartNum) || i.Quantity > 0);
    }

    private bool _initialized = false;
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _initialized) return;
        _initialized = true;
        _loading = true;
        using var scope = ServiceProvider.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<Data.AppDbContext>();
        _mock = db.Mocks.Where(m => m.Id == mockId)
        .FirstOrDefault();
        if (_mock != null)
        {
            db.Entry(_mock).Collection(m => m.Items).Query()
            .Include(i => i.MappedBrick)
            .Include(i => i.BrickColor)
            .Load();
        }

        // Bild für Mock laden
        _mockImageUrl = ImageService.GetPlaceHolder();

        // Inventory laden
        var inventory = await InventoryService.GetCurrentUserInventoryAsync();
        _ownedByBrand = inventory
        .GroupBy(i => (i.MappedBrickId, i.BrickColorId))
        .ToDictionary(
        g => g.Key,
        g => g.GroupBy(i => i.Brand)
        .ToDictionary(
        bg => bg.Key,
        bg => bg.Sum(i => i.Quantity)
        )
        );

        // Bild-URLs laden entfällt, da ImageService genutzt wird

        _loading = false;
        StateHasChanged();
    }

    private void GoBack()
    {
        Nav.NavigateTo("/mymocks");
    }
}