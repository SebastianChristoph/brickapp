@page "/mockdetail/{mockId:int}"

@using brickapp.Data.Entities
@using brickapp.Helpers
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@using brickapp.Components.Dialogs

@inject IServiceProvider ServiceProvider
@inject NavigationManager Nav
@inject brickapp.Data.Services.InventoryService InventoryService
@inject IDialogService DialogService
@inject brickapp.Data.Services.NotificationService NotificationService
@inject brickapp.Data.Services.LoadingService LoadingService
@inject brickapp.Data.Services.ImageService ImageService

<MudText Typo="Typo.h4" GutterBottom="true">MOC Detail</MudText>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4">
        @_error
        @if (!string.IsNullOrWhiteSpace(_errorDetails))
        {
            <MudDivider Class="my-2" />
            <MudText Typo="Typo.caption" Style="white-space:pre-wrap;">
                @_errorDetails
            </MudText>
        }
    </MudAlert>
}

@if (_loading)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (_mock == null)
{
    <MudAlert Severity="Severity.Error">MOC not found.</MudAlert>
    <MudButton StartIcon="@Icons.Material.Filled.ArrowBack" OnClick="GoBack">Back</MudButton>
}
else
{

    @if (_resolvableMocItems != null && _resolvableMocItems.Any())
{
    <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="mb-4" Elevation="4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Spacing="0">
                <MudText Typo="Typo.body1"><b>Updates found!</b></MudText>
                <MudText Typo="Typo.body2">
                   <b> @_resolvableMocItems.Count </b> of the unmapped items have been mapped in the database since your last import. <b/>

You can now add them to your MOC by clicking the button below to improve the visual accuracy.<b/> <b>Please note: This will not change the number of parts in your list; </b> it only ensures that items are correctly displayed and identified.
                </MudText>
            </MudStack>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.AutoFixHigh"
                       Disabled="@_isResolving"
                       OnClick="ResolveMissingMocItems">
                Update MOC list
            </MudButton>
        </MudStack>
    </MudAlert>
}


    @* --- HEADER BEREICH --- *@
    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Start">
            <div style="flex-shrink:0;">
                <img src="@_mockImageUrl" alt="@_mock.Name"
                    style="height:200px; width:auto; object-fit:contain; border-radius:4px; border:1px solid #ccc;" />
            </div>

            <MudStack Spacing="1" Style="flex: 1;">
                <MudText Typo="Typo.h4" GutterBottom="true">@_mock.Name</MudText>
                <MudText Typo="Typo.subtitle1">Type: @_mock.MockType</MudText>
            </MudStack>
        </MudStack>
    </MudPaper>

    @* --- PROGRESS & AKTIONEN --- *@
    <MudStack Row="true" Spacing="2" StretchItems="StretchItems.Start" Class="mb-4">
        <OwnershipProgress OwnedCount="@TotalOwned" TotalCount="@TotalNeeded" />
        <MudSpacer />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenAddMockDialog"
            StartIcon="@Icons.Material.Filled.Add">
            Add all MOC parts to inventory
        </MudButton>
    </MudStack>

    <br />

    @* --- FILTER BUTTONS --- *@
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h6">Items in this MOC</MudText>

        <MudButton Variant="@(_showOnlyMissing? Variant.Outlined: Variant.Filled)" Color="Color.Primary"
            OnClick="ShowAllItems" StartIcon="@Icons.Material.Filled.List" Class="ml-4">
            Show all items
        </MudButton>

        <MudButton Variant="@(_showOnlyMissing? Variant.Filled: Variant.Outlined)" Color="Color.Primary"
            StartIcon="@Icons.Material.Filled.FilterList" OnClick="ShowOnlyMissingItems">
            Show only missing items
        </MudButton>
    </MudStack>

    <style>
        .brick {
            position: relative;
            width: 56px;
            height: 56px;
        }

        .brick-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
            border: 2px solid #ccc;
            background: #fff;
        }

        /* Das farbige Dreieck unten rechts */
        .brick::after {
            content: "";
            position: absolute;
            right: 0.5px;
            bottom: 0;
            border-bottom: 28px solid var(--brick-color, transparent);
            border-left: 28px solid transparent;
            pointer-events: none;
            /* Klicks durchlassen */
        }

        /* Kleinere Variante für die Missing-Tabelle */
        .brick-sm {
            width: 42px;
            height: 42px;
        }

        .brick-sm::after {
            border-bottom-width: 21px;
            border-left-width: 21px;
        }
    </style>

    <MudTable @key="_tableKey" Items="@_tableItems" Hover="true" Dense="true" Page="_itemsPage"
        RowsPerPage="_itemsRowsPerPage" OnPageChanged="OnItemsPageChanged" OnRowsPerPageChanged="OnItemsRowsPerPageChanged"
        Sortable="true" T="MockItem">
        <HeaderContent>
            <MudTh>Image</MudTh>
            
            <MudTh>
                <MudTableSortLabel T="MockItem"
                                   SortBy="@(x => x.MappedBrick?.Name ?? string.Empty)">
                    Name
                </MudTableSortLabel>
            </MudTh>
            
            <MudTh>
                <MudTableSortLabel T="MockItem"
                                   SortBy="@(x => x.BrickColor?.Name ?? string.Empty)">
                    Color
                </MudTableSortLabel>
            </MudTh>
            
            <MudTh>
                <MudTableSortLabel T="MockItem"
                                   SortBy="@(x => x.Quantity)">
                    Quantity
                </MudTableSortLabel>
            </MudTh>
            
            <MudTh>Do you own?</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd>
                @{
                    var hex = BrickColorHelper.GetHexForColor(context.BrickColor?.Name) ?? "transparent";
                    var img = context.MappedBrick != null
                    ? ImageService.GetMappedBrickImagePath(context.MappedBrick)
                    : ImageService.GetPlaceHolder();
                }

                <div class="brick" style="--brick-color:@hex">
                    <img src="@img" class="brick-img" />
                </div>
            </MudTd>

            <MudTd>@context.MappedBrick?.Name</MudTd>
            <MudTd>@context.BrickColor?.Name</MudTd>
            <MudTd>@context.Quantity</MudTd>

            <MudTd>
                @{
                    var key = (context.MappedBrickId ?? 0, context.BrickColorId ?? 0);
                    if (_ownedByBrand.TryGetValue(key, out var brands))
                    {
                        foreach (var b in brands)
                        {
                            <MudChip T="string" Color="Color.Primary" Class="mr-1" Size="Size.Small">
                                @b.Key: @b.Value
                            </MudChip>
                        }
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small">None</MudChip>
                    }
                }
            </MudTd>

            <MudTd>
                <MudStack Row="true" Spacing="1">
                    <MudTooltip Text="Add to Inventory">
                        <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Success"
                            OnClick="@(() => OpenAddInventoryDialog(context.MappedBrick))">
                            <MudIcon Icon="@Icons.Material.Filled.Add" />
                        </MudButton>
                    </MudTooltip>
                    <MudTooltip Text="Add to Wanted List">
                        <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary"
                            OnClick="@(() => OpenAddToWantedListDialog(context.MappedBrick))">
                            <MudIcon Icon="@Icons.Material.Filled.PlaylistAdd" />
                        </MudButton>
                    </MudTooltip>
                    <MudTooltip Text="Edit Item">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" 
                                   OnClick="@(() => OpenEditItemDialog(context.Id, context.Quantity, context.BrickColorId ?? 0))" />
                    </MudTooltip>
                </MudStack>
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 25, 50, 100, 250 }" />
        </PagerContent>
    </MudTable>

    @if (_mock.MissingItems != null && _mock.MissingItems.Any())
    {
        <MudText Typo="Typo.h5" Class="mt-8 mb-4"> Unassigned parts (Missing Mappings)</MudText>
        <MudAlert Severity="Severity.Warning" Class="mb-4">
            The following parts were found in the import file but could not be matched to any brick in the database.
        </MudAlert>

        <MudTable Items="@_mock.MissingItems" Dense="true" Hover="true" Elevation="1">
            <HeaderContent>
                <MudTh>External PartNum</MudTh>
                <MudTh>External Color ID</MudTh>
                <MudTh>Quantity</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="PartNum">@context.ExternalPartNum</MudTd>

                <MudTd DataLabel="Color ID">
                    @{
                        string? hex = null;
                        // Wir speichern die Source in einer lokalen Variable für bessere Lesbarkeit
                        var source = _mock.MockType?.ToLower();

                        if (source == "bricklink")
                        {
                            // Expliziter Aufruf mit dem nullable int?
                            hex = ColorIdMappingHelper.GetColorRgbWithBricklinkColorId(context.ExternalColorId);
                        }
                        else if (source == "rebrickable")
                        {
                            hex = ColorIdMappingHelper.GetColorRgbWithRebrickableColorId(context.ExternalColorId);
                        }
                        else
                        {
                            hex = ColorIdMappingHelper.GetColorRgbWithRebrickableColorId(context.ExternalColorId);
                        }

                        var displayHex = hex ?? "#eeeeee";
                    }

                    <div style="display:flex; align-items:center; gap:8px;">
                        <div
                            style="width:14px; height:14px; border-radius:50%; background-color:@displayHex; border:1px solid #ccc;">
                        </div>
                        <MudText Typo="Typo.body2">
                            @_mock.MockType ColorId: @context.ExternalColorId
                            <span style="color:gray; font-size: 0.8rem;">(@displayHex)</span>
                        </MudText>
                    </div>
                </MudTd>

                <MudTd DataLabel="Quantity">@context.Quantity</MudTd>
            </RowTemplate>
        </MudTable>
    }



    <MudButton StartIcon="@Icons.Material.Filled.ArrowBack" Variant="Variant.Outlined" Class="mt-8" OnClick="GoBack">
        Back
    </MudButton>
}