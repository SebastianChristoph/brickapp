@using Helpers
@page "/allbricks"
@using Services
@using Data.Services
@using Data.Entities
@using Components.Dialogs
@inject UserService UserService
@inject MappedBrickService BrickService
@inject RequestService RequestService
@inject Data.Services.ImageService ImageService

<style>
    .my-custom-class {
        backdrop-filter: blur(3px);
    }
</style>


<PageTitle>All Mapped Bricks</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">All Bricks</MudText>



<MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2" Style="margin-bottom: 16px;">
    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
        OnClick="OpenAddItemDialog" Class="mb-4">
        Add Item
    </MudButton>
    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.List"
        OnClick="ShowMappedItems" Class="mb-4">
        Show all mapped items
    </MudButton>
</MudStack>

@* Dismissible Info Alert above search field *@
@if (showHalloAlert)
{
    <MudAlert Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Start" ShowCloseIcon="true"
        CloseIconClicked="(() => showHalloAlert = false)">
        <b>Welcome to the Brick Mapping Center!</b><br />
        Here you can view all mapped bricks and their connections across brands.<br />
        <br />
        <b>Help us grow:</b> If you spot a brick that is not yet mapped to another brand (e.g. BlueBrixx, Cada, Pantasy,
        Mould King, etc.), you are invited to contribute!<br />
        <ul style="margin:0 0 0 1.2em;padding:0;font-size:0.98em;">
            <li>Click <b>Help Mapping</b> next to a brand to suggest a mapping for that brick.</li>
            <li>Your contributions help everyone find compatible parts and make the platform better for all!</li>
        </ul>
    </MudAlert>
}

<MudTextField Value="_searchText" ValueChanged="@(async (string e) => await OnSearchTextChanged(e))"
    Label="Search by name or ID" Variant="Variant.Outlined" Margin="Margin.Normal" Immediate="true"
    Placeholder="At least 3 characters..." Class="mb-4" />

@if (_searchingBricks)
{
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
        <MudProgressCircular Indeterminate="true" Size="Size.Small" />
        <MudText Typo="Typo.body2">Searching bricks…</MudText>
    </MudStack>
}

@if (!string.IsNullOrWhiteSpace(_searchText) && _searchText.Length >= 3)
{
    <MudTable Items="bricks" Hover="true" Striped="true" Dense="false" Page="_currentPage" RowsPerPage="_pageSize"
        OnPageChanged="OnPageChanged" OnRowsPerPageChanged="OnRowsPerPageChanged">
        <HeaderContent>
            <MudTh></MudTh>
            <MudTh>Image</MudTh>
            <MudTh>Name</MudTh>
            <MudTh>Lego</MudTh>
            <MudTh>Bluebrixx</MudTh>
            <MudTh>Cada</MudTh>
            <MudTh>Pantasy</MudTh>
            <MudTh>Mould King</MudTh>
            <MudTh>Unknown</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>
                <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Success"
                    OnClick="@(() => OpenAddInventoryDialog(context))">
                    <MudIcon Icon="@Icons.Material.Filled.Add" />
                </MudButton>
            </MudTd>
            <MudTd DataLabel="Image">
                @{
                    var imageUrl = ImageService.GetMappedBrickImagePath(context);
                }
                <img src="@imageUrl" alt="" style="max-width:48px;max-height:48px;border-radius:4px;border:1px solid #ccc;"
                    onerror="if(this.src!== '/placeholder-image.png'){this.src='/placeholder-image.png';this.style.opacity='0.5';}" />
            </MudTd>
            <MudTd DataLabel="Item Name">
                @context.Name
            </MudTd>
            <MudTd DataLabel="Lego">
                @if (!string.IsNullOrWhiteSpace(context.LegoName))
                {
                    @context.LegoName
                    @if (!string.IsNullOrWhiteSpace(context.LegoPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><br />[@context.LegoPartNum]</MudText>
                    }
                }
                else
                {
                    var legoRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "Lego" && r.Status ==
                    MappingRequestStatus.Pending);
                    if (legoRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping request by @legoRequest.RequestedByUserId pending
                        </MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context, "Lego"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>
            <MudTd DataLabel="BlueBrixx">
                @if (!string.IsNullOrWhiteSpace(context.BluebrixxName))
                {
                    @context.BluebrixxName@if (!string.IsNullOrWhiteSpace(context.BluebrixxPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><br />[@context.BluebrixxPartNum]</MudText>
                    }
                }
                @if (string.IsNullOrWhiteSpace(context.BluebrixxName))
                {
                    var bluebrixxRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "BlueBrixx" && r.Status ==
                    MappingRequestStatus.Pending);
                    if (bluebrixxRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping request by @bluebrixxRequest.RequestedByUserId pending
                        </MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context, "BlueBrixx"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>
            <MudTd DataLabel="Cada">
                @if (!string.IsNullOrWhiteSpace(context.CadaName))
                {
                    @context.CadaName@if (!string.IsNullOrWhiteSpace(context.CadaPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><br />[@context.CadaPartNum]</MudText>
                    }
                }
                @if (string.IsNullOrWhiteSpace(context.CadaName))
                {
                    var cadaRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "Cada" && r.Status ==
                    MappingRequestStatus.Pending);
                    if (cadaRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping request by @cadaRequest.RequestedByUserId pending
                        </MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context, "Cada"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>
            <MudTd DataLabel="Pantasy">
                @if (!string.IsNullOrWhiteSpace(context.PantasyName))
                {
                    @context.PantasyName@if (!string.IsNullOrWhiteSpace(context.PantasyPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><br />[@context.PantasyPartNum]</MudText>
                    }
                }
                @if (string.IsNullOrWhiteSpace(context.PantasyName))
                {
                    var pantasyRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "Pantasy" && r.Status ==
                    MappingRequestStatus.Pending);
                    if (pantasyRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping request by @pantasyRequest.RequestedByUserId pending
                        </MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context, "Pantasy"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>
            <MudTd DataLabel="Mould King">
                @if (!string.IsNullOrWhiteSpace(context.MouldKingName))
                {
                    @context.MouldKingName
                    @if (!string.IsNullOrWhiteSpace(context.MouldKingPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><br />[@context.MouldKingPartNum]</MudText>
                    }
                }
                @if (string.IsNullOrWhiteSpace(context.MouldKingName))
                {
                    var mkRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "Mould King" && r.Status ==
                    MappingRequestStatus.Pending);
                    if (mkRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping request by @mkRequest.RequestedByUserId pending</MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context, "Mould King"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>
            <MudTd DataLabel="Unknown">
                @if (!string.IsNullOrWhiteSpace(context.UnknownName))
                {
                    @context.UnknownName@if (!string.IsNullOrWhiteSpace(context.UnknownPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><br />[@context.UnknownPartNum]</MudText>
                    }
                }
                @if (string.IsNullOrWhiteSpace(context.UnknownName))
                {
                    var unknownRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "Unknown" && r.Status ==
                    MappingRequestStatus.Pending);
                    if (unknownRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping request by @unknownRequest.RequestedByUserId pending
                        </MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context, "Unknown"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 25, 50, 100 }" />
        </PagerContent>
    </MudTable>
}
else if (_showMappedOnly)
{
    <MudTable Items="bricks.Where(b => b.HasAtLeastOneMapping).Skip(_currentPage * _pageSize).Take(_pageSize).ToList()"
        Hover="true" Striped="true" Dense="false" Page="_currentPage" RowsPerPage="_pageSize" OnPageChanged="OnPageChanged"
        OnRowsPerPageChanged="OnRowsPerPageChanged">
        <HeaderContent>
            <MudTh></MudTh>
            <MudTh>Image</MudTh>
            <MudTh>Name</MudTh>
            <MudTh>Lego</MudTh>
            <MudTh>BlueBrixx</MudTh>
            <MudTh>Cada</MudTh>
            <MudTh>Pantasy</MudTh>
            <MudTh>Mould King</MudTh>
            <MudTh>Unknown</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>
                <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Success"
                    OnClick="@(() => OpenAddInventoryDialog(context))">
                    <MudIcon Icon="@Icons.Material.Filled.Add" />
                </MudButton>
            </MudTd>
            <MudTd DataLabel="Image">
                @{
                    var imageUrl = ImageService.GetMappedBrickImagePath(context);
                }
                <img src="@imageUrl" alt="" style="max-width:48px;max-height:48px;border-radius:4px;border:1px solid #ccc;"
                    onerror="if(this.src!== '/placeholder-image.png'){this.src='/placeholder-image.png';this.style.opacity='0.5';}" />
            </MudTd>
            <MudTd DataLabel="Item Name">
                @context.Name
            </MudTd>
            <MudTd DataLabel="Lego">
                @if (!string.IsNullOrWhiteSpace(context.LegoName))
                {
                    @context.LegoName
                    @if (!string.IsNullOrWhiteSpace(context.LegoPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"> [@context.LegoPartNum]</MudText>
                    }
                }
                else
                {
                    var legoRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "Lego" && r.Status ==
                    MappingRequestStatus.Pending);
                    if (legoRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping request by @legoRequest.RequestedByUserId pending
                        </MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context, "Lego"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>
            <MudTd DataLabel="BlueBrixx">
                @if (!string.IsNullOrWhiteSpace(context.BluebrixxName))
                {
                    @context.BluebrixxName@if (!string.IsNullOrWhiteSpace(context.BluebrixxPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"> [@context.BluebrixxPartNum]</MudText>
                    }
                }
                @if (string.IsNullOrWhiteSpace(context.BluebrixxName))
                {
                    var bluebrixxRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "BlueBrixx" && r.Status ==
                    MappingRequestStatus.Pending);
                    if (bluebrixxRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping request by @bluebrixxRequest.RequestedByUserId pending
                        </MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context, "BlueBrixx"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>
            <MudTd DataLabel="Cada">
                @if (!string.IsNullOrWhiteSpace(context.CadaName))
                {
                    @context.CadaName@if (!string.IsNullOrWhiteSpace(context.CadaPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"> [@context.CadaPartNum]</MudText>
                    }
                }
                @if (string.IsNullOrWhiteSpace(context.CadaName))
                {
                    var cadaRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "Cada" && r.Status ==
                    MappingRequestStatus.Pending);
                    if (cadaRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping request by @cadaRequest.RequestedByUserId pending
                        </MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context, "Cada"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>
            <MudTd DataLabel="Pantasy">
                @if (!string.IsNullOrWhiteSpace(context.PantasyName))
                {
                    @context.PantasyName@if (!string.IsNullOrWhiteSpace(context.PantasyPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"> [@context.PantasyPartNum]</MudText>
                    }
                }
                @if (string.IsNullOrWhiteSpace(context.PantasyName))
                {
                    var pantasyRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "Pantasy" && r.Status ==
                    MappingRequestStatus.Pending);
                    if (pantasyRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping request by @pantasyRequest.RequestedByUserId pending
                        </MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context, "Pantasy"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>
            <MudTd DataLabel="Mould King">
                @if (!string.IsNullOrWhiteSpace(context.MouldKingName))
                {
                    @context.MouldKingName
                    @if (!string.IsNullOrWhiteSpace(context.MouldKingPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"> [@context.UnknownPartNum]</MudText>
                    }
                }
                @if (string.IsNullOrWhiteSpace(context.MouldKingName))
                {
                    var mkRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "Mould King" && r.Status ==
                    MappingRequestStatus.Pending);
                    if (mkRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping request by @mkRequest.RequestedByUserId pending</MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context, "Mould King"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>
            <MudTd DataLabel="Unknown">
                @if (!string.IsNullOrWhiteSpace(context.UnknownName))
                {
                    @context.UnknownName@if (!string.IsNullOrWhiteSpace(context.UnknownPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"> [@context.UnknownPartNum]</MudText>
                    }
                }
                @if (string.IsNullOrWhiteSpace(context.UnknownName))
                {
                    var unknownRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "Unknown" && r.Status ==
                    MappingRequestStatus.Pending);
                    if (unknownRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping request by @unknownRequest.RequestedByUserId pending
                        </MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context, "Unknown"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 25, 50, 100 }" />
        </PagerContent>
    </MudTable>
}
@code {
    private bool _showMappedOnly = false;
    private async void ShowMappedItems()
    {
        _showMappedOnly = true;
        _searchText = string.Empty;
        _currentPage = 0;
        // Lade alle Bricks ohne Paginierung und ohne Suchtext, damit wirklich alle angezeigt werden
        var result = await BrickService.GetPaginatedMappedBricksAsync(1, 10000, "");
        bricks = result.Items;
        totalCount = result.TotalCount;
        StateHasChanged();
    }

    private string? _username;
    private List<MappedBrick> bricks = new();
    private int totalCount = 0;
    private bool _searchingBricks = false;
    private int _loadRequestId = 0;
    private string _searchText = string.Empty;
    private int _currentPage = 0;
    private int _pageSize = 25;

    private readonly DialogOptions dialogOptions = new()
    {
        BackdropClick = false,
        CloseButton = true,
        BackgroundClass =
    "my-custom-class",
        CloseOnEscapeKey = true
    };

    [Inject]
    private IDialogService DialogService { get; set; } = default!;

    [Inject]
    private Services.NotificationService NotificationService { get; set; } = default!;

    private async Task OpenAddInventoryDialog(MappedBrick brick)
    {
        var parameters = new DialogParameters<AddInventoryItemDialog>();
        parameters.Add(x => x.SelectedBrick, brick);
        var dialog = await DialogService.ShowAsync<AddInventoryItemDialog>("Add item to inventory", parameters, dialogOptions);
        var result = await dialog.Result;
        if (result is not null && result.Data is bool b && b)
        {
            NotificationService.Success("Item erfolgreich dem Inventar hinzugefügt!");
        }
    }

    private async Task OpenAddItemDialog()
    {

        var dialog = await DialogService.ShowAsync<AddItemDialog>("Add New Item", dialogOptions);
        var result = await dialog.Result;
        if (result is not null && !result.Canceled)
        {
            await RefreshBricks();
        }
    }

    private async Task OnSearchTextChanged(string value)
    {
        _searchText = value;
        if (!string.IsNullOrWhiteSpace(_searchText) && _searchText.Length < 3)
        {
            _loadRequestId++; // laufende Loads ungültig machen
            _searchingBricks = false;
            bricks.Clear();
            totalCount = 0;
            await InvokeAsync(StateHasChanged);
            return;
        }
        _currentPage = 0;
        if (!string.IsNullOrWhiteSpace(_searchText) && _searchText.Length >= 3)
        {
            _showMappedOnly = false;
        }
        await LoadBricksAsync();
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _username = await UserService.GetUsernameAsync();
            await LoadBricksAsync();
            StateHasChanged();
        }
    }

    private async void OnPageChanged(int page)
    {
        _currentPage = page;
        await LoadBricksAsync();
    }

    private async void OnRowsPerPageChanged(int size)
    {
        _pageSize = size;
        _currentPage = 0;
        await LoadBricksAsync();
    }
    private async Task LoadBricksAsync()
    {
        var reqId = ++_loadRequestId;

        _searchingBricks = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            // optional kleine Debounce für "Immediate=true"
            await Task.Delay(150);

            if (reqId != _loadRequestId) return;

            var result = await BrickService.GetPaginatedMappedBricksAsync(_currentPage + 1, _pageSize, _searchText);

            if (reqId != _loadRequestId) return;

            bricks = result.Items;
            totalCount = result.TotalCount;
        }
        finally
        {
            if (reqId == _loadRequestId)
            {
                _searchingBricks = false;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private async Task OpenHelpMappingDialog(MappedBrick brick, string brand)
    {
        var parameters = new DialogParameters();
        parameters.Add("Brick", brick);
        parameters.Add("Brand", brand);
        var dialog = await DialogService.ShowAsync<HelpMappingDialog>("Help with mapping", parameters);
        var result = await dialog.Result;
        if (result is not null && !result.Canceled && result.Data is ValueTuple<string, string, string> tuple)
        {
            await UpdateMappingAsync(brick, tuple.Item1, tuple.Item2, tuple.Item3);
            await RefreshBricks();
        }
    }

    private async Task UpdateMappingAsync(MappedBrick brick, string brand, string mappingName, string mappingItemId)
    {
        var userId = await UserService.GetTokenAsync();
        if (userId is null)
            return;
        await RequestService.CreateMappingRequestAsync(brick.Id, brand, mappingName, mappingItemId, userId);
        await RefreshBricks();
    }

    private async Task RefreshBricks()
    {
        await LoadBricksAsync();
    }

    private bool showHalloAlert = true;
}