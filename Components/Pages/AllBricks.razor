@using brickisbrickapp.Helpers
@page "/allbricks"
@using brickisbrickapp.Services
@using brickisbrickapp.Data.Services
@using brickisbrickapp.Data.Entities
@using brickisbrickapp.Components.Dialogs
@inject UserService UserService
@inject MappedBrickService BrickService
@inject RequestService RequestService



<PageTitle>All Mapped Bricks</PageTitle>

<MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddItemDialog" Class="mb-4">
    Add Item
</MudButton>

<MudText Typo="Typo.h5" GutterBottom="true">
    @(_username is null ? "Welcome to BrickIsBrick!" : $"Hello, {_username}")
</MudText>

<MudTextField Value="_searchText" ValueChanged="@(async (string e) => await OnSearchTextChanged(e))"
    Label="Search by name or ID" Variant="Variant.Outlined" Margin="Margin.Normal" Immediate="true"
    Placeholder="At least 3 characters..." Class="mb-4" />

@if (!string.IsNullOrWhiteSpace(_searchText) && _searchText.Length >= 3)
{
    if (bricks is null)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudTable Items="_filteredBricks" Hover="true" Striped="true" Dense="false" Page="_currentPage" RowsPerPage="_pageSize"
            OnPageChanged="OnPageChanged" OnRowsPerPageChanged="OnRowsPerPageChanged">
            <HeaderContent>
                <MudTh></MudTh>
                <MudTh>Image</MudTh>
                <MudTh>Name</MudTh>
                <!-- Lego Part No. entfernt -->
                <MudTh>Lego</MudTh>
                <MudTh>BB</MudTh>
                <MudTh>Cada</MudTh>
                <MudTh>Pantasy</MudTh>
                <MudTh>Mould King</MudTh>
                <MudTh>Unknown</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Success"
                        OnClick="@(() => OpenAddInventoryDialog(context))">
                        <MudIcon Icon="@Icons.Material.Filled.Add" />
                    </MudButton>
                </MudTd>
                <MudTd DataLabel="Image">
                    <img src="@(_imageUrls.ContainsKey(context.Id) ? _imageUrls[context.Id] : brickisbrickapp.Services.RebrickablePartImageService.PlaceholderUrl)" alt="" style="max-width:48px;max-height:48px;border-radius:4px;border:1px solid #ccc;"
                        onerror="if(this.src!== '@brickisbrickapp.Services.RebrickablePartImageService.PlaceholderUrl'){this.src='@brickisbrickapp.Services.RebrickablePartImageService.PlaceholderUrl';this.style.opacity='0.5';}" />
                </MudTd>
                <MudTd DataLabel="Item Name">
                    @context.Name
                </MudTd>

                <MudTd DataLabel="Lego">
                    @if (!string.IsNullOrWhiteSpace(context.LegoName))
                    {
                        @context.LegoName
                        @if (!string.IsNullOrWhiteSpace(context.LegoPartNum))
                        {
                            <span> [@context.LegoPartNum]</span>
                        }
                    }
                    else
                    {
                        var legoRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "Lego" && r.Status == MappingRequestStatus.Pending);
                        if (legoRequest != null)
                        {
                            <MudChip T="string" Color="Color.Warning">Mapping request by @legoRequest.RequestedByUserId pending</MudChip>
                        }
                        else
                        {
                            <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                                OnClick="@(() => OpenHelpMappingDialog(context, "Lego"))">Help Mapping</MudButton>
                        }
                    }
                </MudTd>
                <MudTd DataLabel="BB">
                    @if (!string.IsNullOrWhiteSpace(context.BbName))
                    {
                        @context.BbName@if (!string.IsNullOrWhiteSpace(context.BbPartNum)) {
                        <span> [@context.BbPartNum]</span>
                    }
                }
                @if (string.IsNullOrWhiteSpace(context.BbName))
                {
                    var bbRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "BB" && r.Status ==
                    MappingRequestStatus.Pending);
                    if (bbRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping request by @bbRequest.RequestedByUserId pending</MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context, "BB"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>
            <MudTd DataLabel="Cada">
                @if (!string.IsNullOrWhiteSpace(context.CadaName))
                {
                    @context.CadaName@if (!string.IsNullOrWhiteSpace(context.CadaPartNum)) {
                    <span>
                        [@context.CadaPartNum]</span>
                }
            }
            @if (string.IsNullOrWhiteSpace(context.CadaName))
            {
                var cadaRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "Cada" && r.Status ==
                MappingRequestStatus.Pending);
                if (cadaRequest != null)
                {
                    <MudChip T="string" Color="Color.Warning">Mapping request by @cadaRequest.RequestedByUserId pending
                    </MudChip>
                }
                else
                {
                    <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                        OnClick="@(() => OpenHelpMappingDialog(context, "Cada"))">Help Mapping</MudButton>
                }
            }
        </MudTd>
        <MudTd DataLabel="Pantasy">
            @if (!string.IsNullOrWhiteSpace(context.PantasyName))
            {
                @context.PantasyName@if (!string.IsNullOrWhiteSpace(context.PantasyPartNum)) {
                <span>
                    [@context.PantasyPartNum]</span>
            }
                        }
            @if (string.IsNullOrWhiteSpace(context.PantasyName))
            {
                var pantasyRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "Pantasy" && r.Status ==
                MappingRequestStatus.Pending);
                if (pantasyRequest != null)
                {
                    <MudChip T="string" Color="Color.Warning">Mapping request by @pantasyRequest.RequestedByUserId pending
                    </MudChip>
                }
                else
                {
                    <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                        OnClick="@(() => OpenHelpMappingDialog(context, "Pantasy"))">Help Mapping</MudButton>
                }
            }
        </MudTd>
        <MudTd DataLabel="Mould King">
            @if (!string.IsNullOrWhiteSpace(context.MouldKingName))
            {
                @context.MouldKingName@if (!string.IsNullOrWhiteSpace(context.MouldKingPartNum)) {
                <span>
                    [@context.MouldKingPartNum]</span>
            }
                        }
            @if (string.IsNullOrWhiteSpace(context.MouldKingName))
            {
                var mkRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "Mould King" && r.Status ==
                MappingRequestStatus.Pending);
                if (mkRequest != null)
                {
                    <MudChip T="string" Color="Color.Warning">Mapping request by @mkRequest.RequestedByUserId pending</MudChip>
                }
                else
                {
                    <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                        OnClick="@(() => OpenHelpMappingDialog(context, "Mould King"))">Help Mapping</MudButton>
                }
            }
        </MudTd>
        <MudTd DataLabel="Unknown">
            @if (!string.IsNullOrWhiteSpace(context.UnknownName))
            {
                @context.UnknownName@if (!string.IsNullOrWhiteSpace(context.UnknownPartNum)) {
                <span>
                    [@context.UnknownPartNum]</span>
            }
                        }
            @if (string.IsNullOrWhiteSpace(context.UnknownName))
            {
                var unknownRequest = context.MappingRequests?.FirstOrDefault(r => r.Brand == "Unknown" && r.Status ==
                MappingRequestStatus.Pending);
                if (unknownRequest != null)
                {
                    <MudChip T="string" Color="Color.Warning">Mapping request by @unknownRequest.RequestedByUserId pending
                    </MudChip>
                }
                else
                {
                    <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                        OnClick="@(() => OpenHelpMappingDialog(context, "Unknown"))">Help Mapping</MudButton>
                }
            }
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager PageSizeOptions="new int[] { 25, 50, 100 }" />
    </PagerContent>
</MudTable>
}
}

@code {
    private string? _username;
    private List<MappedBrick>? bricks;
    private string _searchText = string.Empty;
    // Key: BrickId
    private Dictionary<int, string> _imageUrls = new();
    private int _currentPage = 0;
    private int _pageSize = 25;
    private List<MappedBrick> _filteredBricks =>
    string.IsNullOrWhiteSpace(_searchText) || _searchText.Length < 3
    ? bricks ?? new List<MappedBrick>()
    : (bricks ?? new List<MappedBrick>()).Where(b =>
    (b.Name?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
    || (b.LegoPartNum?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
    || (b.BbName?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
    || (b.CadaName?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
    || (b.PantasyName?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
    || (b.MouldKingName?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
    || b.Id.ToString().Contains(_searchText)
    ).ToList();

    // Paging is handled by MudTable, no custom pagination needed

    [Inject]
    private IDialogService DialogService { get; set; } = default!;

    private async Task OpenAddInventoryDialog(MappedBrick brick)
    {
        var parameters = new DialogParameters<AddInventoryItemDialog>();
        parameters.Add(x => x.SelectedBrick, brick);
        var dialog = await DialogService.ShowAsync<AddInventoryItemDialog>("Add item to inventory", parameters);
        var result = await dialog.Result;
        // Optional: Feedback or Refresh
    }

    private async Task OpenAddItemDialog()
    {
        var dialog = await DialogService.ShowAsync<AddItemDialog>("Add New Item");
        var result = await dialog.Result;
        if (result is not null && !result.Canceled)
        {
            await RefreshBricks();
        }
    }

    private async Task OnSearchTextChanged(string value)
    {
        _searchText = value;
        await LoadImageUrlsAsync();
    }

    private async Task LoadImageUrlsAsync()
    {
        var imageService = new brickisbrickapp.Services.RebrickablePartImageService(new System.Net.Http.HttpClient());
        _imageUrls.Clear();
        foreach (var brick in _filteredBricks)
        {
            var partNum = brick.LegoPartNum;
            if (string.IsNullOrWhiteSpace(partNum))
            {
                _imageUrls[brick.Id] = brickisbrickapp.Services.RebrickablePartImageService.PlaceholderUrl;
                continue;
            }
            var brand = brick.BbName != null ? "BB" :
                       brick.CadaName != null ? "Cada" :
                       brick.PantasyName != null ? "Pantasy" :
                       brick.MouldKingName != null ? "Mould King" :
                       brick.UnknownName != null ? "Unknown" : null;
            var name = brick.Name;
            var imgUrl = await imageService.GetPartImageUrlAsync(partNum, brand, name);
            var placeholder = brickisbrickapp.Services.RebrickablePartImageService.PlaceholderUrl;
            _imageUrls[brick.Id] = string.IsNullOrWhiteSpace(imgUrl) ? placeholder : imgUrl;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        _username = await UserService.GetUsernameAsync();
        bricks = await BrickService.GetAllMappedBricksAsync();
        await LoadImageUrlsAsync();
        StateHasChanged();
    }

    private void OnPageChanged(int page)
    {
        _currentPage = page;
        StateHasChanged();
    }

    private void OnRowsPerPageChanged(int size)
    {
        _pageSize = size;
        _currentPage = 0;
        StateHasChanged();
    }

    private async Task OpenHelpMappingDialog(MappedBrick brick, string brand)
    {
        var parameters = new DialogParameters();
        parameters.Add("Brick", brick);
        parameters.Add("Brand", brand);
        var dialog = await DialogService.ShowAsync<HelpMappingDialog>("Help with mapping", parameters);
        var result = await dialog.Result;
        if (result is not null && !result.Canceled && result.Data is ValueTuple<string, string, string> tuple)
        {
            await UpdateMappingAsync(brick, tuple.Item1, tuple.Item2, tuple.Item3);
            await RefreshBricks();
        }
    }

    private async Task UpdateMappingAsync(MappedBrick brick, string brand, string mappingName, string mappingItemId)
    {
        var userId = await UserService.GetTokenAsync();
        if (userId is null)
            return;
        await RequestService.CreateMappingRequestAsync(brick.Id, brand, mappingName, mappingItemId, userId);
        await RefreshBricks();
    }

    private async Task RefreshBricks()
    {
        bricks = await BrickService.GetAllMappedBricksAsync();
        await LoadImageUrlsAsync();
        StateHasChanged();
    }
}