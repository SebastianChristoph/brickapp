@page "/myinventory"
@using brickapp.Data.Entities
@using brickapp.Data.Services
@using brickapp.Helpers

@inject UserService UserService
@inject InventoryService InventoryService
@inject TrackingService TrackingService
@inject IDialogService DialogService
@inject NavigationManager Nav
@inject ImageService ImageService
@inject NotificationService NotificationService
@inject WantedListService WantedListService

<PageTitle>My Inventory</PageTitle>
<MudText Typo="Typo.h4" GutterBottom="true">My Inventory</MudText>

<MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2" Style="margin-bottom: 16px;">
    <MudButton StartIcon="@Icons.Material.Filled.Add"
               Variant="Variant.Filled"
               Color="Color.Primary"
               OnClick="@OpenAddItemDialog"
               Class="mb-4">
        Add item
    </MudButton>

    <MudButton StartIcon="@Icons.Material.Filled.Delete"
               Variant="Variant.Filled"
               Color="Color.Error"
               OnClick="OpenDeleteAllDialog"
               Class="mb-4">
        Delete entire inventory
    </MudButton>
</MudStack>

@if (!_authChecked)
{
    <MudProgressCircular Indeterminate="true"/>
}
else if (!_isAuth)
{
    <MudProgressCircular Indeterminate="true"/>
}
else if (_items is null)
{
    <MudProgressCircular Indeterminate="true"/>
}
else if (_items.Count == 0)
{
    <MudAlert Severity="Severity.Info" Typo="Typo.body1">
        You do not have any items in your inventory yet.
    </MudAlert>
}
else
{
    var grouped = _items
        .GroupBy(i => i.Brand)
        .OrderBy(g => g.Key)
        .ToList();

    <MudExpansionPanels>
        @foreach (var brandGroup in grouped)
        {
            <MudExpansionPanel Text="@brandGroup.Key" Expanded="true">
                @{
                    var brandItems = brandGroup.ToList();
                }

                <MudTable T="InventoryItem"
                          Items="brandItems"
                          Hover="true"
                          Striped="true"
                          Sortable="true"
                          RowsPerPage="25">

                    <HeaderContent>
                        <MudTh>Image</MudTh>

                        <MudTh>
                            <MudTableSortLabel T="InventoryItem"
                                               SortBy="@(x => x.MappedBrick.Name)">
                                Brick
                            </MudTableSortLabel>
                        </MudTh>

                        <MudTh>
                            <MudTableSortLabel T="InventoryItem"
                                               SortBy="@(x => x.BrickColor.Name)">
                                Color
                            </MudTableSortLabel>
                        </MudTh>

                        <MudTh>
                            <MudTableSortLabel T="InventoryItem"
                                               SortBy="@(x => x.Brand)">
                                Brand
                            </MudTableSortLabel>
                        </MudTh>

                        <MudTh>
                            <MudTableSortLabel T="InventoryItem"
                                               SortBy="@(x => BrandIdSelector(x))">
                                Brand ID
                            </MudTableSortLabel>
                        </MudTh>

                        <MudTh>
                            <MudTableSortLabel T="InventoryItem"
                                               SortBy="@(x => x.Quantity)">
                                Quantity
                            </MudTableSortLabel>
                        </MudTh>

                        <MudTh>Actions</MudTh>
                    </HeaderContent>

                    <RowTemplate>
                        <MudTd DataLabel="Image">
                            @{
                                var imgUrl = ImageService.GetMappedBrickImagePath(context.MappedBrick);
                                var overlay = BrickColorHelper.GetHexForColor(context.BrickColor.Name);
                            }
                            @if (!string.IsNullOrWhiteSpace(imgUrl) && imgUrl != "/placeholder-image.png" && overlay != null)
                            {
                                <div class="brick" style="--brick-color:@overlay">
                                    <img src="@imgUrl"
                                         alt=""
                                         class="brick-img"/>
                                </div>
                            }
                            else if (!string.IsNullOrWhiteSpace(imgUrl) && imgUrl != "/placeholder-image.png")
                            {
                                <img src="@imgUrl"
                                     alt=""
                                     class="brick-img"/>
                            }
                            else
                            {
                                <span
                                    style="display:inline-block;width:48px;height:48px;line-height:48px;text-align:center;color:#bbb;font-size:0.8em;">
                                    No image
                                </span>
                            }
                        </MudTd>

                        <MudTd DataLabel="Brick">
                            <div class="d-flex align-center">
                                @context.MappedBrick.Name

                                @if (_wantedListNamesByItem.TryGetValue((context.MappedBrickId, context.BrickColorId), out var wantedLists) && wantedLists.Any())
                                {
                                    <MudTooltip Text="@($"In Wanted Lists: {string.Join(", ", wantedLists)}")">
                                        <MudIcon Icon="@Icons.Material.Filled.Bookmark"
                                                 Color="Color.Info"
                                                 Size="Size.Small"
                                                 Class="ml-2"/>
                                    </MudTooltip>
                                }
                            </div>
                        </MudTd>

                        <MudTd DataLabel="Color">@context.BrickColor.Name</MudTd>
                        <MudTd DataLabel="Brand">@context.Brand</MudTd>

                        <MudTd DataLabel="Brand ID">
                            @if (context.Brand.ToLower() == "lego")
                            {
                                @context.MappedBrick.LegoPartNum
                            }
                            else if (context.Brand.ToLower() == "bluebrixx")
                            {
                                @context.MappedBrick.BluebrixxPartNum
                            }
                            else if (context.Brand.ToLower() == "cada")
                            {
                                @context.MappedBrick.CadaPartNum
                            }
                            else if (context.Brand.ToLower() == "pantasy")
                            {
                                @context.MappedBrick.PantasyPartNum
                            }
                            else if (context.Brand.ToLower() == "mould king")
                            {
                                @context.MappedBrick.MouldKingPartNum
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </MudTd>

                        <MudTd DataLabel="Quantity">@context.Quantity</MudTd>

                        <MudTd DataLabel="Actions">
                            <MudIconButton Size="Size.Small"
                                           Variant="Variant.Outlined"
                                           Color="Color.Primary"
                                           Icon="@Icons.Material.Filled.Edit"
                                           OnClick="@(() => OpenEditDialog(context.Id, context.Quantity, context.BrickColorId))">
                            </MudIconButton>
                            <MudIconButton Size="Size.Small"
                                           Variant="Variant.Outlined"
                                           Color="Color.Error"
                                           Icon="@Icons.Material.Filled.Delete"
                                           OnClick="@((MouseEventArgs _) => OpenDeleteDialog(context.Id))">
                            </MudIconButton>
                        </MudTd>
                    </RowTemplate>

                    <PagerContent>
                        <!-- Pro Brand-Tabelle eigener Pager -->
                        <MudTablePager PageSizeOptions="new[] { 25 }"/>
                    </PagerContent>

                </MudTable>
            </MudExpansionPanel>
        }
    </MudExpansionPanels>

    <style>
        .brick {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 56px;
            min-width: 56px;
            min-height: 56px;
            box-sizing: border-box;
        }

        .brick-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
            border: 2px solid #ccc;
            background: #fff;
            display: block;
        }

        .brick::after {
            content: "";
            position: absolute;
            right: 1px;
            bottom: 0;
            width: 0;
            height: 0;
            border-bottom: 28px solid var(--brick-color, transparent);
            border-left: 28px solid transparent;
            border-radius: 0 0 4px 0;
            z-index: 2;
            pointer-events: none;
        }
    </style>
}