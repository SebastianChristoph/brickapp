@page "/myinventory"

@using brickisbrickapp.Services
@using brickisbrickapp.Data.Entities
@using brickisbrickapp.Components.Dialogs
@using brickisbrickapp.Helpers
@using MudBlazor

@inject UserService UserService
@inject InventoryService InventoryService
@inject IDialogService DialogService
@inject NavigationManager Nav

<PageTitle>My Inventory</PageTitle>

<MudText Typo="Typo.h5" GutterBottom="true">
    @(_username is null ? "Welcome to BrickIsBrick!" : $"Hello, {_username}")
</MudText>

<MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="OpenDeleteAllDialog" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.Delete" /> Delete entire inventory
</MudButton>

<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@OpenAddItemDialog" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-2" />
    Add item
</MudButton>

@if (!_authChecked)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (!_isAuth)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (items is null)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (items.Count == 0)
{
    <MudText Typo="Typo.body1">
        You do not have any items in your inventory yet.
    </MudText>
}
else
{
    var grouped = items
        .GroupBy(i => i.Brand)
        .OrderBy(g => g.Key)
        .ToList();

    <MudExpansionPanels>
        @foreach (var brandGroup in grouped)
        {
            <MudExpansionPanel Text="@brandGroup.Key">
                @{
                    List<InventoryItem> brandItems = brandGroup.ToList();
                }

                <MudTable T="InventoryItem"
                          Items="brandItems"
                          Hover="true"
                          Striped="true"
                          Sortable="true">

                    <HeaderContent>
                        <MudTh>
                            <MudTableSortLabel T="InventoryItem"
                                               SortBy="@(x => x.MappedBrick?.Name ?? string.Empty)">
                                Brick
                            </MudTableSortLabel>
                        </MudTh>

                        <MudTh>
                            <MudTableSortLabel T="InventoryItem"
                                               SortBy="@(x => x.BrickColor?.Name ?? string.Empty)">
                                Color
                            </MudTableSortLabel>
                        </MudTh>

                        <MudTh>
                            <MudTableSortLabel T="InventoryItem"
                                               SortBy="@(x => x.Brand ?? string.Empty)">
                                Brand
                            </MudTableSortLabel>
                        </MudTh>

                        <MudTh>
                            <MudTableSortLabel T="InventoryItem"
                                               SortBy="@(x => BrandIdSelector(x))">
                                Brand ID
                            </MudTableSortLabel>
                        </MudTh>

                        <MudTh>
                            <MudTableSortLabel T="InventoryItem"
                                               SortBy="@(x => x.Quantity)">
                                Quantity
                            </MudTableSortLabel>
                        </MudTh>

                        <MudTh>
                            Image
                        </MudTh>

                        <MudTh>
                            Actions
                        </MudTh>
                    </HeaderContent>

                    <RowTemplate>
                        <MudTd DataLabel="Brick">@context.MappedBrick?.Name</MudTd>
                        <MudTd DataLabel="Color">@context.BrickColor?.Name</MudTd>
                        <MudTd DataLabel="Brand">@context.Brand</MudTd>
                        <MudTd DataLabel="Brand ID">
                            @if (context.Brand?.ToLower() == "lego")
                            {
                                @context.MappedBrick?.LegoPartNum
                            }
                            else if (context.Brand?.ToLower() == "bluebrixx")
                            {
                                @context.MappedBrick?.BbPartNum
                            }
                            else if (context.Brand?.ToLower() == "cada")
                            {
                                @context.MappedBrick?.CadaPartNum
                            }
                            else if (context.Brand?.ToLower() == "pantasy")
                            {
                                @context.MappedBrick?.PantasyPartNum
                            }
                            else if (context.Brand?.ToLower() == "mould king")
                            {
                                @context.MappedBrick?.MouldKingPartNum
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </MudTd>
                        <MudTd DataLabel="Quantity">@context.Quantity</MudTd>
                        <MudTd DataLabel="Image">
                            @{
                                var partNum = context.MappedBrick?.LegoPartNum ?? "";
                                var url = _partImageUrls.TryGetValue(partNum, out var u) ? u : null;
                                var placeholder = brickisbrickapp.Services.RebrickablePartImageService.PlaceholderUrl;
                                var imgUrl = !string.IsNullOrWhiteSpace(url) ? url : placeholder;
                                var overlay = BrickColorHelper.GetHexForColor(context.BrickColor?.Name);
                            }
                            @if (overlay != null)
                            {
                                <div class="brick" style="--brick-overlay:@overlay">
                                    <img src="@imgUrl"
                                         alt=""
                                         style="max-width:48px;max-height:48px;border-radius:4px;border:1px solid #ccc;"
                                         onerror="if(this.src!== '@placeholder'){this.src='@placeholder';this.style.opacity='0.5';}" />
                                </div>
                            }
                            else
                            {
                                <img src="@imgUrl"
                                     alt=""
                                     style="max-width:48px;max-height:48px;border-radius:4px;border:1px solid #ccc;"
                                     onerror="if(this.src!== '@placeholder'){this.src='@placeholder';this.style.opacity='0.5';}" />
                            }
                        </MudTd>
                        <MudTd DataLabel="Actions">
                            <MudButton Size="Size.Small"
                                       Variant="Variant.Outlined"
                                       Color="Color.Primary"
                                       OnClick="@((MouseEventArgs e) => OpenEditDialog(context.Id, context.Quantity))">
                                Edit
                            </MudButton>
                            <MudButton Size="Size.Small"
                                       Variant="Variant.Outlined"
                                       Color="Color.Error"
                                       OnClick="@((MouseEventArgs e) => OpenDeleteDialog(context.Id))">
                                Delete
                            </MudButton>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudExpansionPanel>
        }
    </MudExpansionPanels>

    <style>
        .brick {
            position: relative;
            display: inline-block;
            isolation: isolate;
        }

        .brick img {
            display: block;
        }

        .brick::after {
            content: "";
            position: absolute;
            inset: 0;
            background: var(--brick-overlay, transparent);
            mix-blend-mode: multiply;
            pointer-events: none;
            border-radius: 4px;
        }
    </style>
}

@code {
    private Dictionary<string, string> _partImageUrls = new();
    private string? _username;
    private List<InventoryItem>? items;
    private bool _authChecked;
    private bool _isAuth;

    // Selector for brand specific part number
    private static string BrandIdSelector(InventoryItem i)
    {
        var brand = i.Brand?.ToLowerInvariant();
        return brand switch
        {
            "lego"       => i.MappedBrick?.LegoPartNum ?? string.Empty,
            "bluebrixx"  => i.MappedBrick?.BbPartNum ?? string.Empty,
            "cada"       => i.MappedBrick?.CadaPartNum ?? string.Empty,
            "pantasy"    => i.MappedBrick?.PantasyPartNum ?? string.Empty,
            "mould king" => i.MappedBrick?.MouldKingPartNum ?? string.Empty,
            _            => string.Empty
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _authChecked)
            return;

        _authChecked = true;

        _isAuth = await UserService.IsAuthenticatedAsync();

        if (!_isAuth)
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        _username = await UserService.GetUsernameAsync();
        items = await InventoryService.GetCurrentUserInventoryAsync();

        if (items != null && items.Any())
        {
            var partNumsToLoad = items
                .Select(i => i.MappedBrick?.LegoPartNum)
                .Where(p => !string.IsNullOrEmpty(p) && !_partImageUrls.ContainsKey(p!))
                .Distinct()
                .Select(p => p!)
                .ToList();

            if (partNumsToLoad.Count > 0)
            {
                var imageService = new brickisbrickapp.Services.RebrickablePartImageService(new HttpClient());
                var urls = await imageService.GetPartImageUrlsBatchAsync(partNumsToLoad);

                foreach (var kv in urls)
                    _partImageUrls[kv.Key] = kv.Value;
            }
        }

        StateHasChanged();
    }

    private async Task OpenEditDialog(int itemId, int currentQuantity)
    {
        var parameters = new DialogParameters<EditInventoryDialog>
        {
            { x => x.ItemId, itemId },
            { x => x.CurrentQuantity, currentQuantity }
        };

        var dialog = await DialogService.ShowAsync<EditInventoryDialog>("Edit quantity", parameters);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            items = await InventoryService.GetCurrentUserInventoryAsync();
            StateHasChanged();
        }
    }

    private async Task OpenDeleteDialog(int itemId)
    {
        var parameters = new DialogParameters();
        var dialog = await DialogService.ShowAsync<DeleteConfirmDialog>("Delete item?", parameters);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is bool confirmed && confirmed)
        {
            await InventoryService.DeleteInventoryItemAsync(itemId);
            items = await InventoryService.GetCurrentUserInventoryAsync();
            StateHasChanged();
        }
    }

    private async Task OpenAddItemDialog()
    {
        var dialog = await DialogService.ShowAsync<AddInventoryItemDialog>("Add item");
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            items = await InventoryService.GetCurrentUserInventoryAsync();
            StateHasChanged();
        }
    }

    private async Task OpenDeleteAllDialog()
    {
        var parameters = new DialogParameters();
        var dialog = await DialogService.ShowAsync<DeleteConfirmDialog>("Really delete entire inventory?", parameters);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is bool confirmed && confirmed)
        {
            await InventoryService.DeleteAllInventoryItemsAsync();
            items = await InventoryService.GetCurrentUserInventoryAsync();
            StateHasChanged();
        }
    }
}
