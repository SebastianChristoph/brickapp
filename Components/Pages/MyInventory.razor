@page "/myinventory"

@using brickapp.Data.Services
@using brickapp.Data.Entities
@using brickapp.Components.Dialogs
@using brickapp.Helpers
@using MudBlazor

@inject brickapp.Data.Services.UserService UserService
@inject brickapp.Data.Services.InventoryService InventoryService
@inject IDialogService DialogService
@inject NavigationManager Nav
@inject brickapp.Data.Services.ImageService ImageService
@inject brickapp.Data.Services.NotificationService NotificationService
@inject brickapp.Data.Services.WantedListService WantedListService

<PageTitle>My Inventory</PageTitle>
<MudText Typo="Typo.h4" GutterBottom="true">My Inventory</MudText>

<MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2" Style="margin-bottom: 16px;">
    <MudButton StartIcon="@Icons.Material.Filled.Add"
               Variant="Variant.Filled"
               Color="Color.Primary"
               OnClick="@OpenAddItemDialog"
               Class="mb-4">
        Add item
    </MudButton>

    <MudButton StartIcon="@Icons.Material.Filled.Delete"
               Variant="Variant.Filled"
               Color="Color.Error"
               OnClick="OpenDeleteAllDialog"
               Class="mb-4">
        Delete entire inventory
    </MudButton>
</MudStack>

@if (!_authChecked)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (!_isAuth)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (items is null)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (items.Count == 0)
{
    <MudAlert Severity="Severity.Info" Typo="Typo.body1">
        You do not have any items in your inventory yet.
    </MudAlert>
}
else
{
    var grouped = items
        .GroupBy(i => i.Brand)
        .OrderBy(g => g.Key)
        .ToList();

    <MudExpansionPanels>
        @foreach (var brandGroup in grouped)
        {
            <MudExpansionPanel Text="@brandGroup.Key" Expanded="true">
                @{
                    List<InventoryItem> brandItems = brandGroup.ToList();
                }

                <MudTable T="InventoryItem"
                          Items="brandItems"
                          Hover="true"
                          Striped="true"
                          Sortable="true"
                          RowsPerPage="25">

                    <HeaderContent>
                        <MudTh>Image</MudTh>

                        <MudTh>
                            <MudTableSortLabel T="InventoryItem"
                                               SortBy="@(x => x.MappedBrick?.Name ?? string.Empty)">
                                Brick
                            </MudTableSortLabel>
                        </MudTh>

                        <MudTh>
                            <MudTableSortLabel T="InventoryItem"
                                               SortBy="@(x => x.BrickColor?.Name ?? string.Empty)">
                                Color
                            </MudTableSortLabel>
                        </MudTh>

                        <MudTh>
                            <MudTableSortLabel T="InventoryItem"
                                               SortBy="@(x => x.Brand ?? string.Empty)">
                                Brand
                            </MudTableSortLabel>
                        </MudTh>

                        <MudTh>
                            <MudTableSortLabel T="InventoryItem"
                                               SortBy="@(x => BrandIdSelector(x))">
                                Brand ID
                            </MudTableSortLabel>
                        </MudTh>

                        <MudTh>
                            <MudTableSortLabel T="InventoryItem"
                                               SortBy="@(x => x.Quantity)">
                                Quantity
                            </MudTableSortLabel>
                        </MudTh>

                        <MudTh>Actions</MudTh>
                    </HeaderContent>

                    <RowTemplate>
                        <MudTd DataLabel="Image">
                            @{
                                var imgUrl = ImageService.GetMappedBrickImagePath(context.MappedBrick);
                                var overlay = BrickColorHelper.GetHexForColor(context.BrickColor?.Name);
                            }
                            @if (!string.IsNullOrWhiteSpace(imgUrl) && imgUrl != "/placeholder-image.png" && overlay != null)
                            {
                                <div class="brick" style="--brick-color:@overlay">
                                    <img src="@imgUrl"
                                         alt=""
                                         class="brick-img"
                                         onerror="if(this.src!== '/placeholder-image.png'){this.src='/placeholder-image.png';this.style.opacity='0.5';}" />
                                </div>
                            }
                            else if (!string.IsNullOrWhiteSpace(imgUrl) && imgUrl != "/placeholder-image.png")
                            {
                                <img src="@imgUrl"
                                     alt=""
                                     class="brick-img"
                                     onerror="if(this.src!== '/placeholder-image.png'){this.src='/placeholder-image.png';this.style.opacity='0.5';}" />
                            }
                            else
                            {
                                <span style="display:inline-block;width:48px;height:48px;line-height:48px;text-align:center;color:#bbb;font-size:0.8em;">
                                    No image
                                </span>
                            }
                        </MudTd>

                       <MudTd DataLabel="Brick">
    <div class="d-flex align-center">
        @context.MappedBrick?.Name
        
        @if (_wantedListNamesByItem.TryGetValue((context.MappedBrickId, context.BrickColorId), out var wantedLists) && wantedLists.Any())
        {
            <MudTooltip Text="@($"In Wanted Lists: {string.Join(", ", wantedLists)}")">
                <MudIcon Icon="@Icons.Material.Filled.Bookmark" 
                         Color="Color.Info" 
                         Size="Size.Small" 
                         Class="ml-2" />
            </MudTooltip>
        }
    </div>
</MudTd>

                        <MudTd DataLabel="Color">@context.BrickColor?.Name</MudTd>
                        <MudTd DataLabel="Brand">@context.Brand</MudTd>

                        <MudTd DataLabel="Brand ID">
                            @if (context.Brand?.ToLower() == "lego")
                            {
                                @context.MappedBrick?.LegoPartNum
                            }
                            else if (context.Brand?.ToLower() == "bluebrixx")
                            {
                                @context.MappedBrick?.BluebrixxPartNum
                            }
                            else if (context.Brand?.ToLower() == "cada")
                            {
                                @context.MappedBrick?.CadaPartNum
                            }
                            else if (context.Brand?.ToLower() == "pantasy")
                            {
                                @context.MappedBrick?.PantasyPartNum
                            }
                            else if (context.Brand?.ToLower() == "mould king")
                            {
                                @context.MappedBrick?.MouldKingPartNum
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </MudTd>

                        <MudTd DataLabel="Quantity">@context.Quantity</MudTd>

                        <MudTd DataLabel="Actions">
                            <MudButton Size="Size.Small"
                                       Variant="Variant.Outlined"
                                       Color="Color.Primary"
                                       OnClick="@(() => OpenEditDialog(context.Id, context.Quantity, context.BrickColorId))">
                                Edit
                            </MudButton>
                            <MudButton Size="Size.Small"
                                       Variant="Variant.Outlined"
                                       Color="Color.Error"
                                       OnClick="@((MouseEventArgs e) => OpenDeleteDialog(context.Id))">
                                Delete
                            </MudButton>
                        </MudTd>
                    </RowTemplate>

                    <PagerContent>
                        <!-- Pro Brand-Tabelle eigener Pager -->
                        <MudTablePager PageSizeOptions="new int[] { 25 }" />
                    </PagerContent>

                </MudTable>
            </MudExpansionPanel>
        }
    </MudExpansionPanels>

    <style>
        .brick {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 56px;
            min-width: 56px;
            min-height: 56px;
            box-sizing: border-box;
        }

        .brick-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
            border: 2px solid #ccc;
            background: #fff;
            display: block;
        }

        .brick::after {
            content: "";
            position: absolute;
            right: .5px;
            bottom: 0px;
            width: 0;
            height: 0;
            border-bottom: 28px solid var(--brick-color, transparent);
            border-left: 28px solid transparent;
            border-radius: 0 0 4px 0;
            z-index: 2;
            pointer-events: none;
        }
    </style>
}

@code {
    private string? _username;
    private List<InventoryItem>? items;
    private bool _authChecked;
    private bool _isAuth;

    private static string BrandIdSelector(InventoryItem i)
    {
        var brand = i.Brand?.ToLowerInvariant();
        return brand switch
        {
            "lego"       => i.MappedBrick?.LegoPartNum ?? string.Empty,
            "bluebrixx"  => i.MappedBrick?.BluebrixxPartNum ?? string.Empty,
            "cada"       => i.MappedBrick?.CadaPartNum ?? string.Empty,
            "pantasy"    => i.MappedBrick?.PantasyPartNum ?? string.Empty,
            "mould king" => i.MappedBrick?.MouldKingPartNum ?? string.Empty,
            _            => string.Empty
        };
    }

    private Dictionary<(int, int), List<string>> _wantedListNamesByItem = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _authChecked)
            return;

        _authChecked = true;

        _isAuth = await UserService.IsAuthenticatedAsync();

        if (!_isAuth)
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        _username = await UserService.GetUsernameAsync();
        items = await InventoryService.GetCurrentUserInventoryAsync();

        var user = await UserService.GetCurrentUserAsync();
        if (user != null)
            _wantedListNamesByItem = await WantedListService.GetWantedListNamesByBrickAndColorAsync(user.Id);
        else
            _wantedListNamesByItem = new();

        StateHasChanged();
    }

    private async Task OpenEditDialog(int itemId, int currentQuantity, int currentColorId)
    {
        var parameters = new DialogParameters<EditItemDialog>
        {
            { x => x.CurrentQuantity, currentQuantity },
            { x => x.CurrentColorId, currentColorId }
        };

        var dialog = await DialogService.ShowAsync<EditItemDialog>("Edit item", parameters);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is EditItemDialogResult editResult)
        {
            // Update mit neuer Quantity und ColorId
            var success = await InventoryService.UpdateInventoryItemAsync(itemId, editResult.Quantity, editResult.ColorId);
            if (success)
            {
                items = await InventoryService.GetCurrentUserInventoryAsync();
                NotificationService.Success("Item updated successfully.");
                StateHasChanged();
            }
            else
            {
                NotificationService.Error("Failed to update item.");
            }
        }
    }

    private async Task OpenDeleteDialog(int itemId)
    {
        var parameters = new DialogParameters();
        var dialog = await DialogService.ShowAsync<DeleteConfirmDialog>("Delete item?", parameters);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is bool confirmed && confirmed)
        {
            await InventoryService.DeleteInventoryItemAsync(itemId);
            items = await InventoryService.GetCurrentUserInventoryAsync();
            StateHasChanged();
        }
    }

    private async Task OpenAddItemDialog()
    {
        var dialog = await DialogService.ShowAsync<AddInventoryItemDialog>("Add item");
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            items = await InventoryService.GetCurrentUserInventoryAsync();
            NotificationService.Success("Item added to inventory.");
            StateHasChanged();
        }
    }

    private async Task OpenDeleteAllDialog()
    {
        var parameters = new DialogParameters();
        var dialog = await DialogService.ShowAsync<DeleteConfirmDialog>("Really delete entire inventory?", parameters);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is bool confirmed && confirmed)
        {
            await InventoryService.DeleteAllInventoryItemsAsync();
            items = await InventoryService.GetCurrentUserInventoryAsync();
            StateHasChanged();
        }
    }
}
