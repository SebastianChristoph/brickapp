@page "/sets/{itemSetId:int}"
@using brickapp.Data.Entities
@using brickapp.Data.Services
@using brickapp.Helpers

@inject ItemSetService ItemSetService
@inject UserService UserService
@inject NavigationManager Nav
@inject InventoryService InventoryService
@inject IDialogService DialogService
@inject NotificationService NotificationService
@inject ImageService ImageService
@inject RequestService RequestService
@inject SetFavoritesService SetFavoritesService

<PageTitle>Set Details</PageTitle>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4">
        @_error

        @if (!string.IsNullOrWhiteSpace(_errorDetails))
        {
            <MudDivider Class="my-2"/>
            <MudText Typo="Typo.caption" Style="white-space:pre-wrap;">@_errorDetails</MudText>
        }
    </MudAlert>
}

@if (_loading)
{
    <MudStack Justify="Justify.Center" Spacing="2" Style="margin-bottom: 16px; margin-top:16px;">
        <MudText>Loading set details...</MudText>
        <MudProgressLinear Color="Color.Primary" Indeterminate="true"/>
    </MudStack>
}
else if (_itemSet is null)
{
    <MudAlert Severity="Severity.Error">Set was not found.</MudAlert>
    <MudButton Variant="Variant.Outlined" OnClick="@GoBack">Back</MudButton>
}
else
{
    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Start">
            @{
                var setImgUrl = ImageService.GetSetImagePath(_itemSet);
            }
            @if (!string.IsNullOrEmpty(setImgUrl) && setImgUrl != "/placeholder-image.png")
            {
                <div style="flex-shrink:0;">
                    <img src="@setImgUrl" alt="@_itemSet.Name"
                         style="height:200px; width:auto; object-fit:contain; border-radius:4px;"/>
                </div>
            }

            <MudStack Spacing="1" Style="flex: 1;">
                <MudText Typo="Typo.h4" GutterBottom="true">@_itemSet.Name</MudText>

                <MudText Typo="Typo.subtitle1">Brand: @_itemSet.Brand</MudText>

                <MudText Typo="Typo.subtitle2">Set Nr: @_itemSet.SetNum | Year: @_itemSet.Year</MudText>


            </MudStack>
        </MudStack>
    </MudPaper>

    <MudStack Row="true" Spacing="2" StretchItems="StretchItems.Start" Class="mb-4">
        <OwnershipProgress OwnedCount="@TotalOwned" TotalCount="@TotalNeeded"/>
        <MudSpacer/>



        <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Primary"
                   OnClick="@OpenAddSetDialog">
            Add Set items to Inventory
        </MudButton>

        <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Outlined" Color="Color.Primary"
                   OnClick="@OpenAddSetToWantedListDialog">
            Add Set items to Wanted List
        </MudButton>

        @if (_isFavorite)
        {
            <MudButton StartIcon="@Icons.Material.Filled.StarOutline" Variant="Variant.Outlined" Color="Color.Warning"
                       OnClick="@ToggleFavorite">
                Remove from favorites
            </MudButton>
        }
        else
        {
            <MudButton StartIcon="@Icons.Material.Filled.Star" Variant="Variant.Outlined" Color="Color.Warning"
                       OnClick="@ToggleFavorite">
                Add to favorites
            </MudButton>
        }
    </MudStack>

    <br/>

    <br/>


    <MudStack Row="true" Spacing="2" StretchItems="StretchItems.Start" Class="mb-4">
        <MudText Typo="Typo.h6" GutterBottom="true">Items in this set</MudText>

        <MudButton Variant="@(_showOnlyMissing ? Variant.Outlined : Variant.Filled)" Color="Color.Primary"
                   OnClick="@ShowAllItems" StartIcon="@Icons.Material.Filled.List" Class="ml-4">
            Show all items
        </MudButton>

        <MudButton Variant="@(_showOnlyMissing ? Variant.Filled : Variant.Outlined)" Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.FilterList" OnClick="@ShowOnlyMissingItems">
            Show only missing items
        </MudButton>
    </MudStack>

    <style>
        .brick {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 56px;
            min-width: 56px;
            min-height: 56px;
            box-sizing: border-box;
        }

        .brick-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
            border: 2px solid #ccc;
            background: #fff;
            display: block;
        }

        .brick::after {
            content: "";
            position: absolute;
            right: .5px;
            bottom: 0px;
            width: 0;
            height: 0;
            border-bottom: 28px solid var(--brick-color, transparent);
            border-left: 28px solid transparent;
            border-radius: 0 0 4px 0;
            z-index: 2;
            pointer-events: none;
        }
    </style>

    <MudTable @key="_tableKey" Items="@_tableItems" Page="_itemsPage" RowsPerPage="_itemsRowsPerPage"
              OnPageChanged="OnItemsPageChanged" OnRowsPerPageChanged="OnItemsRowsPerPageChanged"
              Sortable="true" T="ItemSetBrick">
        <HeaderContent>
            <MudTh>Actions</MudTh>
            <MudTh>Image</MudTh>

            <MudTh>
                <MudTableSortLabel T="ItemSetBrick"
                                   SortBy="@(x => x.MappedBrick.Name)">
                    Name
                </MudTableSortLabel>
            </MudTh>

            <MudTh>
                <MudTableSortLabel T="ItemSetBrick"
                                   SortBy="@(x => x.BrickColor.Name)">
                    Color
                </MudTableSortLabel>
            </MudTh>

            <MudTh>
                <MudTableSortLabel T="ItemSetBrick"
                                   SortBy="@(x => x.MappedBrick.LegoName ?? string.Empty)">
                    Lego
                </MudTableSortLabel>
            </MudTh>

            <MudTh>
                <MudTableSortLabel T="ItemSetBrick"
                                   SortBy="@(x => x.MappedBrick.BluebrixxName ?? string.Empty)">
                    BlueBrixx
                </MudTableSortLabel>
            </MudTh>

            <MudTh>
                <MudTableSortLabel T="ItemSetBrick"
                                   SortBy="@(x => x.MappedBrick.CadaName ?? string.Empty)">
                    Cada
                </MudTableSortLabel>
            </MudTh>

            <MudTh>
                <MudTableSortLabel T="ItemSetBrick"
                                   SortBy="@(x => x.MappedBrick.PantasyName ?? string.Empty)">
                    Pantasy
                </MudTableSortLabel>
            </MudTh>

            <MudTh>
                <MudTableSortLabel T="ItemSetBrick"
                                   SortBy="@(x => x.MappedBrick.MouldKingName ?? string.Empty)">
                    Mould King
                </MudTableSortLabel>
            </MudTh>

            <MudTh>
                <MudTableSortLabel T="ItemSetBrick"
                                   SortBy="@(x => x.MappedBrick.UnknownName ?? string.Empty)">
                    Unknown
                </MudTableSortLabel>
            </MudTh>

            <MudTh>
                <MudTableSortLabel T="ItemSetBrick"
                                   SortBy="@(x => x.Quantity)">
                    Quantity
                </MudTableSortLabel>
            </MudTh>

            <MudTh>Do you have this in your inventory?</MudTh>

        </HeaderContent>

        <RowTemplate>
            <MudTd>
                <MudStack Row="true" Spacing="1">
                    <MudTooltip Text="Add to Inventory">
                        <MudIconButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Success"
                                       OnClick="@(() => OpenAddInventoryDialog(context.MappedBrick))"
                                       Icon="@Icons.Material.Filled.Add">
                        </MudIconButton>
                    </MudTooltip>
                    <MudTooltip Text="Add to Wanted List">
                        <MudIconButton Icon="@Icons.Material.Filled.PlaylistAdd" Size="Size.Small"
                                       Variant="Variant.Filled" Color="Color.Primary"
                                       OnClick="@(() => OpenAddToWantedListDialog(context.MappedBrick))">
                        </MudIconButton>
                    </MudTooltip>
                </MudStack>
            </MudTd>
            <MudTd DataLabel="Image">
                @{
                    var imgUrl = ImageService.GetMappedBrickImagePath(context.MappedBrick);

                    var overlay = BrickColorHelper.GetHexForColor(context.BrickColor.Name);
                    var isPlaceholder = imgUrl == "/placeholder-image.png";
                }

                <MudStack Spacing="1" AlignItems="AlignItems.Center">
                    @if (isPlaceholder)
                    {
                        <MudButton Size="Size.Small"
                                   Variant="Variant.Text"
                                   Color="Color.Info"
                                   StartIcon="@Icons.Material.Filled.Upload"
                                   OnClick="@(() => OpenUploadImageDialog(context.MappedBrick))"
                                   Style="font-size:0.65rem;padding:2px 4px;">
                            Upload
                        </MudButton>
                    }

                    <div style="position:relative;display:inline-block;min-width:48px;min-height:48px;">
                        @if (!isPlaceholder)
                        {
                            if (overlay != null)
                            {
                                <div class="brick" style="--brick-color:@overlay">
                                    <img src="@imgUrl" alt="" class="brick-img"
                                         onerror="if(this.src!== '/placeholder-image.png'){this.src='/placeholder-image.png';this.style.opacity='0.5';}"/>
                                </div>
                            }
                            else
                            {
                                <img src="@imgUrl" alt=""
                                     style="max-width:48px;max-height:48px;border-radius:4px;border:1px solid #ccc;z-index:1;"
                                     onerror="if(this.src!== '/placeholder-image.png'){this.src='/placeholder-image.png';this.style.opacity='0.5';}"/>
                            }
                        }
                        else
                        {
                            <span
                                style="display:inline-block;width:48px;height:48px;line-height:48px;text-align:center;color:#bbb;font-size:0.8em;">
                                No image
                            </span>
                        }
                    </div>
                </MudStack>
            </MudTd>

            <MudTd DataLabel="Standard Name">@context.MappedBrick.Name</MudTd>
            <MudTd DataLabel="Color">@context.BrickColor.Name</MudTd>

            <MudTd DataLabel="Lego">
                @if (!string.IsNullOrWhiteSpace(context.MappedBrick.LegoName))
                {
                    @context.MappedBrick.LegoName
                    @if (!string.IsNullOrWhiteSpace(context.MappedBrick.LegoPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><br/>[@context.MappedBrick.LegoPartNum]
                        </MudText>
                    }
                }
                else
                {
                    var legoRequest = context.MappedBrick.MappingRequests.FirstOrDefault(r => r.Brand == "Lego" && r.Status == MappingRequestStatus.Pending);
                    if (legoRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping pending</MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                                   OnClick="@(() => OpenHelpMappingDialog(context.MappedBrick, "Lego"))">Help Mapping
                        </MudButton>
                    }
                }
            </MudTd>

            <MudTd DataLabel="BlueBrixx">
                @if (!string.IsNullOrWhiteSpace(context.MappedBrick.BluebrixxName))
                {
                    @context.MappedBrick.BluebrixxName
                    @if (!string.IsNullOrWhiteSpace(context.MappedBrick.BluebrixxPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            <br/>[@context.MappedBrick.BluebrixxPartNum]
                        </MudText>
                    }
                    else
                    {
                        var bbPartRequest = context.MappedBrick.MappingRequests.FirstOrDefault(r => r.Brand == "BlueBrixx" && r.Status == MappingRequestStatus.Pending && !string.IsNullOrWhiteSpace(r.MappingItemId));
                        if (bbPartRequest != null)
                        {
                            <br/>
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning">Part# pending</MudChip>
                        }
                        else
                        {
                            <br/>
                            <MudLink
                                OnClick="@(() => OpenHelpMappingDialogForPartNumber(context.MappedBrick, "BlueBrixx"))"
                                Typo="Typo.caption" Color="Color.Info">(Help mapping the part number)
                            </MudLink>
                        }
                    }
                }
                else
                {
                    var bluebrixxRequest = context.MappedBrick.MappingRequests.FirstOrDefault(r => r.Brand == "BlueBrixx" && r.Status == MappingRequestStatus.Pending);
                    if (bluebrixxRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping pending</MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                                   OnClick="@(() => OpenHelpMappingDialog(context.MappedBrick, "BlueBrixx"))">Help
                            Mapping
                        </MudButton>
                    }
                }
            </MudTd>

            <MudTd DataLabel="Cada">
                @if (!string.IsNullOrWhiteSpace(context.MappedBrick.CadaName))
                {
                    @context.MappedBrick.CadaName
                    @if (!string.IsNullOrWhiteSpace(context.MappedBrick.CadaPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><br/>[@context.MappedBrick.CadaPartNum]
                        </MudText>
                    }
                    else
                    {
                        var cadaPartRequest = context.MappedBrick.MappingRequests.FirstOrDefault(r => r.Brand == "Cada" && r.Status == MappingRequestStatus.Pending && !string.IsNullOrWhiteSpace(r.MappingItemId));
                        if (cadaPartRequest != null)
                        {
                            <br/>
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning">Part# pending</MudChip>
                        }
                        else
                        {
                            <br/>
                            <MudLink OnClick="@(() => OpenHelpMappingDialogForPartNumber(context.MappedBrick, "Cada"))"
                                     Typo="Typo.caption" Color="Color.Info">(Help mapping the part number)
                            </MudLink>
                        }
                    }
                }
                else
                {
                    var cadaRequest = context.MappedBrick.MappingRequests.FirstOrDefault(r => r.Brand == "Cada" && r.Status == MappingRequestStatus.Pending);
                    if (cadaRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping pending</MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                                   OnClick="@(() => OpenHelpMappingDialog(context.MappedBrick, "Cada"))">Help Mapping
                        </MudButton>
                    }
                }
            </MudTd>

            <MudTd DataLabel="Pantasy">
                @if (!string.IsNullOrWhiteSpace(context.MappedBrick.PantasyName))
                {
                    @context.MappedBrick.PantasyName
                    @if (!string.IsNullOrWhiteSpace(context.MappedBrick.PantasyPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><br/>[@context.MappedBrick.PantasyPartNum]
                        </MudText>
                    }
                    else
                    {
                        var pantasyPartRequest = context.MappedBrick.MappingRequests.FirstOrDefault(r => r.Brand == "Pantasy" && r.Status == MappingRequestStatus.Pending && !string.IsNullOrWhiteSpace(r.MappingItemId));
                        if (pantasyPartRequest != null)
                        {
                            <br/>
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning">Part# pending</MudChip>
                        }
                        else
                        {
                            <br/>
                            <MudLink
                                OnClick="@(() => OpenHelpMappingDialogForPartNumber(context.MappedBrick, "Pantasy"))"
                                Typo="Typo.caption" Color="Color.Info">(Help mapping the part number)
                            </MudLink>
                        }
                    }
                }
                else
                {
                    var pantasyRequest = context.MappedBrick.MappingRequests.FirstOrDefault(r => r.Brand == "Pantasy" && r.Status == MappingRequestStatus.Pending);
                    if (pantasyRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping pending</MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                                   OnClick="@(() => OpenHelpMappingDialog(context.MappedBrick, "Pantasy"))">Help Mapping
                        </MudButton>
                    }
                }
            </MudTd>

            <MudTd DataLabel="Mould King">
                @if (!string.IsNullOrWhiteSpace(context.MappedBrick.MouldKingName))
                {
                    @context.MappedBrick.MouldKingName
                    @if (!string.IsNullOrWhiteSpace(context.MappedBrick.MouldKingPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            <br/>[@context.MappedBrick.MouldKingPartNum]
                        </MudText>
                    }
                    else
                    {
                        var mkPartRequest = context.MappedBrick.MappingRequests.FirstOrDefault(r => r.Brand == "Mould King" && r.Status == MappingRequestStatus.Pending && !string.IsNullOrWhiteSpace(r.MappingItemId));
                        if (mkPartRequest != null)
                        {
                            <br/>
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning">Part# pending</MudChip>
                        }
                        else
                        {
                            <br/>
                            <MudLink
                                OnClick="@(() => OpenHelpMappingDialogForPartNumber(context.MappedBrick, "Mould King"))"
                                Typo="Typo.caption" Color="Color.Info">(Help mapping the part number)
                            </MudLink>
                        }
                    }
                }
                else
                {
                    var mkRequest = context.MappedBrick.MappingRequests.FirstOrDefault(r => r.Brand == "Mould King" && r.Status == MappingRequestStatus.Pending);
                    if (mkRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping pending</MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                                   OnClick="@(() => OpenHelpMappingDialog(context.MappedBrick, "Mould King"))">Help
                            Mapping
                        </MudButton>
                    }
                }
            </MudTd>

            <MudTd DataLabel="Unknown">
                @if (!string.IsNullOrWhiteSpace(context.MappedBrick.UnknownName))
                {
                    @context.MappedBrick.UnknownName
                    @if (!string.IsNullOrWhiteSpace(context.MappedBrick.UnknownPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><br/>[@context.MappedBrick.UnknownPartNum]
                        </MudText>
                    }
                    else
                    {
                        var unknownPartRequest = context.MappedBrick.MappingRequests.FirstOrDefault(r => r.Brand == "Unknown" && r.Status == MappingRequestStatus.Pending && !string.IsNullOrWhiteSpace(r.MappingItemId));
                        if (unknownPartRequest != null)
                        {
                            <br/>
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning">Part# pending</MudChip>
                        }
                        else
                        {
                            <br/>
                            <MudLink
                                OnClick="@(() => OpenHelpMappingDialogForPartNumber(context.MappedBrick, "Unknown"))"
                                Typo="Typo.caption" Color="Color.Info">(Help mapping the part number)
                            </MudLink>
                        }
                    }
                }
                else
                {
                    var unknownRequest = context.MappedBrick.MappingRequests.FirstOrDefault(r => r.Brand == "Unknown" && r.Status == MappingRequestStatus.Pending);
                    if (unknownRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping pending</MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                                   OnClick="@(() => OpenHelpMappingDialog(context.MappedBrick, "Unknown"))">Help Mapping
                        </MudButton>
                    }
                }
            </MudTd>

            <MudTd DataLabel="Quantity">@context.Quantity</MudTd>

            <MudTd DataLabel="Do you own?">
                @{
                    var key = (context.MappedBrickId, context.BrickColorId);
                    if (_ownedByBrand.TryGetValue(key, out var brands) && brands.Count > 0)
                    {
                        foreach (var brand in brands)
                        {
                            <MudChip T="string" Color="Color.Primary"
                                     Class="mr-1 mb-1">@brand.Key: @brand.Value</MudChip>
                        }
                    }
                    else
                    {
                        <MudTooltip Text="You do not own this item in your inventory.">
                            <MudIcon Icon="@Icons.Material.Filled.NoSim" Title="Favorite"/>
                        </MudTooltip>
                    }
                }
            </MudTd>


        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSizeOptions="new[] { 25, 50, 100, 250 }"/>
        </PagerContent>
    </MudTable>

    <MudButton Class="mt-4" Variant="Variant.Outlined" OnClick="@GoBack">
        Zur√ºck
    </MudButton>
}

@code {

    // Table state (force rebuild on filter changes)

}