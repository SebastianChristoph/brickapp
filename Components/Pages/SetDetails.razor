@using Helpers
@page "/sets/{itemSetId:int}"

@using brickapp.Data.Services
@using brickapp.Data.Entities
@using MudBlazor
@using MudBlazor.Services
@using Components.Pages
@using Components.Dialogs

@inject brickapp.Data.Services.ItemSetService ItemSetService
@inject brickapp.Data.Services.UserService UserService
@inject NavigationManager Nav
@inject brickapp.Data.Services.InventoryService InventoryService
@inject IDialogService DialogService
@inject brickapp.Data.Services.NotificationService NotificationService
@inject brickapp.Data.Services.ImageService ImageService
@inject brickapp.Data.Services.LoadingService LoadingService
@inject brickapp.Data.Services.MappedBrickService BrickService
@inject brickapp.Data.Services.RequestService RequestService
@inject brickapp.Data.Services.SetFavoritesService SetFavoritesService

<PageTitle>Set Details</PageTitle>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4">
        @_error

        @if (!string.IsNullOrWhiteSpace(_errorDetails))
        {
            <MudDivider Class="my-2" />
            <MudText Typo="Typo.caption" Style="white-space:pre-wrap;">@_errorDetails</MudText>
        }
    </MudAlert>
}

@if (_loading)
{
    <MudStack Justify="Justify.Center" Spacing="2" Style="margin-bottom: 16px; margin-top:16px;">
        <MudText>Loading set details...</MudText>
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    </MudStack>
}
else if (_itemSet is null)
{
    <MudAlert Severity="Severity.Error">Set was not found.</MudAlert>
    <MudButton Variant="Variant.Outlined" OnClick="@GoBack">Back</MudButton>
}
else
{
    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Start">
            @{
                var setImgUrl = ImageService.GetSetImagePath(_itemSet);
            }
            @if (!string.IsNullOrEmpty(setImgUrl) && setImgUrl != "/placeholder-image.png")
            {
                <div style="flex-shrink:0;">
                    <img src="@setImgUrl" alt="@_itemSet.Name"
                        style="height:200px; width:auto; object-fit:contain; border-radius:4px;" />
                </div>
            }

            <MudStack Spacing="1" Style="flex: 1;">
                <MudText Typo="Typo.h4" GutterBottom="true">@_itemSet.Name</MudText>

                <MudText Typo="Typo.subtitle1">Brand: @_itemSet.Brand</MudText>

                <MudText Typo="Typo.subtitle2">Set Nr: @_itemSet.SetNum | Year: @_itemSet.Year</MudText>


            </MudStack>
        </MudStack>
    </MudPaper>

    <MudStack Row="true" Spacing="2" StretchItems="StretchItems.Start" Class="mb-4">
        <OwnershipProgress OwnedCount="@TotalOwned" TotalCount="@TotalNeeded" />
        <MudSpacer />
        
      

        <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Primary"
            OnClick="@OpenAddSetDialog">
            Add Set items to Inventory
        </MudButton>

        <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Outlined" Color="Color.Primary"
            OnClick="@OpenAddSetToWantedListDialog">
            Add Set items to Wanted List
        </MudButton>

          @if (_isFavorite)
        {
            <MudButton StartIcon="@Icons.Material.Filled.StarOutline" Variant="Variant.Outlined" Color="Color.Warning"
                OnClick="@ToggleFavorite">
                Remove from favorites
            </MudButton>
        }
        else
        {
            <MudButton StartIcon="@Icons.Material.Filled.Star" Variant="Variant.Outlined" Color="Color.Warning"
                OnClick="@ToggleFavorite">
                Add to favorites
            </MudButton>
        }
    </MudStack>

    <br />

    <br />


    <MudStack Row="true" Spacing="2" StretchItems="StretchItems.Start" Class="mb-4">
        <MudText Typo="Typo.h6" GutterBottom="true">Items in this set</MudText>

        <MudButton Variant="@(_showOnlyMissing? Variant.Outlined: Variant.Filled)" Color="Color.Primary"
            OnClick="@ShowAllItems" StartIcon="@Icons.Material.Filled.List" Class="ml-4">
            Show all items
        </MudButton>

        <MudButton Variant="@(_showOnlyMissing? Variant.Filled: Variant.Outlined)" Color="Color.Primary"
            StartIcon="@Icons.Material.Filled.FilterList" OnClick="@ShowOnlyMissingItems">
            Show only missing items
        </MudButton>
    </MudStack>

    <style>
        .brick {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 56px;
            min-width: 56px;
            min-height: 56px;
            box-sizing: border-box;
        }

        .brick-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
            border: 2px solid #ccc;
            background: #fff;
            display: block;
        }

        .brick::after {
            content: "";
            position: absolute;
            right: .5px;
            bottom: 0px;
            width: 0;
            height: 0;
            border-bottom: 28px solid var(--brick-color, transparent);
            border-left: 28px solid transparent;
            border-radius: 0 0 4px 0;
            z-index: 2;
            pointer-events: none;
        }
    </style>

    <MudTable @key="_tableKey" Items="@_tableItems" Page="_itemsPage" RowsPerPage="_itemsRowsPerPage"
        OnPageChanged="OnItemsPageChanged" OnRowsPerPageChanged="OnItemsRowsPerPageChanged">
        <HeaderContent>
            <MudTh>Image</MudTh>
            <MudTh>Name</MudTh>
            <MudTh>Color</MudTh>
            <MudTh>Lego</MudTh>
            <MudTh>BlueBrixx</MudTh>
            <MudTh>Cada</MudTh>
            <MudTh>Pantasy</MudTh>
            <MudTh>Mould King</MudTh>
            <MudTh>Unknown</MudTh>
            <MudTh>Quantity</MudTh>
            <MudTh>Do you have this in your inventory?</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd DataLabel="Image">
                @{
                    var imgUrl = context.MappedBrick != null
                                            ? ImageService.GetMappedBrickImagePath(context.MappedBrick)
                    : "/placeholder-image.png";

                    var overlay = BrickColorHelper.GetHexForColor(context.BrickColor?.Name);
                }

                <div style="position:relative;display:inline-block;min-width:48px;min-height:48px;">
                    @if (!string.IsNullOrWhiteSpace(imgUrl) && imgUrl != "/placeholder-image.png")
                    {
                        if (overlay != null)
                        {
                            <div class="brick" style="--brick-color:@overlay">
                                <img src="@imgUrl" alt="" class="brick-img"
                                    onerror="if(this.src!== '/placeholder-image.png'){this.src='/placeholder-image.png';this.style.opacity='0.5';}" />
                            </div>
                        }
                        else
                        {
                            <img src="@imgUrl" alt=""
                                style="max-width:48px;max-height:48px;border-radius:4px;border:1px solid #ccc;z-index:1;"
                                onerror="if(this.src!== '/placeholder-image.png'){this.src='/placeholder-image.png';this.style.opacity='0.5';}" />
                        }
                    }
                    else
                    {
                        <span
                            style="display:inline-block;width:48px;height:48px;line-height:48px;text-align:center;color:#bbb;font-size:0.8em;">
                            No image
                        </span>
                    }
                </div>
            </MudTd>

            <MudTd DataLabel="Standard Name">@context.MappedBrick?.Name</MudTd>
            <MudTd DataLabel="Color">@context.BrickColor?.Name</MudTd>

            <MudTd DataLabel="Lego">
                @if (!string.IsNullOrWhiteSpace(context.MappedBrick?.LegoName))
                {
                    @context.MappedBrick.LegoName
                    @if (!string.IsNullOrWhiteSpace(context.MappedBrick.LegoPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><br />[@context.MappedBrick.LegoPartNum]</MudText>
                    }
                }
                else if (context.MappedBrick != null)
                {
                    var legoRequest = context.MappedBrick.MappingRequests?.FirstOrDefault(r => r.Brand == "Lego" && r.Status == MappingRequestStatus.Pending);
                    if (legoRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping pending</MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context.MappedBrick, "Lego"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>

            <MudTd DataLabel="BlueBrixx">
                @if (!string.IsNullOrWhiteSpace(context.MappedBrick?.BluebrixxName))
                {
                    @context.MappedBrick.BluebrixxName
                    @if (!string.IsNullOrWhiteSpace(context.MappedBrick.BluebrixxPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><br />[@context.MappedBrick.BluebrixxPartNum]</MudText>
                    }
                }
                else if (context.MappedBrick != null)
                {
                    var bluebrixxRequest = context.MappedBrick.MappingRequests?.FirstOrDefault(r => r.Brand == "BlueBrixx" && r.Status == MappingRequestStatus.Pending);
                    if (bluebrixxRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping pending</MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context.MappedBrick, "BlueBrixx"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>

            <MudTd DataLabel="Cada">
                @if (!string.IsNullOrWhiteSpace(context.MappedBrick?.CadaName))
                {
                    @context.MappedBrick.CadaName
                    @if (!string.IsNullOrWhiteSpace(context.MappedBrick.CadaPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><br />[@context.MappedBrick.CadaPartNum]</MudText>
                    }
                }
                else if (context.MappedBrick != null)
                {
                    var cadaRequest = context.MappedBrick.MappingRequests?.FirstOrDefault(r => r.Brand == "Cada" && r.Status == MappingRequestStatus.Pending);
                    if (cadaRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping pending</MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context.MappedBrick, "Cada"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>

            <MudTd DataLabel="Pantasy">
                @if (!string.IsNullOrWhiteSpace(context.MappedBrick?.PantasyName))
                {
                    @context.MappedBrick.PantasyName
                    @if (!string.IsNullOrWhiteSpace(context.MappedBrick.PantasyPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><br />[@context.MappedBrick.PantasyPartNum]</MudText>
                    }
                }
                else if (context.MappedBrick != null)
                {
                    var pantasyRequest = context.MappedBrick.MappingRequests?.FirstOrDefault(r => r.Brand == "Pantasy" && r.Status == MappingRequestStatus.Pending);
                    if (pantasyRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping pending</MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context.MappedBrick, "Pantasy"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>

            <MudTd DataLabel="Mould King">
                @if (!string.IsNullOrWhiteSpace(context.MappedBrick?.MouldKingName))
                {
                    @context.MappedBrick.MouldKingName
                    @if (!string.IsNullOrWhiteSpace(context.MappedBrick.MouldKingPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><br />[@context.MappedBrick.MouldKingPartNum]</MudText>
                    }
                }
                else if (context.MappedBrick != null)
                {
                    var mkRequest = context.MappedBrick.MappingRequests?.FirstOrDefault(r => r.Brand == "Mould King" && r.Status == MappingRequestStatus.Pending);
                    if (mkRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping pending</MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context.MappedBrick, "Mould King"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>

            <MudTd DataLabel="Unknown">
                @if (!string.IsNullOrWhiteSpace(context.MappedBrick?.UnknownName))
                {
                    @context.MappedBrick.UnknownName
                    @if (!string.IsNullOrWhiteSpace(context.MappedBrick.UnknownPartNum))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><br />[@context.MappedBrick.UnknownPartNum]</MudText>
                    }
                }
                else if (context.MappedBrick != null)
                {
                    var unknownRequest = context.MappedBrick.MappingRequests?.FirstOrDefault(r => r.Brand == "Unknown" && r.Status == MappingRequestStatus.Pending);
                    if (unknownRequest != null)
                    {
                        <MudChip T="string" Color="Color.Warning">Mapping pending</MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                            OnClick="@(() => OpenHelpMappingDialog(context.MappedBrick, "Unknown"))">Help Mapping</MudButton>
                    }
                }
            </MudTd>

            <MudTd DataLabel="Quantity">@context.Quantity</MudTd>

            <MudTd DataLabel="Do you own?">
                @{
                    var key = (context.MappedBrickId, context.BrickColorId);
                    if (_ownedByBrand.TryGetValue(key, out var brands) && brands.Count > 0)
                    {
                        foreach (var brand in brands)
                        {
                            <MudChip T="string" Color="Color.Primary" Class="mr-1 mb-1">@brand.Key: @brand.Value</MudChip>
                        }
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Default">None</MudChip>
                    }
                }
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 25, 50, 100, 250 }" />
        </PagerContent>
    </MudTable>

    <MudButton Class="mt-4" Variant="Variant.Outlined" OnClick="@GoBack">
        Zur√ºck
    </MudButton>
}

@code {

    [Parameter] public int itemSetId { get; set; }

    private ItemSet? _itemSet;
    private UserItemSet? _userItemSet;
    private int _itemsPage = 0;
    private int _itemsRowsPerPage = 25;
    private bool _loading = true;
    private bool _showOnlyMissing = false;
    private bool _isFavorite = false;

    // Table state (force rebuild on filter changes)
    private Guid _tableKey = Guid.NewGuid();
    private List<ItemSetBrick> _tableItems = new();

    private Dictionary<(int BrickId, int ColorId), Dictionary<string, int>> _ownedByBrand = new();

    private enum BrickOwnershipState
    {
        None,
        Partial,
        Enough
    }

    private string? _error;
    private string? _errorDetails;

    private void SetError(Exception ex)
    {
        _error = $"An error happened: {ex.Message}";
        _errorDetails = ex.ToString();
    }

    protected int TotalNeeded => _itemSet?.Bricks?.Sum(b => b.Quantity) ?? 0;
    protected int TotalOwned => _itemSet?.Bricks?.Sum(b => Math.Min(GetOwnedQuantity(b), b.Quantity)) ?? 0;

    private void OnItemsPageChanged(int page)
    {
        _itemsPage = page;
    }

    private void OnItemsRowsPerPageChanged(int size)
    {
        _itemsRowsPerPage = size;
        _itemsPage = 0;
    }

    protected int Percent => (TotalNeeded > 0 && TotalOwned == TotalNeeded)
    ? 100
            : (TotalNeeded > 0 ? (int)Math.Floor(100.0 * (double)TotalOwned / TotalNeeded) : 0);

    protected bool HasAll => TotalNeeded > 0 && TotalOwned == TotalNeeded;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            SetError(ex);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadDataAsync()
    {
        _userItemSet = await ItemSetService.GetCurrentUserItemSetAsync(itemSetId);

        if (_userItemSet != null)
            _itemSet = _userItemSet.ItemSet;
        else
            _itemSet = await ItemSetService.GetItemSetByIdAsync(itemSetId);

        // Check if set is in favorites
        _isFavorite = await SetFavoritesService.IsSetInUsersFavoritesAsync(itemSetId);

        var inventory = await InventoryService.GetCurrentUserInventoryAsync() ?? new List<InventoryItem>();

        _ownedByBrand = inventory
        .GroupBy(i => (i.MappedBrickId, i.BrickColorId))
        .ToDictionary(
        g => g.Key,
        g => g.GroupBy(i => i.Brand)
        .ToDictionary(bg => bg.Key, bg => bg.Sum(i => i.Quantity))
        );

        UpdateTableItems();
        _tableKey = Guid.NewGuid();
    }

    private async Task OpenAddSetToWantedListDialog()
    {
        try
        {
            if (_itemSet?.Bricks == null || !_itemSet.Bricks.Any())
                return;

            var items = _itemSet.Bricks
            .Where(b => b.MappedBrickId > 0 && b.BrickColorId > 0 && b.Quantity > 0)
            .Select(b => new Data.DTOs.NewWantedListItemModel
            {
                MappedBrickId = b.MappedBrickId,
                ColorId = b.BrickColorId,
                Quantity = b.Quantity
            })
            .ToList();

            var parameters = new DialogParameters<AddSetToWantedListDialog>();
            parameters.Add(x => x.SetName, _itemSet.Name);
            parameters.Add(x => x.Items, items);

            var options = new DialogOptions
            {
                CloseButton = true,
                MaxWidth = MaxWidth.Small,
                FullWidth = true
            };

            await DialogService.ShowAsync<AddSetToWantedListDialog>("Wanted List", parameters, options);
        }
        catch (Exception ex)
        {
            SetError(ex);
            NotificationService.Error(_error ?? "An error happened.");
            StateHasChanged();
        }
    }

    private void UpdateTableItems()
    {
        var all = _itemSet?.Bricks ?? Enumerable.Empty<ItemSetBrick>();

        IEnumerable<ItemSetBrick> filtered = all;

        if (_showOnlyMissing)
        {
            // missing = nicht genug (None + Partial)
            filtered = all.Where(b => GetOwnershipState(b) != BrickOwnershipState.Enough);
        }

        _tableItems = filtered
        .OrderBy(b => b.BrickColor?.Name)
        .ToList();
    }

    private void ShowAllItems()
    {
        _showOnlyMissing = false;
        UpdateTableItems();
        _itemsPage = 0;
        _tableKey = Guid.NewGuid();
        StateHasChanged();
    }

    private void ShowOnlyMissingItems()
    {
        _showOnlyMissing = true;
        UpdateTableItems();
        _itemsPage = 0;
        _tableKey = Guid.NewGuid();
        StateHasChanged();
    }

    private void GoBack()
    {
        Nav.NavigateTo("/allsets");
    }

    private async Task OpenAddSetDialog()
    {
        try
        {
            if (_itemSet?.Bricks == null || !_itemSet.Bricks.Any())
                return;

            var itemCount = _itemSet.Bricks.Count;

            var parameters = new DialogParameters<AddSetToInventoryDialog>();
            parameters.Add(x => x.ItemCount, itemCount);
            parameters.Add(x => x.ItemSetId, itemSetId);

            var dialog = await DialogService.ShowAsync<AddSetToInventoryDialog>("Add Set to Inventory", parameters);
            var result = await dialog.Result;

            if (result != null && !result.Canceled && result.Data is bool confirmed && confirmed)
            {
                _loading = true;
                StateHasChanged();

                await LoadDataAsync();

                _loading = false;
                StateHasChanged();

                NotificationService.Success("Items were successfully added to the inventory.");
            }
        }
        catch (Exception ex)
        {
            SetError(ex);
            NotificationService.Error(_error ?? "An error happened.");
            StateHasChanged();
        }
    }

    private BrickOwnershipState GetOwnershipState(ItemSetBrick brick)
    {
        if (!_ownedByBrand.TryGetValue((brick.MappedBrickId, brick.BrickColorId), out var brandDict) || brandDict.Values.Sum()
        <= 0)
            return BrickOwnershipState.None;

        var total = brandDict.Values.Sum();
        if (total < brick.Quantity)
            return BrickOwnershipState.Partial;

        return BrickOwnershipState.Enough;
    }

    private int GetOwnedQuantity(ItemSetBrick brick)
    {
        return _ownedByBrand.TryGetValue((brick.MappedBrickId, brick.BrickColorId), out var brandDict)
        ? brandDict.Values.Sum()
        : 0;
    }

    private async Task OpenHelpMappingDialog(MappedBrick brick, string brand)
    {
        var parameters = new DialogParameters();
        parameters.Add("Brick", brick);
        parameters.Add("Brand", brand);
        var dialog = await DialogService.ShowAsync<HelpMappingDialog>("Help with mapping", parameters);
        var result = await dialog.Result;
        if (result is not null && !result.Canceled && result.Data is ValueTuple<string, string, string> tuple)
        {
            await UpdateMappingAsync(brick, tuple.Item1, tuple.Item2, tuple.Item3);
            await RefreshSetData();
        }
    }

    private async Task UpdateMappingAsync(MappedBrick brick, string brand, string mappingName, string mappingItemId)
    {
        try
        {
            var userId = await UserService.GetTokenAsync();
            if (userId is null)
                throw new InvalidOperationException("User is not logged in (no token).");

            await RequestService.CreateMappingRequestAsync(brick.Id, brand, mappingName, mappingItemId, userId);
            NotificationService.Success($"Mapping request for '{mappingName ?? mappingItemId}' ({brand}) was successfully created.");
        }
        catch (Exception ex)
        {
            SetError(ex);
            NotificationService.Error(_error ?? "Mapping request could not be created.");
        }
    }

    private async Task RefreshSetData()
    {
        try
        {
            _loading = true;
            StateHasChanged();
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            SetError(ex);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task ToggleFavorite()
    {
        if (_itemSet == null) return;

        try
        {
            var newFavoriteStatus = await SetFavoritesService.ToggleSetFavoriteAsync(itemSetId);
            _isFavorite = newFavoriteStatus;

            if (_isFavorite)
            {
                NotificationService?.Success($"'{_itemSet.Name}' was added to your favorites.");
            }
            else
            {
                NotificationService?.Success($"'{_itemSet.Name}' was removed from your favorites.");
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            SetError(ex);
            NotificationService?.Error(_error ?? "Error updating favorites.");
            StateHasChanged();
        }
    }
}