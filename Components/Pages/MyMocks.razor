@page "/mymocs"
@using brickapp.Components.Shared.PartsListUpload
@using brickapp.Data.Services
@inject NavigationManager Nav
@inject IServiceProvider ServiceProvider
@inject ImageService ImageService
@inject UserService UserService
@inject TrackingService TrackingService
@inject LoadingService LoadingService
@inject NotificationService NotificationService
@inject RebrickableApiService RebrickableApi
@inject ILogger<MyMocks> Logger


<PageTitle>My MOCs</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">My MOCs</MudText>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4">
        @_error
        @if (!string.IsNullOrWhiteSpace(_errorDetails))
        {
            <MudDivider Class="my-2"/>
            <MudText Typo="Typo.caption" Style="white-space:pre-wrap;">@_errorDetails</MudText>
        }
    </MudAlert>
}

<MudPaper Class="pa-4 mb-4">
    <MudText Typo="Typo.h5">Upload a new MOC</MudText>

    <MudTextField @bind-Value="_newMockName"
                  Label="MOC name *"
                  Disabled="_loading"/>

    <MudTextField @bind-Value="_newMockComment"
                  Label="Comment"
                  HelperText="optional description or notes about the MOC"
                  Disabled="_loading"
                  Lines="3"
                  TextFieldStyle="MudBlazor.TextFieldStyle.Multiline"/>

    <MudTextField @bind-Value="_newMockWebSource"
                  HelperText="optional URL to the MOC source (e.g. Rebrickable)"
                  Label="Web Source"
                  Disabled="_loading"/>

    <MudText Typo="Typo.h6" Class="my-4">Upload MOC image (max 3MB)</MudText>
    <InputFile OnChange="OnImageSelected" accept="image/*" disabled="@_loading"/>


    @if (!string.IsNullOrEmpty(_imagePreviewUrl))
    {
        <div style="margin-top:8px;">
            <img src="@_imagePreviewUrl" alt="Mock Bild Vorschau"
                 style="max-width:200px;max-height:200px;border:1px solid #ccc;padding:2px;"/>
        </div>
    }

    <MudDivider Class="my-3"/>
    <PartsListUploader Title="Upload Item List File"
                       Disabled="_loading"
                       Formats="@_mocFormats"
                       FormatLabelFunc="MocFormatLabel"
                       ShowAddButton="false"
                       ClearButtonText="Clear upload"
                       OnParsed="OnMocParsed"/>
    @if (!string.IsNullOrWhiteSpace(_uploadError))
    {
        <MudText Color="Color.Error" Class="mt-2">@_uploadError</MudText>
    }

    <MudButton StartIcon="@Icons.Material.Filled.Add"
               Variant="Variant.Filled"
               Color="Color.Primary"
               OnClick="CreateMockFromUpload"
               Disabled="@(!_fileReadyForUpload || _loading)"
               Class="ml-2 mt-3">
        Create new MOC
    </MudButton>
</MudPaper>

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5">Your MOCs</MudText>

    <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2" Style="margin-bottom: 16px;">
        <MudButton StartIcon="@Icons.Material.Filled.Delete"
                   Variant="Variant.Outlined"
                   Color="Color.Error"
                   OnClick="DeleteAllMocks"
                   Disabled="_loading"
                   Class="ml-2">
            Delete all MOCs
        </MudButton>
    </MudStack>

    <MudList T="string">
        @if (_userMocks == null)
        {
            <MudText>Loading...</MudText>
        }
        else if (!_userMocks.Any())
        {
            <MudAlert Severity="Severity.Info">No MOCs found.</MudAlert>
        }
        else
        {
            <MudTable Items="@_userMocks" Hover="true" Breakpoint="Breakpoint.Sm" Context="mock">
                <HeaderContent>
                    <MudTh>Image</MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Source / Typ</MudTh>
                    <MudTh>Items</MudTh>
                    <MudTh Style="text-align:right">Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Bild">
                        <div style="cursor:pointer" @onclick="@(() => Nav.NavigateTo($"/mockdetail/{mock.Id}"))">
                            <img src="@ImageService.GetMockImagePath(mock)" alt="Mock Bild"
                                 style="width:48px;height:48px;object-fit:contain;border:1px solid #ccc;background:#fff;padding:2px;border-radius:6px;"/>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Name">
                        <div style="cursor:pointer" @onclick="@(() => Nav.NavigateTo($"/mockdetail/{mock.Id}"))">
                            <MudText>@mock.Name</MudText>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Source">
                        <MudText>@mock.MockType</MudText>
                    </MudTd>
                    <MudTd DataLabel="Items">
                        @{
                            var totalParts = mock.Items?.Sum(i => i.Quantity) ?? 0;
                        }
                        <MudText Typo="Typo.body2">@totalParts Parts</MudText>
                    </MudTd>
                    <MudTd DataLabel="Actions" Style="text-align:right">
                        <MudIconButton Variant="Variant.Outlined"
                                       Color="Color.Error"
                                       Icon="@Icons.Material.Filled.Delete"
                                       Size="Size.Small"
                                       OnClick="@(() => DeleteMock(mock.Id))">
                        </MudIconButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudList>
</MudPaper>

@code {

    // NEU: Liste für ungemappte Teile
    // NEU: Source für die Farblogik

    // ==========================================
    // PARSER METHODEN (Vollständig)
    // ==========================================

}