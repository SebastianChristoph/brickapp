@page "/allsets"
@using Services
@using Data.Entities
@inject Data.Services.ImageService ImageService
@inject UserService UserService
@inject ItemSetService SetService
@inject NavigationManager NavigationManager

<PageTitle>All Sets</PageTitle>

<MudText Typo="Typo.h5" GutterBottom="true">
    @(_username is null ? "Welcome to BrickIsBrick!" : $"Hello, {_username}")
</MudText>

<MudText Typo="Typo.h6" GutterBottom="true">
    All available sets
</MudText>
<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => NavigationManager.NavigateTo("/add-new-set"))" Class="mb-4">Add New Set</MudButton>


<MudTextField @bind-Value="_searchText" Label="Search by name or ID" Variant="Variant.Outlined" Margin="Margin.Normal" Immediate="true" Placeholder="At least 3 characters..." Class="mb-4" />

@if (!string.IsNullOrWhiteSpace(_searchText) && _searchText.Length >= 3)
{
    if (sets is null)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudTable Items="_filteredSets" Hover="true" Striped="true" Dense="false">
            <HeaderContent>
                <MudTh>Image</MudTh>
                <MudTh>Name</MudTh>
                <MudTh>Brand</MudTh>
                <MudTh>Lego Set Num</MudTh>
                <MudTh>Year</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Image">
                    
                    @{
                        var setImgUrl = ImageService.GetSetImagePath(context);
                    }
                    @if (!string.IsNullOrEmpty(setImgUrl) && setImgUrl != "/placeholder-image.png")
                    {
                        <img src="@setImgUrl" alt="@context.Name" style="height:50px; width:auto; object-fit:contain;" />
                    }
                    else
                    {
                        <MudText>-</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Name">
                    <MudLink Href="@($"/sets/{context.Id}")" Color="Color.Primary">
                        @context.Name
                    </MudLink>
                </MudTd>
                <MudTd DataLabel="Brand">@context.Brand</MudTd>
                <MudTd DataLabel="Lego Set Num">@context.LegoSetNum</MudTd>
                <MudTd DataLabel="Year">@context.Year</MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[]{25, 50, 100}" />
            </PagerContent>
        </MudTable>
    }
}

@code {
    private string? _username;
    private List<ItemSet>? sets;
    private string _searchText = string.Empty;
    private bool _addSetDialogOpen = false;

    private List<ItemSet> _filteredSets =>
        string.IsNullOrWhiteSpace(_searchText) || _searchText.Length < 3
            ? sets ?? new List<ItemSet>()
            : (sets ?? new List<ItemSet>()).Where(s =>
                (s.Name?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
                || (s.LegoSetNum?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
                || s.Id.ToString().Contains(_searchText)
            ).ToList();

    void OpenAddSetDialog() => _addSetDialogOpen = true;
    void CloseAddSetDialog() => _addSetDialogOpen = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        _username = await UserService.GetUsernameAsync();
        // Load ALL sets for client-side pagination
        var (allSets, _) = await SetService.GetPaginatedItemSetsAsync(1, int.MaxValue);
        sets = allSets;
        StateHasChanged();
    }
}
