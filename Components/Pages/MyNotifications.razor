@page "/my-notifications"
@using Data.Entities
@using Data.Services
@using Services
@inject UserService UserService
@inject UserNotificationService NotificationService
@inject NavigationManager NavigationManager

<PageTitle>My Notifications</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">My Notifications</MudText>

@if (_notifications == null)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (!_notifications.Any())
{
    <MudAlert Severity="Severity.Info" Class="mt-4">No notifications found.</MudAlert>
}
else
{
    <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2" Style="margin-bottom: 16px;">
        <MudButton StartIcon="@Icons.Material.Filled.MarkEmailRead" Color="Color.Primary" Variant="Variant.Outlined"
            OnClick="@MarkAllAsRead">Mark all as read</MudButton>
        <MudButton StartIcon="@Icons.Material.Filled.Delete" Color="Color.Error" Variant="Variant.Outlined"
            OnClick="@DeleteAllNotifications">Delete all</MudButton>
    </MudStack>
    <MudList T="UserNotification">
        @foreach (var n in _notifications)
        {
            <MudListItem T="UserNotification">

                <MudText Typo="Typo.subtitle2"> @if (!n.IsRead)
                    {
                        <MudChip T="string" Color="Color.Info" Size="Size.Small">New</MudChip>

                    }
                    @n.Title
                </MudText>
                <MudText Typo="Typo.caption">@n.CreatedAt.ToLocalTime().ToString("g")</MudText>
                <MudText>@n.Message</MudText>

                <MudStack Row="true" Spacing="1">
                    @if (!n.IsRead)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.MarkEmailRead" Size="Size.Small" Color="Color.Primary"
                            OnClick="@(() => MarkAsRead(n))">Als gelesen markieren</MudIconButton>
                    }
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Primary"
                        OnClick="@(() => DeleteNotification(n))">LÃ¶schen</MudIconButton>
                </MudStack>
            </MudListItem>
        }
    </MudList>
}

@code {
    private List<UserNotification>? _notifications;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadNotificationsAsync();
            StateHasChanged();
        }
    }

    private async Task LoadNotificationsAsync()
    {
        var userUuid = await UserService.GetTokenAsync();
        if (!string.IsNullOrEmpty(userUuid))
        {
            _notifications = await NotificationService.GetNotificationsForUserAsync(userUuid);
        }
        else
        {
            _notifications = new();
        }
    }

    private async Task DeleteNotification(UserNotification notification)
    {
        await NotificationService.DeleteNotificationAsync(notification.Id);
        await LoadNotificationsAsync();
        StateHasChanged();
    }

    private async Task DeleteAllNotifications()
    {
        var userUuid = await UserService.GetTokenAsync();
        if (!string.IsNullOrEmpty(userUuid))
        {
            await NotificationService.DeleteAllNotificationsAsync(userUuid);
            await LoadNotificationsAsync();
            StateHasChanged();
        }
    }

    private async Task MarkAsRead(UserNotification notification)
    {
        await NotificationService.MarkAsReadAsync(notification.Id);
        await LoadNotificationsAsync();
        StateHasChanged();
        // dieses forceLoad brauchst du meist nicht:
        // NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
    }

    private async Task MarkAllAsRead()
    {
        var userUuid = await UserService.GetTokenAsync();
        if (!string.IsNullOrEmpty(userUuid))
        {
            await NotificationService.MarkAllAsReadAsync(userUuid);
            await LoadNotificationsAsync();
            StateHasChanged();
            // NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
        }
    }
}