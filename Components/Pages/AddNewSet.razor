@page "/add-new-set"
@using brickapp.Data.Entities
@using brickapp.Helpers
@inject Data.Services.RequestService RequestService
@inject Data.Services.UserService UserService
@inject Data.Services.ItemSetService ItemSetService
@inject Data.Services.MappedBrickService MappedBrickService
@inject Data.Services.NotificationService NotificationService
@inject Data.Services.ImageService ImageService
@inject Data.Services.LoadingService LoadingService

<PageTitle>Add New Sets</PageTitle>
<MudText Typo="Typo.h4" GutterBottom="true">Add new sets</MudText>

<style>
    .brick {
        position: relative;
        display: inline-block;
        width: 56px;
        height: 56px;
        min-width: 56px;
        min-height: 56px;
        box-sizing: border-box;
    }

    .brick-img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 4px;
        border: 2px solid #ccc;
        background: #fff;
        display: block;
    }

    .brick::after {
        content: "";
        position: absolute;
        right: 1px;
        bottom: 0;
        width: 0;
        height: 0;
        border-bottom: 28px solid var(--brick-color, transparent);
        border-left: 28px solid transparent;
        border-radius: 0 0 4px 0;
        z-index: 2;
        pointer-events: none;
    }
</style>

<MudText Typo="Typo.h6" GutterBottom="true">Your drafts</MudText>

@if (_draftSets == null)
{
    <p><em>Loading drafts...</em></p>
}
else if (!_draftSets.Any())
{
    <MudAlert Severity="Severity.Info">You don't have any drafts.</MudAlert>
}
else
{
    <MudTable Items="_draftSets" Hover="true" Striped="true">
        <HeaderContent>
            <MudTh>Image</MudTh>
            <MudTh>Name</MudTh>
            <MudTh>Brand</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>

        <RowTemplate Context="set">
            <MudTd DataLabel="Image">
                @{
                    var img = ImageService.GetNewSetRequestImagePath(set);
                    var has = !string.IsNullOrWhiteSpace(img) && img != "/placeholder-image.png";
                }
                <div class="brick" style="--brick-color:transparent; width:48px; height:48px; min-width:48px; min-height:48px;">
                    <img src="@(has ? img : "/placeholder-image.png")"
                         alt="Set image"
                         class="brick-img"
                         style="border-width:1px;@(has ? "" : "opacity:0.5;")" />
                </div>
            </MudTd>

            <MudTd DataLabel="Name">@set.SetName (@set.SetNo)</MudTd>
            <MudTd DataLabel="Brand">@set.Brand</MudTd>

            <MudTd DataLabel="Actions">
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" Class="me-2"
                           OnClick="@(() => EditDraftAsync(set.Id))">
                    Edit
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small"
                           OnClick="@(() => DeleteDraftAsync(set.Id))">
                    Delete
                </MudButton>
            </MudTd>
        </RowTemplate>
    </MudTable>
}

<br />

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h6" GutterBottom="true">Add a new set</MudText>

    <EditForm Model="_newSetModel" OnValidSubmit="HandleDraftSubmit">
        <div class="mb-2">
            <label for="setImage">Set image *</label>
            <InputFile id="setImage" OnChange="OnImageSelected" accept="image/*" />

            @if (!string.IsNullOrEmpty(_imageError))
            {
                <div class="alert alert-danger">@_imageError</div>
            }
            @if (!string.IsNullOrEmpty(_imagePreviewUrl))
            {
                <div class="mt-2">
                    <img src="@_imagePreviewUrl" alt="set image preview"
                         style="max-width: 300px; max-height: 300px; border: 1px solid #ccc; border-radius: 6px;" />
                </div>
            }
        </div>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger">@_errorMessage</div>
        }

        <DataAnnotationsValidator />
        <ValidationSummary />

        <div style="max-width: 400px">
            <MudTextField @bind-Value="_newSetModel.SetName" Label="Set Name" Variant="Variant.Text" Style="max-width:800px;" />
            <MudTextField @bind-Value="_newSetModel.SetNo" Label="Set Number" Variant="Variant.Text" Style="max-width:800px;" />

            <MudSelect T="string" @bind-Value="_newSetModel.Brand" Label="Select brand" Style="max-width:800px;">
                <MudSelectItem Value="@("Lego")">Lego</MudSelectItem>
                <MudSelectItem Value="@("Bluebrixx")">Bluebrixx</MudSelectItem>
                <MudSelectItem Value="@("Pantasy")">Pantasy</MudSelectItem>
                <MudSelectItem Value="@("Mould King")">Mould King</MudSelectItem>
                <MudSelectItem Value="@("Cada")">Cada</MudSelectItem>
                <MudSelectItem Value="@("Unknown")">Unknown</MudSelectItem>
            </MudSelect>

            <hr />
            <MudText Typo="Typo.body1" GutterBottom="true" Style="font-weight:bold; margin-top:16px;">
                Add set items
            </MudText>

            <BrickPicker OnBrickAdded="HandleBrickAdded" 
                         Label="Search Item by Name or PartNumber" 
                         Placeholder="Enter part number or name (e.g. Lego or Bluebrixx part numbers)..."
                         AddButtonText="Add item to new set"
                         ShowQuickColorPicker="true" />
        </div>

        <br />
        <br />

       

          <div class="mt-3">
            <MudButton StartIcon="@Icons.Material.Filled.Save"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       ButtonType="ButtonType.Submit"
                       Class="mb-4"
                       Disabled="_loading">
                Save as draft
            </MudButton>

            <MudButton StartIcon="@Icons.Material.Filled.Add"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="@HandlePublish"
                       Class="mb-4"
                       Disabled="_loading">
                Publish set
            </MudButton>
        </div>

         <MudText Typo="Typo.body2" GutterBottom="true" Style="font-weight:bold; margin-top:16px;">
            Added set items
        </MudText>

        @if (_newSetModel.Bricks.Any())
        {
            <MudTable Items="_newSetModel.Bricks" Hover="true" Striped="true">
                <HeaderContent>
                    <MudTh>Image</MudTh>
                    <MudTh>Item</MudTh>
                    <MudTh>Color</MudTh>
                 
                    <MudTh>Quantity</MudTh>
                    <MudTh Style="text-align:right">Actions</MudTh>
                </HeaderContent>

                <RowTemplate Context="brick">
                    <MudTd DataLabel="Image">
                        @{
                            var overlay = !string.IsNullOrWhiteSpace(brick.Color)
                                ? BrickColorHelper.GetHexForColor(brick.Color)
                                : null;
                            var overlayCss = overlay ?? "transparent";

                           // Erstelle ein temporäres Objekt, das alle IDs für den ImageService bereitstellt
                            var mb = new MappedBrick 
                            { 
                                LegoPartNum = brick.LegoPartNum, 
                                Uuid = brick.Uuid ?? string.Empty 
                            };
                            var url = ImageService.GetMappedBrickImagePath(mb);
                            var has = !string.IsNullOrWhiteSpace(url) && url != "/placeholder-image.png";
                        }

                        <div class="brick" style="--brick-color:@overlayCss; width:48px; height:48px; min-width:48px; min-height:48px;">
                            <img src="@(has ? url : "/placeholder-image.png")" alt=""
                                 class="brick-img"
                                 style="border-width:1px;@(has ? "" : "opacity:0.5;")" />
                        </div>
                    </MudTd>

                    <MudTd DataLabel="Brick">@brick.BrickName</MudTd>
                    <MudTd DataLabel="Color">@brick.Color</MudTd>
                  
                    <MudTd DataLabel="Quantity">@brick.Quantity</MudTd>

                    <MudTd DataLabel="Actions" Style="text-align:right">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small"
                                   @onclick="() => RemoveBrick(brick)">
                        </MudIconButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }

      
    </EditForm>
</MudPaper>