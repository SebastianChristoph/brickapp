
@page "/add-new-set"
@using Data.Entities

@using Services
@inject Data.Services.RequestService RequestService
@inject UserService UserService
@inject Services.ItemSetService ItemSetService
@inject Services.MappedBrickService MappedBrickService
@inject Services.RebrickablePartImageService PartImageService
@inject Services.NotificationService NotificationService


<h3>Add New Set</h3>

<!-- Formular für neues Set ...existing code... -->

<h4>Deine Entwürfe</h4>
@if (draftSets == null)
{
	<p><em>Lade Entwürfe...</em></p>
}
else if (!draftSets.Any())
{
	<p>Keine Entwürfe vorhanden.</p>
}
else
{
	<ul>
		@foreach (var set in draftSets)
		{
			<li>
				@set.SetName (@set.SetNo) - @set.Brand
				<button class="btn btn-sm btn-primary ms-2" @onclick="() => EditDraftAsync(set.Id)">Edit</button>
				<button class="btn btn-sm btn-danger ms-2" @onclick="() => DeleteDraftAsync(set.Id)">Löschen</button>
			</li>
		}
		
	</ul>
}



<h4>Neues Set hinzufügen</h4>
<EditForm Model="newSetModel" OnValidSubmit="HandleDraftSubmit">
	@if (!string.IsNullOrEmpty(errorMessage))
	{
		<div class="alert alert-danger">@errorMessage</div>
	}
	<DataAnnotationsValidator />
	<ValidationSummary />
	<div class="mb-2">
		<label for="setName">Name *</label>
		<InputText id="setName" class="form-control" @bind-Value="newSetModel.SetName" required />
	</div>
	<div class="mb-2">
		<label for="setId">Set ID *</label>
		<InputText id="setId" class="form-control" @bind-Value="newSetModel.SetNo" required />
	</div>
	<div class="mb-2">
		<label for="brand">Brand *</label>
		<InputSelect id="brand" class="form-control" @bind-Value="newSetModel.Brand" required>
			<option value="">Bitte wählen</option>
			<option value="Lego">Lego</option>
			<option value="Cada">Cada</option>

		</InputSelect>
	</div>

	<hr />
	<h5>Bricks zum Set hinzufügen</h5>
	<div class="mb-2">
		<label for="brickSearch">Brick suchen</label>
		<InputText id="brickSearch" class="form-control" @bind-Value="brickSearchText" @oninput="OnBrickSearchInput"
			placeholder="ID oder Name..." />
		@if (brickSearchResults.Any())
		{
			<ul class="list-group mt-1">
				@foreach (var brick in brickSearchResults)
				{
					<li class="list-group-item list-group-item-action"
						style="cursor:pointer; display:flex; align-items:center; gap:8px;" @onclick="() => SelectBrick(brick)">
						<img src="@GetBrickImageUrl(brick)" alt=""
							style="width:32px;height:32px;border-radius:4px;border:1px solid #ccc;" />
						<span>@brick.LegoPartNum - @brick.LegoName</span>
					</li>
				}
			</ul>
		}
	</div>
	@if (selectedBrick != null)
	{
		<div class="mb-2">
			<label for="colorSelect">Farbe</label>
			<InputSelect id="colorSelect" class="form-control" @bind-Value="selectedColor">
				<option value="">Bitte wählen</option>
				@foreach (var color in brickColors)
				{
					<option value="@color.Name">@color.Name</option>
				}
			</InputSelect>
		</div>
		<div class="mb-2">
			<label for="quantity">Menge</label>
			<InputNumber id="quantity" class="form-control" @bind-Value="brickQuantity" min="1" />
		</div>
		<button type="button" class="btn btn-success" @onclick="AddBrickToSet">Hinzufügen</button>
	}

	<h6 class="mt-3">Bricks im Set</h6>
	@if (newSetModel.Bricks.Any())
	{
		<MudTable Items="newSetModel.Bricks" Hover="true" Striped="true">
			<HeaderContent>
				<MudTh>Brick</MudTh>
				<MudTh>Color</MudTh>
				<MudTh>Brand</MudTh>
				<MudTh>Brand ID</MudTh>
				<MudTh>Quantity</MudTh>
				<MudTh>Image</MudTh>
				<MudTh>Actions</MudTh>
			</HeaderContent>
			<RowTemplate Context="brick">
				<MudTd DataLabel="Brick">@brick.BrickName</MudTd>
				<MudTd DataLabel="Color">@brick.Color</MudTd>
				<MudTd DataLabel="Brand">@newSetModel.Brand</MudTd>
				<MudTd DataLabel="Brand ID">@brick.BrickId</MudTd>
				<MudTd DataLabel="Quantity">@brick.Quantity</MudTd>
				<MudTd DataLabel="Image">
					<img src="@GetBrickImageUrlFromId(brick.BrickId)" alt=""
						style="width:48px;height:48px;border-radius:4px;border:1px solid #ccc;" />
				</MudTd>
				<MudTd DataLabel="Actions">

					<MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small"
						@onclick="() => RemoveBrick(brick)">Delete</MudButton>
				</MudTd>
			</RowTemplate>
		</MudTable>
	}


	<div class="mt-3">
		<button type="submit" class="btn btn-secondary me-2">Als Entwurf speichern</button>
		<button type="button" class="btn btn-primary" @onclick="HandlePublish">Veröffentlichen</button>
	</div>
</EditForm>

@code {
	private bool _hasLoaded = false;
		protected override async Task OnAfterRenderAsync(bool firstRender)
		{
			if (!_hasLoaded && firstRender)
			{
				_hasLoaded = true;
				await LoadDraftsAndData();
			}
		}
	private List<Data.Entities.NewSetRequest>? draftSets;
	private List<string> brands = new();
	private NewSetModel newSetModel = new();
	private int? editingDraftId = null;
	private string? errorMessage;

	// Brick hinzufügen
	private string brickSearchText = "";
	private List<MappedBrick> brickSearchResults = new();
	private MappedBrick? selectedBrick;
	private List<BrickColor> brickColors = new();
	private string selectedColor = "";
	private int brickQuantity = 1;

	private string GetBrickImageUrlFromId(int brickId)
	{
		var brick = brickSearchResults.FirstOrDefault(b => b.Id == brickId);
		if (brick != null)
		{
			var partNum = brick.LegoPartNum;
			if (!string.IsNullOrWhiteSpace(partNum) && _brickImageCache.TryGetValue(partNum, out var url))
				return url;
		}
		return "/part_images/placeholder.png";
	}

	private async Task EditDraftAsync(int draftId)
	{
		var draft = draftSets?.FirstOrDefault(d => d.Id == draftId);
		if (draft == null) return;
		editingDraftId = draft.Id;
		var bricks = new List<NewSetBrickModel>();
		var allBricks = await MappedBrickService.GetAllMappedBricksAsync();
		foreach (var item in draft.Items)
		{
			int brickId = 0;
			string brickName = item.ItemIdOrName;
			if (int.TryParse(item.ItemIdOrName, out var id))
			{
				brickId = id;
				var brick = allBricks.FirstOrDefault(b => b.Id == id);
				if (brick != null)
				{
					brickName = brick.LegoName ?? brick.LegoPartNum ?? item.ItemIdOrName;
				}
			}
			bricks.Add(new NewSetBrickModel
			{
				BrickId = brickId,
				BrickName = brickName,
				Color = item.Color,
				Quantity = item.Quantity
			});
		}
		newSetModel = new NewSetModel
		{
			SetName = draft.SetName,
			SetNo = draft.SetNo,
			Brand = draft.Brand,
			Bricks = bricks
		};
		StateHasChanged();
	}

		private async Task LoadDraftsAndData()
	{
		var user = await UserService.GetCurrentUserAsync();
		if (user == null)
		{
			draftSets = new List<Data.Entities.NewSetRequest>();
			return;
		}
		var allSets = await RequestService.GetNewSetRequestsByUserAsync(user.Uuid);
		draftSets = allSets.Where(s => s.Status == Data.Entities.NewSetRequestStatus.Draft).ToList();
		brands = await GetAllBrandsAsync();
		brickColors = await MappedBrickService.GetAllColorsAsync();
		StateHasChanged();
	}

	private void RemoveBrick(NewSetBrickModel brick)
	{
		newSetModel.Bricks.Remove(brick);
		StateHasChanged();
	}


	private Dictionary<string, string> _brickImageCache = new();

	private string GetBrickImageUrl(MappedBrick brick)
	{
		var partNum = brick.LegoPartNum;
		if (!string.IsNullOrWhiteSpace(partNum) && _brickImageCache.TryGetValue(partNum, out var url))
			return url;
		return "/part_images/placeholder.png";
	}

	private async void OnBrickSearchInput(ChangeEventArgs e)
	{
		brickSearchText = e.Value?.ToString() ?? "";
		if (brickSearchText.Length < 2)
		{
			brickSearchResults.Clear();
			StateHasChanged();
			return;
		}
		var allBricks = await MappedBrickService.GetAllMappedBricksAsync();
		brickSearchResults = allBricks.Where(b => (b.LegoPartNum?.Contains(brickSearchText, StringComparison.OrdinalIgnoreCase)
		?? false) || (b.LegoName?.Contains(brickSearchText, StringComparison.OrdinalIgnoreCase) ?? false)).Take(10).ToList();
		foreach (var brick in brickSearchResults)
		{
			var partNum = brick.LegoPartNum;
			if (!string.IsNullOrWhiteSpace(partNum) && !_brickImageCache.ContainsKey(partNum))
			{
				var url = await PartImageService.GetPartImageUrlAsync(partNum);
				_brickImageCache[partNum] = string.IsNullOrWhiteSpace(url) ? "/part_images/placeholder.png" : url;
			}
		}
		StateHasChanged();
	}

	private void SelectBrick(MappedBrick brick)
	{
		selectedBrick = brick;
		selectedColor = "";
		brickQuantity = 1;
		brickSearchResults.Clear();
		brickSearchText = brick.LegoPartNum ?? brick.LegoName ?? "";
		StateHasChanged();
	}

	private void AddBrickToSet()
	{
		if (selectedBrick == null || string.IsNullOrEmpty(selectedColor) || brickQuantity < 1)
			return;
		newSetModel.Bricks.Add(new NewSetBrickModel
		{
			BrickId = selectedBrick.Id,
			BrickName = selectedBrick.LegoName ?? selectedBrick.LegoPartNum ?? "",
			Color = selectedColor,
			Quantity = brickQuantity
		});
		selectedBrick = null;
		selectedColor = "";
		brickQuantity = 1;
		brickSearchText = "";
		StateHasChanged();
	}

	private async Task<List<string>> GetAllBrandsAsync()
	{
		// Hole alle Brands aus ItemSets
		var itemSets = await ItemSetService.GetPaginatedItemSetsAsync(1, 1000);
		return itemSets.Items.Select(s => s.Brand).Distinct().OrderBy(b => b).ToList();
	}

	private async Task HandleDraftSubmit()
	{
		errorMessage = null;
		var user = await UserService.GetCurrentUserAsync();
		if (user == null){
			  NotificationService.Error("Kein User gefunden. Bitte melde dich an.");
			  
			  return;
			  }

		// Prüfe auf Duplikat
		var itemSets = await ItemSetService.GetPaginatedItemSetsAsync(1, 1000);
		var exists = itemSets.Items.Any(s => s.Brand == newSetModel.Brand && (s.Name == newSetModel.SetName || s.LegoSetNum ==
		newSetModel.SetNo));
		if (exists)
		{
			errorMessage = "Es existiert bereits ein Set mit dieser Brand und Name oder Set ID.";
			StateHasChanged();
			return;
		}
		var items = newSetModel.Bricks.Select(b => new Data.Entities.NewSetRequestItem
		{
			ItemIdOrName = b.BrickId != 0 ? b.BrickId.ToString() : b.BrickName,
			Quantity = b.Quantity,
			Color = b.Color
		}).ToList();
		if (editingDraftId.HasValue)
		{
			// Update existing draft in-place
			await RequestService.UpdateNewSetRequestAsync(editingDraftId.Value, newSetModel.Brand, newSetModel.SetNo, newSetModel.SetName, null, items, Data.Entities.NewSetRequestStatus.Draft);
		}
		else
		{
			await RequestService.CreateNewSetRequestAsync(newSetModel.Brand, newSetModel.SetNo, newSetModel.SetName, null,
				user.Uuid, items, Data.Entities.NewSetRequestStatus.Draft);
		}
		await LoadDraftsAndData();
		newSetModel = new();
		editingDraftId = null;
		NotificationService.Success("Set erfolgreich als Entwurf gespeichert.");
		StateHasChanged();
	}

	private async Task HandlePublish()
	{
		errorMessage = null;
		var user = await UserService.GetCurrentUserAsync();
		if (user == null) return;
		// Prüfe auf Duplikat
		var itemSets = await ItemSetService.GetPaginatedItemSetsAsync(1, 1000);
		var exists = itemSets.Items.Any(s => s.Brand == newSetModel.Brand && (s.Name == newSetModel.SetName || s.LegoSetNum ==
		newSetModel.SetNo));
		if (exists)
		{
			errorMessage = "Es existiert bereits ein Set mit dieser Brand und Name oder Set ID.";
			StateHasChanged();
			return;
		}
		// Veröffentlichen: Status Pending
		var items = newSetModel.Bricks.Select(b => new Data.Entities.NewSetRequestItem
		{
			ItemIdOrName = b.BrickId != 0 ? b.BrickId.ToString() : b.BrickName,
			Quantity = b.Quantity,
			Color = b.Color
		}).ToList();
		if (editingDraftId.HasValue)
		{
			// Update draft to Pending (publish)
			var draft = draftSets?.FirstOrDefault(d => d.Id == editingDraftId.Value);
			if (draft != null)
			{
				await RequestService.DeleteNewSetRequestAsync(draft.Id); // Remove old draft
			}
		}
		await RequestService.CreateNewSetRequestAsync(newSetModel.Brand, newSetModel.SetNo, newSetModel.SetName, null,
			user.Uuid, items, Data.Entities.NewSetRequestStatus.Pending);
		await LoadDraftsAndData();
		newSetModel = new();
		editingDraftId = null;
		NotificationService.Success("Set erfolgreich zur Überprüfung eingereicht.");
		StateHasChanged();
	}

	private async Task DeleteDraftAsync(int id)
	{
		await RequestService.DeleteNewSetRequestAsync(id);
		var user = await UserService.GetCurrentUserAsync();
		if (user != null)
		{
				await LoadDraftsAndData();
			StateHasChanged();
		}
	}

	public class NewSetModel
	{
		public string SetName { get; set; } = string.Empty;
		public string SetNo { get; set; } = string.Empty;
		public string Brand { get; set; } = string.Empty;
		public List<NewSetBrickModel> Bricks { get; set; } = new();
	}

	public class NewSetBrickModel
	{
		public int BrickId { get; set; }
		public string BrickName { get; set; } = string.Empty;
		public string Color { get; set; } = string.Empty;
		public int Quantity { get; set; }
	}
}