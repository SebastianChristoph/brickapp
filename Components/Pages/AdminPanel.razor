@page "/admin-panel"
@using brickapp.Data.Services
@inject MappedBrickExportService MappedExport
@inject ItemSetExportService SetExport
@inject UserService UserService
@inject StatsService StatsService
@inject TrackingService TrackingService
@inject MappedBrickService MappedBrickService
@inject NotificationService NotificationService
@inject IDialogService DialogService

<MudText Typo="Typo.h4" GutterBottom="true">Admin Panel</MudText>


@if (_loading)
{
    <MudProgressCircular Indeterminate="true" Class="mb-4"/>
}
else if (_stats != null)
{
    <MudTabs Elevation="4" Rounded="true" Color="Color.Primary">
        <MudTabPanel Text="Statistics" Icon="@Icons.Material.Filled.BarChart">

            <MudGrid Class="mt-4" GutterSize="3">
                <!-- Users & Content -->
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="4">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large"
                                             Color="Color.Primary"/>
                                    <MudText Typo="Typo.h3">@_stats.TotalUsers</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Total Users</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="4">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudIcon Icon="@Icons.Material.Filled.ViewInAr" Size="Size.Large"
                                             Color="Color.Secondary"/>
                                    <MudText Typo="Typo.h3">@_stats.TotalMocks</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">MOCs</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="4">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudIcon Icon="@Icons.Material.Filled.List" Size="Size.Large"
                                             Color="Color.Tertiary"/>
                                    <MudText Typo="Typo.h3">@_stats.TotalWantedLists</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Wanted Lists</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <!-- Bricks & Sets -->
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="4">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Large"
                                             Color="Color.Info"/>
                                    <MudText Typo="Typo.h3">@_stats.TotalMappedBricks</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Mapped Bricks</MudText>
                                <MudText Typo="Typo.caption">@_stats.MappedBricksWithMapping mapped
                                    / @_stats.MappedBricksWithoutMapping unmapped
                                </MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="4">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Large"
                                             Color="Color.Success"/>
                                    <MudText Typo="Typo.h3">@_stats.TotalInventoryItems</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Inventory Items</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="4">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudIcon Icon="@Icons.Material.Filled.CollectionsBookmark" Size="Size.Large"
                                             Color="Color.Warning"/>
                                    <MudText Typo="Typo.h3">@_stats.TotalItemSets</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Item Sets</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <!-- Requests by Status -->
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mt-4 mb-2">Requests by Status</MudText>
                </MudItem>

                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="4">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudIcon Icon="@Icons.Material.Filled.PendingActions" Size="Size.Large"
                                             Color="Color.Warning"/>
                                    <MudText Typo="Typo.h3">@_stats.PendingRequests</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Pending Requests</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="4">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large"
                                             Color="Color.Success"/>
                                    <MudText Typo="Typo.h3">@_stats.ApprovedRequests</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Approved Requests</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="4">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Large"
                                             Color="Color.Error"/>
                                    <MudText Typo="Typo.h3">@_stats.RejectedRequests</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Rejected Requests</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <!-- Requests by Type -->
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mt-4 mb-2">Requests by Type (Total: @_stats.TotalRequests)</MudText>
                </MudItem>

                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="4">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudIcon Icon="@Icons.Material.Filled.Link" Size="Size.Large"
                                             Color="Color.Primary"/>
                                    <MudText Typo="Typo.h3">@_stats.TotalMappingRequests</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Mapping Requests</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="4">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudIcon Icon="@Icons.Material.Filled.AddBox" Size="Size.Large"
                                             Color="Color.Secondary"/>
                                    <MudText Typo="Typo.h3">@_stats.TotalNewItemRequests</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">New Item Requests</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="4">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudIcon Icon="@Icons.Material.Filled.LibraryAdd" Size="Size.Large"
                                             Color="Color.Tertiary"/>
                                    <MudText Typo="Typo.h3">@_stats.TotalNewSetRequests</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">New Set Requests</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="4">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudIcon Icon="@Icons.Material.Filled.Image" Size="Size.Large" Color="Color.Info"/>
                                    <MudText Typo="Typo.h3">@_stats.TotalItemImageRequests</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Image Requests</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>

        </MudTabPanel>
        <MudTabPanel Text="Admin Actions" Icon="@Icons.Material.Filled.AdminPanelSettings">
            <div class="mt-4"></div>

            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ExportMappings">Export Mappings
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ExportSets">Export Sets</MudButton>

            <MudDivider Class="my-4"/>
            <MudText Typo="Typo.h6">Create new AppUser</MudText>
            <MudTextField @bind-Value="_newUserName" Label="Username" Variant="Variant.Outlined"/>
            <MudButton StartIcon="Icons.Material.Filled.PersonAdd" Variant="Variant.Filled" Color="Color.Secondary"
                       OnClick="CreateUser">Create AppUser
            </MudButton>
            <div>@_createUserMessage</div>

            <div>@_statusMessage</div>

        </MudTabPanel>
        <MudTabPanel Text="User Tracking" Icon="@Icons.Material.Filled.Timeline">
            @if (_loadingTracking)
            {
                <MudProgressCircular Indeterminate="true" Class="mb-4"/>
            }
            else if (_trackingByUser != null)
            {
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4 mt-4">
                    <MudText Typo="Typo.h5">User Activity Tracking</MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Error"
                               StartIcon="@Icons.Material.Filled.DeleteForever" OnClick="DeleteAllTrackings">Delete All
                        Trackings
                    </MudButton>
                </MudStack>

                @if (!_trackingByUser.Any())
                {
                    <MudAlert Severity="Severity.Info">No tracking data available yet.</MudAlert>
                }
                else
                {
                    @foreach (var userGroup in _trackingByUser.OrderByDescending(kvp => kvp.Value.Count))
                    {
                        var userName = userGroup.Value.FirstOrDefault()?.AppUser?.Name ?? "Unknown";
                        var userUuid = userGroup.Key;

                        <MudExpansionPanels Class="mb-3">
                            <MudExpansionPanel>
                                <TitleContent>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                        <MudIcon Icon="@Icons.Material.Filled.Person"/>
                                        <div>
                                            <MudText Typo="Typo.body1"><b>@userName</b></MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                UUID: @userUuid</MudText>
                                        </div>
                                        <MudSpacer/>
                                        <MudChip T="string" Size="Size.Small"
                                                 Color="Color.Primary">@userGroup.Value.Count actions
                                        </MudChip>
                                    </MudStack>
                                </TitleContent>
                                <ChildContent>
                                    <MudTable Items="@userGroup.Value" Dense="true" Hover="true">
                                        <HeaderContent>
                                            <MudTh>Time</MudTh>
                                            <MudTh>Action</MudTh>
                                            <MudTh>Page</MudTh>
                                            <MudTh>Details</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.CreatedAt.ToLocalTime().ToString("g")</MudTd>
                                            <MudTd>
                                                <MudChip T="string" Size="Size.Small">@context.Action</MudChip>
                                            </MudTd>
                                            <MudTd>@context.PageUrl</MudTd>
                                            <MudTd>
                                                @if (!string.IsNullOrWhiteSpace(context.Details))
                                                {
                                                    <MudText Typo="Typo.caption">@context.Details</MudText>
                                                }
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </ChildContent>
                            </MudExpansionPanel>
                        </MudExpansionPanels>
                    }
                }
            }
        </MudTabPanel>
        <MudTabPanel Text="Delete Items" Icon="@Icons.Material.Filled.Delete">
            <MudPaper Class="pa-4 mt-4" Elevation="2">
                <MudText Typo="Typo.h6" GutterBottom="true">Delete Mapped Brick</MudText>
                <MudText Typo="Typo.body2" Color="Color.Warning" Class="mb-4">
                    <strong>Warning:</strong> Deleting a brick will permanently remove it from the database along with
                    all its mapping requests.
                </MudText>

                <BrickPicker Label="Search for brick to delete"
                             Placeholder="Enter part number or name..."
                             AddButtonText="Delete This Brick"
                             ShowQuickColorPicker="false"
                             ShowBrandSelector="false"
                             OnBrickAdded="HandleDeleteBrick"/>

                @if (!string.IsNullOrWhiteSpace(_deleteMessage))
                {
                    <MudAlert Severity="_deleteSuccess ? Severity.Success : Severity.Error" Class="mt-4">
                        @_deleteMessage
                    </MudAlert>
                }
            </MudPaper>
        </MudTabPanel>

    </MudTabs>
}