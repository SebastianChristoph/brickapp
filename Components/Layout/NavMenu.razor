@using brickisbrickapp.Services
@inject UserService UserService

<MudNavMenu>
    <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">
        Home
    </MudNavLink>
    @if (_isAuthenticated)
    {
        <MudNavLink Href="allbricks" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Add">
            All Mapped Bricks
        </MudNavLink>
        <MudNavLink Href="allsets" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.List">
            All Sets
        </MudNavLink>
        <MudNavLink Href="myinventory" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.List">
            My Inventory
        </MudNavLink>
        <MudNavLink Href="myrequests" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.QuestionAnswer">
            My Requests
        </MudNavLink>
        @if (_isAdmin)
        {
                <MudNavLink Href="admin-requests" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AdminPanelSettings">
                    Admin Requests
                </MudNavLink>
                <MudNavLink Href="admin-panel" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Settings">
                    Admin Panel
                </MudNavLink>
        }
    }
    else
    {
        <MudNavLink Href="login" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Login">
            Login
        </MudNavLink>
    }
</MudNavMenu>

@code {
    private bool _isAuthenticated;
    private bool _isAdmin;
    private bool _hasRendered;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_hasRendered)
        {
            _isAuthenticated = await UserService.IsAuthenticatedAsync();
            var user = await UserService.GetCurrentUserAsync();
            _isAdmin = user?.IsAdmin ?? false;
            _hasRendered = true;
            StateHasChanged();
        }
    }

    public async Task RefreshMenuAsync()
    {
        _isAuthenticated = await UserService.IsAuthenticatedAsync();
        var user = await UserService.GetCurrentUserAsync();
        _isAdmin = user?.IsAdmin ?? false;
        StateHasChanged();
    }
}
