
@using brickapp.Data.Entities
@using brickapp.Data.Services
@inject ImageService ImageService
@inject MappedBrickService BrickService
@inject TrackingService TrackingService
@inject NotificationService NotificationService
<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6">
            Mapping for @Brick?.Name
            @if (!string.IsNullOrWhiteSpace(Brick?.LegoPartNum))
            {
                <span> (@Brick.LegoPartNum)</span>
            }
        </MudText>
       
       
        <div style="margin-bottom:12px; min-height:68px;">
            @{
                var imgUrl = Brick != null ? ImageService.GetMappedBrickImagePath(Brick) : "/placeholder-image.png";
            }
            <img src="@imgUrl" alt="" style="max-width:64px;max-height:64px;border-radius:4px;border:1px solid #ccc;@(imgUrl == "/placeholder-image.png" ? ";opacity:0.5" : "")" />
        </div>
        <MudTextField Value="@Brand" Label="Brand" Disabled="true" />

       

        <MudTextField @bind-Value="MappingName" Label="Item name for this brand" Disabled="@(Brand == "Lego" || PartNumberOnlyMode)" />

          @if(Brand != null && Brand.ToLower() =="bluebrixx" && !string.IsNullOrWhiteSpace(Brick?.LegoPartNum))
        {
            <MudAlert Severity="Severity.Info" Class="mb-2">Tip: Search for the LEGO part number <b>@Brick.LegoPartNum</b> on bluebrixx.com to identify the matching Bluebrixx item name. <MudLink Href="https://www.bluebrixx.com" Target="_blank">Go to BlueBrixx.com</MudLink></MudAlert>
            
        }

        <MudTextField Value="@MappingItemId" ValueChanged="@((string v) => OnMappingItemIdChanged(v))"
            ValueExpression="@(() => MappingItemId)" Label="Item Part Number" Immediate="true" />

        @if (_searchingLegoPreview)
{
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mt-2">
        <MudProgressCircular Indeterminate="true" Size="Size.Small" />
        <MudText Typo="Typo.body2">Grabbing all items</MudText>
    </MudStack>
}


        @if (Brand == "Lego" && !string.IsNullOrWhiteSpace(MappingItemId) && MappingItemId.Length >= 3 && _legoPreviewBricks.Any())
        {
            <div style="margin-top:8px;">
                <MudText Typo="Typo.subtitle2">Live-Vorschau existierender LEGO Bricks:</MudText>
                <MudList T="string">
                    @foreach (var b in _legoPreviewBricks)
                    {
                        <MudListItem T="string" Style="cursor:pointer;" OnClick="@(() => SelectPreviewBrick(b))">
                            <div style="display:flex;align-items:center;gap:8px;">
                                <img src="@ImageService.GetMappedBrickImagePath(b)" alt="" style="width:32px;height:32px;border-radius:4px;border:1px solid #ccc;" />
                                <span>@b.LegoPartNum - @b.LegoName</span>
                            </div>
                        </MudListItem>
                    }
                </MudList>
                
            </div>
        }
        @if (!string.IsNullOrWhiteSpace(_errorMessage))
        {
            <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
        }
    </DialogContent>
    <DialogActions>
            <MudButton OnClick="Cancel" Color="Color.Secondary">Cancel</MudButton>
        <MudButton StartIcon="@Icons.Material.Filled.Save" Variant="Variant.Filled" OnClick="OnSave" Color="Color.Primary">Save</MudButton>
    
    </DialogActions>
</MudDialog>