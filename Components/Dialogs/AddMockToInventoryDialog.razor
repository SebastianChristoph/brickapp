@using brickapp.Data.Services
@using Microsoft.EntityFrameworkCore
@inject brickapp.Data.Services.InventoryService InventoryService
@inject brickapp.Data.AppDbContext Db
@inject IDialogService DialogService
@inject brickapp.Data.Services.LoadingService LoadingService

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6">Add all MOC items to inventory? @_mockType</MudText>
        @if (_mockType == null)
        {
            <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="mb-2" />
        }
        else
        {
            <MudText Typo="Typo.body2" Class="mb-2">
                @(_mockType == "bricklink" || _mockType == "rebrickable" || _mockType == "BricklinkXml"
                    ? "All parts of this MOC will be added as LEGO items to your inventory."
                    : "All parts of this MOC will be added to your inventory.")
            </MudText>
        }
        @if (_error != null)
        {
            <MudText Color="Color.Error">@_error</MudText>
        }
    </DialogContent>
    <DialogActions>
    
        <MudButton Color="Color.Secondary" Disabled="_loading" OnClick="() => MudDialog?.Cancel()">Cancel</MudButton>
        <MudButton Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Disabled="_loading" OnClick="AddAllAsync">Add</MudButton>
    </DialogActions>
</MudDialog>



@code {
    [Parameter] public int MockId { get; set; }
    [Parameter] public string? MockSource { get; set; }
    [CascadingParameter] private IMudDialogInstance? MudDialog { get; set; }
    
    private bool _loading = false;
    private string? _error;
    private string? _mockType;


private static string? NormalizeSource(string? source)
{
    if (string.IsNullOrWhiteSpace(source))
        return null;

    return source.Trim().ToLower() switch
    {
        "bricklink" => "bricklink",
        "bricklinkxml" => "bricklink",
        "bricklink csv" => "bricklink",
        "bricklink-csv" => "bricklink",
        "rebrickable" => "rebrickable",
        "rebrickable csv" => "rebrickable",
        "rebrickablecsv" => "rebrickable",
        _ => source.Trim().ToLower()
    };
}

    protected override async Task OnInitializedAsync()
    {
        var mock = await Db.Mocks.AsNoTracking().FirstOrDefaultAsync(m => m.Id == MockId);
        _mockType = NormalizeSource(MockSource);
    }

   private async Task AddAllAsync()
{
    _loading = true;
    _error = null;
    StateHasChanged(); // UI updaten f√ºr den Button-Disabled-Status

    // Globalen Spinner zeigen
    LoadingService.Show(message: "Adding MOC items to inventory...");
    
    try
    {
        // Kleiner Delay, damit der Spinner im UI erscheint
        await Task.Delay(100); 

        if (string.IsNullOrWhiteSpace(_mockType))
        {
            LoadingService.Hide();
            _error = "Mock type is not set.";
            _loading = false;
            return;
        }

        var result = await InventoryService.AddMockItemsToInventoryAsync(MockId, _mockType);
        
        if (result)
        {
            // Erst Spinner weg, dann Dialog zu
            LoadingService.Hide();
            MudDialog?.Close(DialogResult.Ok(true));
        }
        else
        {
            LoadingService.Hide();
            _error = "Error adding mock items to inventory.";
            _loading = false;
        }
    }
    catch (Exception ex)
    {
        LoadingService.Hide();
        _error = "Exception: " + ex.Message;
        _loading = false;
    }
}
}