
@using Microsoft.AspNetCore.Components.Forms
@using Data.Entities
@using Data.Services
@inject Data.Services.RequestService RequestService
@inject Data.Services.ImageService ImageService
@inject Services.MappedBrickService BrickService
@inject Services.UserService UserService
@inject Services.NotificationService NotificationService
@inject ILogger<AddItemDialog> Logger


<MudDialog>
    <DialogContent>
        <MudSelect T="string" Label="Brand" @bind-Value="Brand" Required="true">
            <MudSelectItem Value="@("Lego")">Lego</MudSelectItem>
            <MudSelectItem Value="@("BB")">BB</MudSelectItem>
            <MudSelectItem Value="@("Cada")">Cada</MudSelectItem>
            <MudSelectItem Value="@("Pantasy")">Pantasy</MudSelectItem>
            <MudSelectItem Value="@("Mould King")">Mould King</MudSelectItem>
            <MudSelectItem Value="@("Unknown")">Unknown</MudSelectItem>
        </MudSelect>
        <MudTextField @bind-Value="Name" Label="Item Name" Required="true" />
        <MudTextField @bind-Value="PartNum" Label="Part Number" Required="@(Brand == "Lego")" />
        @if (Brand == "Lego" && string.IsNullOrWhiteSpace(PartNum))
        {
            <MudAlert Severity="Severity.Warning">For LEGO, the part number is required!</MudAlert>
        }
        <InputFile OnChange="OnInputFileChange" />
        @if (!string.IsNullOrWhiteSpace(_errorMessage))
        {
            <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
        }
        @if (!string.IsNullOrWhiteSpace(_imagePreviewUrl))
        {
            <img src="@_imagePreviewUrl" style="max-width:200px;max-height:200px;margin-top:8px;" />
        }
    </DialogContent>
    <DialogActions>
       
        <MudButton OnClick="Cancel" Color="Color.Secondary">Cancel</MudButton>
         <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Save" OnClick="OnSave" Color="Color.Primary">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private MudBlazor.IMudDialogInstance? MudDialog { get; set; }
    private string Brand { get; set; } = string.Empty;
    private string Name { get; set; } = string.Empty;
    private string PartNum { get; set; } = string.Empty;
    private IBrowserFile? _file;
    private string? _imagePreviewUrl;
    private string _errorMessage = string.Empty;

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        _file = e.File;
        if (_file != null)
        {
            var buffer = new byte[_file.Size];
            await _file.OpenReadStream().ReadAsync(buffer);
            _imagePreviewUrl = $"data:{_file.ContentType};base64,{Convert.ToBase64String(buffer)}";
            Logger.LogInformation("游리 [AddItemDialog] File selected: Name={Name}, Size={Size}, ContentType={ContentType}", _file.Name, _file.Size, _file.ContentType);
        }
    }

    private async Task OnSave()
    {
        _errorMessage = string.Empty;
        Logger.LogInformation("游리 [AddItemDialog] OnSave called: Brand={Brand}, Name={Name}, PartNum={PartNum}", Brand, Name, PartNum);
        if (string.IsNullOrWhiteSpace(Brand) || string.IsNullOrWhiteSpace(Name))
        {
            _errorMessage = "Brand and Name are required.";
            Logger.LogWarning("游리 [AddItemDialog] Validation failed: Brand or Name missing.");
            return;
        }
        if (Brand == "Lego" && string.IsNullOrWhiteSpace(PartNum))
        {
            _errorMessage = "For LEGO, the part number is required.";
            Logger.LogWarning("游리 [AddItemDialog] LEGO PartNum required but missing.");
            return;
        }
        // Check for duplicate item
        var allBricks = await BrickService.GetAllMappedBricksAsync();
        bool exists = allBricks.Any(b =>
            (Brand == "Lego" && b.LegoName == Name)
            || (Brand == "BB" && b.BbName == Name)
            || (Brand == "Cada" && b.CadaName == Name)
            || (Brand == "Pantasy" && b.PantasyName == Name)
            || (Brand == "Mould King" && b.MouldKingName == Name)
            || (Brand == "Unknown" && b.UnknownName == Name)
        );
        if (exists)
        {
            _errorMessage = $"An item with the name '{Name}' already exists for brand '{Brand}'.";
            Logger.LogWarning("游리 [AddItemDialog] Duplicate item: Brand={Brand}, Name={Name}", Brand, Name);
            return;
        }

        var userId = await UserService.GetTokenAsync();
        if (userId is null)
        {
            _errorMessage = "User not authenticated.";
            Logger.LogWarning("游리 [AddItemDialog] User not authenticated.");
            return;
        }
        Logger.LogInformation("游리 [AddItemDialog] Creating new item request: Brand={Brand}, Name={Name}, PartNum={PartNum}, UserId={UserId}", Brand, Name, PartNum, userId);
        await RequestService.CreateNewItemRequestAsync(Brand, Name, userId, PartNum, _file);
        Logger.LogInformation("游리 [AddItemDialog] Item request created successfully for Brand={Brand}, Name={Name}, PartNum={PartNum}", Brand, Name, PartNum);
        NotificationService.Success($"Item '{Name}/{PartNum}' added successfully as a request! An admin has to approve it. You will be notified in your notification area once it's approved.");
        MudDialog?.Close(DialogResult.Ok(true));
    }

    private void Cancel() => MudDialog?.Cancel();
}
