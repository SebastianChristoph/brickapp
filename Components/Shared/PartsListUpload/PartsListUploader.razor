@using brickapp.Data.Services.PartsListUpload
@inject IPartsListUploadService UploadService

<MudText Typo="Typo.h6" GutterBottom="true" >@Title</MudText>

@if (!string.IsNullOrWhiteSpace(HelpText))
{
    <MudText Typo="Typo.caption" Class="mb-2" Style="color:#666;">@HelpText</MudText>
}

@if (Formats.Count > 1)
{
    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mb-2">
        Multiple upload formats are supported. Please select the format of your file below.
    </MudAlert>
    <MudSelect T="PartsUploadFormat"
               @bind-Value="_selectedFormat"
               Label="Upload format"
               Dense="true"
               Disabled="@(Disabled || _uploading)"
               Class="my-4">
        @foreach (var f in Formats)
        {
            <MudSelectItem  Value="@f">@FormatLabel(f)</MudSelectItem>
        }
    </MudSelect>
}
else
{
    <MudText Typo="Typo.caption" Class="mb-2">
        Format: <b>@FormatLabel(_selectedFormat)</b>
    </MudText>
}


    <div class="d-flex align-center" style="gap:12px; flex-wrap:wrap;">
        <InputFile OnChange="OnFileSelected" accept="@EffectiveAccept" disabled="@(Disabled || _uploading)" />

      

       

        @if (_uploading)
        {
            <MudProgressCircular Indeterminate="true" Size="Size.Small" />
            <MudText Typo="Typo.caption">Parsing…</MudText>
        }
    </div>

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <MudAlert Severity="Severity.Error" Class="mt-3">
            @_error
        </MudAlert>
    }

    @if (_result is not null)
    {
        @* 1) Erfolg *@
        @if ((_result.MappedItems?.Count ?? 0) > 0)
        {
            <MudAlert Variant="Variant.Filled" Severity="Severity.Success" Class="mt-3">
                <b>@(_result.MappedItems?.Count ?? 0) Item(s)</b> successfully recognized by our database and ready to be added.
            </MudAlert>
        }

        @* 2) Unmapped *@
        @if ((_result.Unmapped?.Count ?? 0) > 0)
        {
           <MudAlert Variant="Variant.Filled" Severity="Severity.Warning" Class="mt-3">
                <b>@(_result.Unmapped?.Count ?? 0) item(s)</b> could not be matched automatically because they are missing in our database. <br />
                They will be saved as "missing mappings" in your item list, so you can review them later in the details.
            </MudAlert>

            <MudExpansionPanels Class="mt-2">
                <MudExpansionPanel Text="Show Unmapped Items" Expanded="false" MaxHeight="450">
                    <MudPaper Class="pa-2 mb-2">
                        <MudList T="string">
                            @foreach (var u in _result.Unmapped!)
                            {
                                <MudChip T="string"
                                         Color="Color.Default"
                                         Variant="Variant.Outlined"
                                         Size="Size.Small"
                                         Class="ma-1">
                                    Part: @u.PartNum, Color: @u.ColorId, Menge: @u.Quantity
                                </MudChip>
                            }
                        </MudList>
                    </MudPaper>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }

        @* 3) Invalid colors *@
        @if ((_result.InvalidColorIds?.Count ?? 0) > 0)
        {
            <MudAlert Severity="Severity.Warning" Class="mt-3">
                <b>@_result.InvalidColorIds!.Count</b> Farbe(n) aus der Datei konnten nicht auf deine BrickColors gemappt werden.
            </MudAlert>

            <MudExpansionPanels Class="mt-2">
                <MudExpansionPanel Text="Ungültige/Unbekannte Farben anzeigen" Expanded="false" MaxHeight="450">
                    <MudPaper Class="pa-2 mb-2" Style="background:#fffbe6;border:1px solid #ffe082;">
                        <MudList T="string">
                            @foreach (var c in _result.InvalidColorIds!.OrderBy(x => x))
                            {
                                <MudChip T="string"
                                         Color="Color.Warning"
                                         Variant="Variant.Outlined"
                                         Size="Size.Small"
                                         Class="ma-1">
                                    ColorId: @c
                                </MudChip>
                            }
                        </MudList>
                    </MudPaper>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }

        @* 4) Invalid rows *@
        @if ((_result.InvalidRows?.Count ?? 0) > 0)
        {
            <MudAlert Severity="Severity.Warning" Class="mt-3">
                <b>@_result.InvalidRows!.Count</b> Zeile(n) waren ungültig und wurden übersprungen.
            </MudAlert>

            <MudExpansionPanels Class="mt-2">
                <MudExpansionPanel Text="Ungültige Zeilen anzeigen" Expanded="false" MaxHeight="450">
                    <MudPaper Class="pa-2 mb-2" Style="background:#fffbe6;border:1px solid #ffe082;">
                        <MudTable Items="@_result.InvalidRows!.Take(MaxInvalidRowsShown)"
                                  Dense="true"
                                  Hover="true"
                                  Bordered="true">
                            <HeaderContent>
                                <MudTh>Part</MudTh>
                                <MudTh>Color</MudTh>
                                <MudTh>Qty</MudTh>
                                <MudTh>Error</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Part">@context.PartNum</MudTd>
                                <MudTd DataLabel="Color">@context.ColorId</MudTd>
                                <MudTd DataLabel="Qty">@context.Quantity</MudTd>
                                <MudTd DataLabel="Error">@context.Error</MudTd>
                            </RowTemplate>
                        </MudTable>

                        @if (_result.InvalidRows!.Count > MaxInvalidRowsShown)
                        {
                            <MudText Typo="Typo.caption" Class="mt-2">
                                Es werden nur die ersten @MaxInvalidRowsShown Einträge angezeigt.
                            </MudText>
                        }
                    </MudPaper>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }

         @if (ShowAddButton)
        {
            <MudButton Variant="Variant.Filled"
                       StartIcon="@Icons.Material.Filled.Add"
                       Color="Color.Primary"
                       Disabled="@(_uploading || Disabled || _result is null || (_result.MappedItems?.Count ?? 0) == 0)"
                       OnClick="Add"
                       Class="mt-3">
                @AddButtonText
            </MudButton>
        }

          <MudButton Variant="Variant.Outlined"
                     StartIcon="@Icons.Material.Filled.Clear"
                   Disabled="@(_uploading || Disabled || (_result is null && string.IsNullOrWhiteSpace(_error)))"
                   Class="mt-3 ml-4"
                   OnClick="Clear">
            @ClearButtonText
        </MudButton>
    }