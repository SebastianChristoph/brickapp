@using brickapp.Data.Entities
@using brickapp.Data.Services
@using brickapp.Data.DTOs
@using brickapp.Helpers
@inject MappedBrickService MappedBrickService
@inject ImageService ImageService
@inject ILogger<BrickPicker> Logger

<style>
    .brick {
        position: relative;
        display: inline-block;
        width: 56px;
        height: 56px;
        min-width: 56px;
        min-height: 56px;
        box-sizing: border-box;
    }

    .brick-img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 4px;
        border: 2px solid #ccc;
        background: #fff;
        display: block;
    }

    .brick::after {
        content: "";
        position: absolute;
        right: .5px;
        bottom: 0px;
        width: 0;
        height: 0;
        border-bottom: 28px solid var(--brick-color, transparent);
        border-left: 28px solid transparent;
        border-radius: 0 0 4px 0;
        z-index: 2;
        pointer-events: none;
    }

    .color-chip-select {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid #ccc;
        transition: all 0.2s;
        display: inline-block;
    }

    .color-chip-select:hover {
        transform: scale(1.15);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .color-chip-active {
        border-color: #1976d2;
        border-width: 4px;
        transform: scale(1.2);
    }
</style>

<div>
    @if (_searchingBricks)
    {
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
            <MudProgressCircular Indeterminate="true" Size="Size.Small" />
            <MudText Typo="Typo.body2">Searching in database...</MudText>
        </MudStack>
    }
    @* Brick Search Field *@
    <MudAutocomplete T="MappedBrick"
                     Value="@SelectedBrick"
                     ValueChanged="@OnBrickSelected"
                     SearchFunc="SearchBricksWrapper"
                     Label="@Label"
                     Placeholder="@Placeholder"
                     ToStringFunc="@(b => GetBrickDisplayName(b))"
                     DebounceInterval="300"
                     ResetValueOnEmptyText="true"
                     CoerceText="false"
                     ShowProgressIndicator="true"
                     ProgressIndicatorColor="Color.Primary"
                     Open="@(_searchResults.Any() && SelectedBrick == null)"
                     OpenChanged="@OnOpenChanged">
        <ItemTemplate Context="brick">
            <div style="display:flex; align-items:center; gap:8px;">
                <div class="brick" style="--brick-color: transparent;">
                    <img src="@GetBrickImageUrl(brick)" alt="brick" class="brick-img" />
                </div>
                <div>
                    <div><strong>@GetBrickPartNumber(brick)</strong></div>
                    <div style="font-size:0.85em; color:#666;">@GetBrickName(brick)</div>
                </div>
            </div>
        </ItemTemplate>
    </MudAutocomplete>

    @* Brand Selector (optional) *@
    @if (ShowBrandSelector)
    {
        <MudSelect T="string" Value="@SelectedBrand" ValueChanged="OnBrandChanged" Label="Brand" Placeholder="Select a brand" Class="mt-4">
            @foreach (var brand in _availableBrands)
            {
                <MudSelectItem Value="@brand">@brand</MudSelectItem>
            }
        </MudSelect>
    }

    @* Selected Brick with Color and Quantity *@
    @if (SelectedBrick != null)
    {
        <MudPaper Class="pa-4 mt-4" Elevation="2">
            <MudText Typo="Typo.h6" GutterBottom="true">Selected Item</MudText>
            
            <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
                <div class="brick" style="--brick-color: @GetSelectedColorHex();">
                    <img src="@GetBrickImageUrl(SelectedBrick)" alt="brick" class="brick-img" />
                </div>
                <div>
                    <div><strong>@GetBrickPartNumberForBrand(SelectedBrick, SelectedBrand)</strong></div>
                    <div style="font-size:0.9em; color:#666;">@GetBrickNameForBrand(SelectedBrick, SelectedBrand)</div>
                    @if (ShowBrandSelector)
                    {
                        <div style="font-size:0.8em; color:#999; margin-top:4px;">Brand: @SelectedBrand</div>
                    }
                </div>
            </div>

            @* Quick Color Chips *@
            @if (ShowQuickColorPicker && _quickColors.Any())
            {
                <MudText Typo="Typo.caption" Class="mb-2">Quick Color Select:</MudText>
                <div style="display:flex; flex-wrap:wrap; gap:12px; margin-bottom:16px;">
                    @foreach (var color in _quickColors)
                    {
                        var hexColor = GetColorHex(color);
                        var isSelected = SelectedColorId == color.Id;
                        <div style="display:flex; flex-direction:column; align-items:center; gap:4px; cursor:pointer;"
                             @onclick="() => SelectQuickColor(color.Id)">
                            <div class="color-chip-select @(isSelected ? "color-chip-active" : "")"
                                 style="background-color: #@hexColor;"
                                 title="@color.Name">
                            </div>
                            <span style="font-size:0.75rem; text-align:center; max-width:60px; @(isSelected ? "font-weight:600;" : "")">@color.Name</span>
                        </div>
                    }
                </div>
            }

            @* Full Color Dropdown *@
            <MudSelect T="int?" @bind-Value="SelectedColorId" Label="Color" Placeholder="Select a color" Required="true">
                @foreach (var color in _availableColors)
                {
                    var hexColor = GetColorHex(color);
                    <MudSelectItem Value="@((int?)color.Id)">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div style="width:24px; height:24px; background:#@hexColor; border-radius:50%; border:2px solid #ccc;"></div>
                            <span>@color.Name</span>
                        </div>
                    </MudSelectItem>
                }
            </MudSelect>

            @* Quantity *@
            <MudNumericField @bind-Value="Quantity" Label="Quantity" Variant="Variant.Text" Min="1" Class="mt-2" />

            @* Add Button *@
            <MudButton StartIcon="@Icons.Material.Filled.Add"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="HandleAdd"
                       Disabled="@(SelectedBrick == null || SelectedColorId == null || Quantity < 1)"
                       Class="mt-4">
                @AddButtonText
            </MudButton>
        </MudPaper>
    }
</div>